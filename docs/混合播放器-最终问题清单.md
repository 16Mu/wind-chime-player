# 混合播放器 - 最终问题清单

> 当前状态: 接近完成，还有 2-3 个小问题  
> 日期: 2025-10-06

---

## ✅ 已解决的问题

| 问题 | 状态 |
|------|------|
| Rust 完整预解码导致 5 秒等待 | ✅ |
| 快速切歌多任务冲突 | ✅ |
| Web Audio 自动播放下一首冲突 | ✅ |
| 三个音轨同时播放 | ✅ |
| tracks is not defined 错误 | ✅ |
| 沉浸式歌词所有控制按钮 | ✅ |
| ImmersiveLyricsView 所有按钮 | ✅ |
| LyricsDisplay 歌词点击 | ✅ |
| 下一曲后引擎重置 | ✅ |
| 引擎切换后状态同步 | ✅ |

---

## ⚠️ 待解决的问题

### 问题 1: 暂停后播放从头开始

**症状**：
- 暂停歌曲
- 点击播放
- 从 0:00 开始播放

**原因**：
- 播放按钮调用 `handlePlay()`
- `handlePlay()` 重新播放歌曲（而不是继续）

**解决方案**：
```typescript
// PlaylistPlayer.tsx
const handlePlayPauseToggle = async () => {
  if (playerState.is_playing) {
    // 当前在播放 → 暂停
    await hybridPlayer.pause();
  } else if (currentTrack) {
    // 有歌曲但暂停 → 继续播放
    await hybridPlayer.resume();
  }
  // 没有歌曲时不做任何操作
};
```

---

### 问题 2: 下一曲后 currentTrack 未更新

**症状**：
- 沉浸式歌词点击下一曲
- 回到普通界面
- 点击播放 → 播放上一首歌

**原因**：
- `currentTrack` state 没有监听 Rust 的 `player-track-changed` 事件

**解决方案**：
```typescript
// PlaylistPlayer.tsx
useEffect(() => {
  const unlisten = listen('player-track-changed', (event) => {
    const newTrack = event.payload;
    setCurrentTrack(newTrack);  // 更新 currentTrack
  });
  
  return () => unlisten.then(fn => fn());
}, []);
```

---

### 问题 3: 普通界面进度条不实时更新

**症状**：
- 播放时进度条卡顿
- 只有歌词更新时才跳一下

**原因**：
- 普通界面的进度条可能直接读取 `playerState.position_ms`
- 而不是调用 `getPosition()`

**解决方案**：
确保进度条组件使用 `usePlaybackPosition()` hook：
```typescript
// ProgressBar 或类似组件
const getPosition = usePlaybackPosition();
const position = getPosition();  // 实时获取
```

---

## 🎯 核心架构现状

### 工作正常 ✅
- Rust 流式播放（100ms 启动）
- Web Audio 后台加载（800ms 完成）
- 引擎自动切换
- 沉浸式歌词位置更新
- 下一曲/上一曲（沉浸式）
- Seek 0 延迟（切换后）

### 需要修复 ⚠️
- 暂停/继续逻辑（普通界面）
- currentTrack 同步
- 普通界面进度条实时更新

---

## 📋 建议的修复顺序

### 修复 1: 统一播放/暂停按钮逻辑
合并 `handlePlay` 和 `handlePause/Resume`

### 修复 2: 同步 currentTrack  
监听 `player-track-changed` 更新 state

### 修复 3: 进度条实时更新
确保使用 `getPosition()` 而不是 `playerState.position_ms`

---

## 💡 简化建议

考虑到复杂度，建议：
1. **暂时禁用普通界面的播放按钮**（只保留暂停/继续）
2. **只通过点击歌曲列表播放**（这个逻辑是正确的）
3. **等混合播放器稳定后再启用**

---

**当前进度：90% 完成** 🎉

核心功能已全部实现，只剩边缘情况需要处理！





