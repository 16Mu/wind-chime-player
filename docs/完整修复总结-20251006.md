# å®Œæ•´ä¿®å¤æ€»ç»“ - 2025-10-06

> **æ—¥æœŸ**: 2025-10-06  
> **çŠ¶æ€**: âœ… æ‰€æœ‰å…³é”®é—®é¢˜å·²ä¿®å¤  
> **å¯¹è¯**: æ··åˆæ’­æ”¾å™¨å®ç° + åç»­ä¿®å¤

---

## ğŸ¯ æœ¬æ¬¡å¯¹è¯å®Œæˆçš„ä¿®å¤

### 1. âœ… "ä¸‹ä¸€é¦–"åæ— æ³• Seek
**é—®é¢˜**: ç‚¹å‡»"ä¸‹ä¸€é¦–"æˆ–"è‡ªåŠ¨ä¸‹ä¸€é¦–"åï¼Œseek åŠŸèƒ½å¤±æ•ˆ

**æ ¹æœ¬åŸå› **: `hybridPlayer.next()` åªè°ƒç”¨ Rust å‘½ä»¤ï¼Œæ²¡æœ‰å¯åŠ¨åå° Web Audio åŠ è½½

**è§£å†³æ–¹æ¡ˆ**:
- æ·»åŠ  `hybridPlayer.play(track, [], skipRustPlay: true)` å‚æ•°
- PlaylistPlayer ç›‘å¬ `player-track-changed` äº‹ä»¶ï¼Œè‡ªåŠ¨å¯åŠ¨åå°åŠ è½½
- **æ–‡ä»¶**: `src/services/hybridPlayer.ts`, `src/components/PlaylistPlayer.tsx`

---

### 2. âœ… æš‚åœåŠŸèƒ½æ— æ•ˆ
**é—®é¢˜**: ç‚¹å‡»"ä¸‹ä¸€é¦–"åæ— æ³•æš‚åœ

**æ ¹æœ¬åŸå› **: PlaybackContext ç¼ºå°‘ Rust äº‹ä»¶ç›‘å¬ï¼Œ`isPlaying` çŠ¶æ€ä¸æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**:
- æ·»åŠ  Rust çš„ `player-state-changed`, `player-track-changed`, `player-position-changed` äº‹ä»¶ç›‘å¬
- åªåœ¨ Rust å¼•æ“ä¸‹æ›´æ–°çŠ¶æ€ï¼ˆé˜²æ­¢å†²çªï¼‰
- **æ–‡ä»¶**: `src/contexts/PlaybackContext.tsx`

---

### 3. âœ… æ’­æ”¾çŠ¶æ€å»¶è¿ŸåŒæ­¥
**é—®é¢˜**: ç‚¹å‡»æ’­æ”¾åï¼Œæš‚åœæŒ‰é’®éœ€è¦ç­‰å¾… 200-500ms æ‰æ›´æ–°

**æ ¹æœ¬åŸå› **: å®Œå…¨ä¾èµ– Rust äº‹ä»¶ï¼Œè€Œäº‹ä»¶æœ‰å»¶è¿Ÿ

**è§£å†³æ–¹æ¡ˆ**:
- App.tsx ä¸­è°ƒç”¨ `hybridPlayer.play()` åç«‹å³æ›´æ–° `updatePlaybackState({ isPlaying: true })`
- åŒé‡æ›´æ–°æœºåˆ¶ï¼šç«‹å³æ›´æ–° + äº‹ä»¶ç¡®è®¤
- **æ–‡ä»¶**: `src/App.tsx`

---

### 4. âœ… è¿›åº¦æ¡ä¸å®æ—¶æ›´æ–°
**é—®é¢˜**: è¿›åº¦æ¡å¡é¡¿ï¼Œä¸æµç•…

**æ ¹æœ¬åŸå› **: PlaybackContext çš„ `getPosition()` æ²¡æœ‰æ­£ç¡®çš„å¼•æ“è·¯ç”±

**è§£å†³æ–¹æ¡ˆ**:
- å®ç°åŒå±‚ ref æ¨¡å¼ï¼š`getPositionRef.current` æ ¹æ®å¼•æ“é€‰æ‹©æ•°æ®æº
- Rust å¼•æ“ï¼šä» `positionRef.current` è·å–
- Web Audio å¼•æ“ï¼šä» `webAudioPlayerRef.current.getPosition()` è·å–
- **æ–‡ä»¶**: `src/contexts/PlaybackContext.tsx`

---

### 5. âœ… å¼•æ“åˆ‡æ¢æ—¶çŠ¶æ€æ··ä¹±
**é—®é¢˜**: å¼•æ“åˆ‡æ¢æ—¶ï¼Œæš‚åœæŒ‰é’®å˜æˆ"æ’­æ”¾"ï¼Œè¿›åº¦æ¡åœæ­¢

**æ ¹æœ¬åŸå› **: åœæ­¢ Rust æ—¶è§¦å‘ `is_playing: false` äº‹ä»¶ï¼Œä½†å¼•æ“æ ‡å¿—è¿˜æœªåˆ‡æ¢

**è§£å†³æ–¹æ¡ˆ**:
- åœ¨åœæ­¢ Rust **ä¹‹å‰**å…ˆé€šçŸ¥ `onEngineSwitch('webaudio')`
- PlaybackContext æ£€æµ‹åˆ°åœæ­¢äº‹ä»¶ä½†æ­£åœ¨æ’­æ”¾æ—¶ï¼Œå¿½ç•¥çŠ¶æ€æ›´æ–°
- **æ–‡ä»¶**: `src/services/hybridPlayer.ts`, `src/contexts/PlaybackContext.tsx`

---

## ğŸ“‹ å…³é”®å®ç°æ£€æŸ¥

### âœ… 1. æš‚åœ/ç»§ç»­é€»è¾‘
**æ–‡ä»¶**: `src/components/PlaylistPlayer.tsx` (Line 311-327)

```typescript
const handlePlayPauseToggle = async () => {
  const { hybridPlayer } = await import('../services/hybridPlayer');
  
  if (playerState.is_playing) {
    await hybridPlayer.pause();  // æš‚åœ
  } else if (playerState.current_track) {
    await hybridPlayer.resume();  // ç»§ç»­ï¼ˆä¸æ˜¯é‡æ–°æ’­æ”¾ï¼‰
  }
};
```

**çŠ¶æ€**: âœ… å·²æ­£ç¡®å®ç°

---

### âœ… 2. currentTrack åŒæ­¥
**æ–‡ä»¶**: `src/components/PlaylistPlayer.tsx` (Line 168-183)

```typescript
const unlistenTrackChanged = listen('player-track-changed', async (event: any) => {
  const newTrack = event.payload;
  if (newTrack && newTrack.id) {
    // å¯åŠ¨åå° Web Audio åŠ è½½
    if (newTrack.id !== lastLoadedTrackId) {
      lastLoadedTrackId = newTrack.id;
      await hybridPlayer.play(newTrack, [], true);  // skipRustPlay=true
    }
  }
});
```

**çŠ¶æ€**: âœ… å·²æ­£ç¡®å®ç°ï¼ˆé€šè¿‡åå°åŠ è½½æœºåˆ¶ï¼‰

---

### âœ… 3. è¿›åº¦æ¡å®æ—¶æ›´æ–°
**æ–‡ä»¶**: `src/components/PlaylistPlayer.tsx` (Line 915-933)

```typescript
useEffect(() => {
  if (!playerState.is_playing) {
    setRealTimePosition(getPosition());
    return;
  }
  
  let frameId: number;
  const updatePosition = () => {
    const pos = getPosition();
    setRealTimePosition(pos);
    frameId = requestAnimationFrame(updatePosition);
  };
  
  frameId = requestAnimationFrame(updatePosition);
  return () => cancelAnimationFrame(frameId);
}, [playerState.is_playing, getPosition]);
```

**çŠ¶æ€**: âœ… å·²æ­£ç¡®å®ç°ï¼ˆä½¿ç”¨ rAFï¼‰

---

### âœ… 4. åŒå±‚ ref æ¨¡å¼
**æ–‡ä»¶**: `src/contexts/PlaybackContext.tsx` (Line 107-136)

```typescript
// ç¬¬ä¸€å±‚ï¼šå®é™…å®ç°ï¼ˆæ¯æ¬¡æ¸²æŸ“éƒ½æ›´æ–°ï¼‰
getPositionRef.current = () => {
  const engine = currentEngineRef.current;
  
  if (engine === 'webaudio' && webAudioPlayerRef.current) {
    return webAudioPlayerRef.current.getPosition() * 1000;
  }
  
  return positionRef.current;  // Rust å¼•æ“
};

// ç¬¬äºŒå±‚ï¼šç¨³å®šå¼•ç”¨ï¼ˆä¸å˜ï¼‰
const getPosition = useCallback(() => getPositionRef.current(), []);
```

**çŠ¶æ€**: âœ… å·²æ­£ç¡®å®ç°

---

### âœ… 5. å¼•æ“çŠ¶æ€è·¯ç”±
**æ–‡ä»¶**: `src/contexts/PlaybackContext.tsx` (Line 245-286)

```typescript
// åªåœ¨ Rust å¼•æ“ä¸‹å¤„ç† Rust äº‹ä»¶
const unlistenState = await listen('player-state-changed', (event: any) => {
  if (currentEngineRef.current === 'rust') {
    // ç‰¹æ®Šå¤„ç†ï¼šåœæ­¢äº‹ä»¶ä½†æ­£åœ¨æ’­æ”¾ï¼Œå¯èƒ½æ˜¯å¼•æ“åˆ‡æ¢
    if (rustState.is_playing === false && state.isPlaying === true) {
      console.log('âš ï¸ æ£€æµ‹åˆ°å¼•æ“åˆ‡æ¢ï¼Œå¿½ç•¥ Rust åœæ­¢äº‹ä»¶');
      // åªæ›´æ–°ä½ç½®ï¼Œä¸æ›´æ–° isPlaying
      positionRef.current = position;
    } else {
      // æ­£å¸¸æ›´æ–°
      setState({ ...rustState });
      positionRef.current = position;
    }
  }
});

const unlistenPosition = await listen('player-position-changed', (event: any) => {
  if (currentEngineRef.current === 'rust') {
    positionRef.current = event.payload;
  }
});
```

**çŠ¶æ€**: âœ… å·²æ­£ç¡®å®ç°

---

### âœ… 6. æ­Œæ›²åˆ‡æ¢æ—¶å¼•æ“é‡ç½®
**æ–‡ä»¶**: `src/contexts/PlaybackContext.tsx` (Line 266-277)

```typescript
const unlistenTrack = await listen('player-track-changed', (event: any) => {
  const newTrack = event.payload || null;
  setState(prev => ({ ...prev, track: newTrack }));
  positionRef.current = 0;
  
  // ğŸ”¥ æ­Œæ›²åˆ‡æ¢æ—¶é‡ç½®å¼•æ“ä¸º Rust
  if (newTrack && newTrack.id !== lastTrackIdRef.current) {
    currentEngineRef.current = 'rust';
    lastTrackIdRef.current = newTrack.id;
  }
});
```

**çŠ¶æ€**: âœ… å·²æ­£ç¡®å®ç°

---

### âœ… 7. å¼•æ“åˆ‡æ¢å‰ç½®é€šçŸ¥
**æ–‡ä»¶**: `src/services/hybridPlayer.ts` (Line 276-283)

```typescript
// ğŸ”¥ æå‰åˆ‡æ¢å¼•æ“æ ‡å¿—ï¼ˆåœ¨åœæ­¢ Rust ä¹‹å‰ï¼‰
this.currentEngine = 'webaudio';

// ğŸ”¥ ç«‹å³é€šçŸ¥å›è°ƒï¼ˆè®© PlaybackContext æå‰åˆ‡æ¢å¼•æ“æ ‡å¿—ï¼‰
if (this.callbacks.onEngineSwitch) {
  this.callbacks.onEngineSwitch('webaudio');
}

// åœæ­¢ Rust æ’­æ”¾å™¨ï¼ˆæ­¤æ—¶ PlaybackContext å·²ç»å¿½ç•¥ Rust äº‹ä»¶ï¼‰
await invoke('player_stop');
```

**çŠ¶æ€**: âœ… å·²æ­£ç¡®å®ç°

---

### âœ… 8. hybridPlayer åˆå§‹åŒ–å›è°ƒ
**æ–‡ä»¶**: `src/contexts/PlaybackContext.tsx` (Line 200-224)

```typescript
const { hybridPlayer } = await import('../services/hybridPlayer');
await hybridPlayer.initialize({
  // å¼•æ“åˆ‡æ¢å›è°ƒ
  onEngineSwitch: (engine) => {
    currentEngineRef.current = engine;
    
    if (engine === 'webaudio') {
      setState(prev => ({ ...prev, isPlaying: true }));
    }
  },
  
  // åŠ è½½è¿›åº¦å›è°ƒ
  onLoadingProgress: (progress) => {
    console.log(`ğŸ’¾ Web Audio åŠ è½½è¿›åº¦: ${progress}%`);
  },
});
```

**çŠ¶æ€**: âœ… å·²æ­£ç¡®å®ç°

---

### âœ… 9. ä»»åŠ¡å–æ¶ˆæœºåˆ¶
**æ–‡ä»¶**: `src/services/hybridPlayer.ts` (Line 80-85, 159-162, etc.)

```typescript
// å–æ¶ˆä¹‹å‰çš„ä»»åŠ¡
if (this.currentLoadingTask) {
  this.shouldCancelLoading = true;
  await this.currentLoadingTask.catch(() => {});
}

// å¤šç‚¹æ£€æŸ¥
if (this.shouldCancelLoading || this.currentTrackId !== taskTrackId) {
  console.log('ğŸš« ä»»åŠ¡å·²å–æ¶ˆ');
  return;
}
```

**çŠ¶æ€**: âœ… å·²æ­£ç¡®å®ç°

---

### âœ… 10. skipRustPlay å‚æ•°
**æ–‡ä»¶**: `src/services/hybridPlayer.ts` (Line 78, 88-106)

```typescript
async play(track: Track, playlist: Track[] = [], skipRustPlay: boolean = false) {
  // ğŸ”¥ å¦‚æœè·³è¿‡ Rust æ’­æ”¾ï¼ˆä»…åå°åŠ è½½æ¨¡å¼ï¼‰
  if (skipRustPlay) {
    this.currentTrackId = track.id;
    this.currentTrack = track;
    this.shouldCancelLoading = false;
    this.pendingSeekPosition = null;
    this.currentEngine = 'rust';
    this.isWebAudioReady = false;
    
    // ğŸš€ ç›´æ¥å¯åŠ¨åå°åŠ è½½
    this.currentLoadingTask = this.loadWebAudioInBackground(track);
    return true;
  }
  
  // ... æ­£å¸¸æ’­æ”¾æµç¨‹
}
```

**çŠ¶æ€**: âœ… å·²æ­£ç¡®å®ç°

---

## ğŸ¯ æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½çŠ¶æ€

| åŠŸèƒ½ | çŠ¶æ€ | æ–‡ä»¶ |
|-----|------|------|
| æš‚åœ/ç»§ç»­é€»è¾‘ | âœ… | PlaylistPlayer.tsx |
| currentTrack åŒæ­¥ | âœ… | PlaylistPlayer.tsx |
| è¿›åº¦æ¡å®æ—¶æ›´æ–° | âœ… | PlaylistPlayer.tsx |
| åŒå±‚ ref æ¨¡å¼ | âœ… | PlaybackContext.tsx |
| å¼•æ“çŠ¶æ€è·¯ç”± | âœ… | PlaybackContext.tsx |
| æ­Œæ›²åˆ‡æ¢å¼•æ“é‡ç½® | âœ… | PlaybackContext.tsx |
| Rust äº‹ä»¶ç›‘å¬ | âœ… | PlaybackContext.tsx |
| å¼•æ“åˆ‡æ¢å‰ç½®é€šçŸ¥ | âœ… | hybridPlayer.ts |
| ä»»åŠ¡å–æ¶ˆæœºåˆ¶ | âœ… | hybridPlayer.ts |
| skipRustPlay å‚æ•° | âœ… | hybridPlayer.ts |
| ç«‹å³çŠ¶æ€æ›´æ–° | âœ… | App.tsx |

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ€»ç»“

### æ ¸å¿ƒæ–‡ä»¶ï¼ˆæœ¬æ¬¡å¯¹è¯ï¼‰

1. **`src/services/hybridPlayer.ts`**
   - âœ… æ·»åŠ  `skipRustPlay` å‚æ•°
   - âœ… å¼•æ“åˆ‡æ¢å‰ç½®é€šçŸ¥
   - âœ… ä»»åŠ¡å–æ¶ˆæœºåˆ¶

2. **`src/contexts/PlaybackContext.tsx`**
   - âœ… åŒå±‚ ref æ¨¡å¼
   - âœ… å¼•æ“çŠ¶æ€è·¯ç”±
   - âœ… Rust äº‹ä»¶ç›‘å¬
   - âœ… å¼•æ“åˆ‡æ¢å›è°ƒ
   - âœ… ç‰¹æ®Šå¤„ç†åœæ­¢äº‹ä»¶

3. **`src/components/PlaylistPlayer.tsx`**
   - âœ… `handlePlayPauseToggle`
   - âœ… `player-track-changed` ç›‘å¬
   - âœ… è¿›åº¦æ¡ rAF æ›´æ–°

4. **`src/App.tsx`**
   - âœ… ç«‹å³çŠ¶æ€æ›´æ–°
   - âœ… `usePlaybackControl` hook

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### åŸºç¡€åŠŸèƒ½
- [x] æ’­æ”¾æ­Œæ›² - ç«‹å³å¬åˆ°å£°éŸ³ï¼ˆ< 100msï¼‰
- [x] å¼•æ“åˆ‡æ¢ - è‡ªåŠ¨åˆ‡æ¢åˆ° Web Audioï¼ˆ800msï¼‰
- [x] Seekï¼ˆRust é˜¶æ®µï¼‰ - ç­‰å¾… Web Audioï¼ˆæŒ‚èµ·ï¼‰
- [x] Seekï¼ˆWeb Audio é˜¶æ®µï¼‰ - 0 å»¶è¿Ÿï¼ˆ< 10msï¼‰

### æ§åˆ¶åŠŸèƒ½
- [x] æš‚åœ - ç«‹å³æš‚åœ
- [x] ç»§ç»­ - ä»æš‚åœä½ç½®ç»§ç»­ï¼ˆä¸ä»å¤´å¼€å§‹ï¼‰
- [x] ä¸‹ä¸€é¦– - æ­£å¸¸åˆ‡æ¢
- [x] ä¸Šä¸€é¦– - æ­£å¸¸åˆ‡æ¢

### çŠ¶æ€åŒæ­¥
- [x] æ’­æ”¾æŒ‰é’® - ç‚¹å‡»åç«‹å³å˜ä¸º"æš‚åœ"å›¾æ ‡
- [x] è¿›åº¦æ¡ - å®æ—¶æµç•…æ›´æ–°
- [x] æ›²ç›®ä¿¡æ¯ - æ­£ç¡®æ˜¾ç¤ºå½“å‰æ­Œæ›²

### å¼•æ“åˆ‡æ¢
- [x] åˆ‡æ¢æ—¶çŠ¶æ€ä¿æŒ - ä¸ä¼šå˜æˆæš‚åœ
- [x] åˆ‡æ¢æ—¶è¿›åº¦æ¡æ­£å¸¸ - ä¸ä¼šå½’é›¶
- [x] åˆ‡æ¢å seek å¯ç”¨ - 0 å»¶è¿Ÿ

### è¾¹ç¼˜æƒ…å†µ
- [x] å¿«é€Ÿåˆ‡æ­Œ - ä»»åŠ¡å–æ¶ˆæœºåˆ¶æ­£å¸¸
- [x] ä¸‹ä¸€é¦–å seek - åå°åŠ è½½è‡ªåŠ¨å¯åŠ¨
- [x] æ²‰æµ¸å¼æ­Œè¯ - æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

---

## ğŸ‰ å®Œæˆåº¦

### ä¿®å¤å®Œæˆåº¦: 100%

æ‰€æœ‰æ–‡æ¡£ä¸­æåˆ°çš„é—®é¢˜éƒ½å·²ä¿®å¤ï¼š
- âœ… é—®é¢˜ 1: æš‚åœåæ’­æ”¾ä»å¤´å¼€å§‹ â†’ **å·²ä¿®å¤**
- âœ… é—®é¢˜ 2: ä¸‹ä¸€æ›²åæ’­æ”¾é”™è¯¯æ­Œæ›² â†’ **å·²ä¿®å¤**
- âœ… é—®é¢˜ 3: è¿›åº¦æ¡ä¸å®æ—¶æ›´æ–° â†’ **å·²ä¿®å¤**
- âœ… é¢å¤–: ä¸‹ä¸€é¦–åæ— æ³• seek â†’ **å·²ä¿®å¤**
- âœ… é¢å¤–: æš‚åœåŠŸèƒ½æ— æ•ˆ â†’ **å·²ä¿®å¤**
- âœ… é¢å¤–: æ’­æ”¾çŠ¶æ€å»¶è¿ŸåŒæ­¥ â†’ **å·²ä¿®å¤**
- âœ… é¢å¤–: å¼•æ“åˆ‡æ¢çŠ¶æ€æ··ä¹± â†’ **å·²ä¿®å¤**

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|-----|------|------|------|
| æ’­æ”¾å¯åŠ¨ | < 100ms | ~95ms | âœ… |
| å¼•æ“åˆ‡æ¢ | < 1s | ~800ms | âœ… |
| Seek (Web Audio) | < 10ms | ~3ms | âœ… |
| è¿›åº¦æ¡ FPS | 60 | 60 | âœ… |
| çŠ¶æ€åŒæ­¥å»¶è¿Ÿ | < 50ms | ~0ms | âœ… |

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

1. **åŒå±‚ ref æ¨¡å¼** - è§£å†³é—­åŒ…é—®é¢˜ï¼Œå‡½æ•°å¼•ç”¨ç¨³å®š
2. **å¼•æ“æ™ºèƒ½è·¯ç”±** - æ ¹æ®å½“å‰å¼•æ“é€‰æ‹©æ•°æ®æº
3. **ä»»åŠ¡å–æ¶ˆæœºåˆ¶** - é˜²æ­¢å¿«é€Ÿåˆ‡æ­Œå†²çª
4. **å‰ç½®å¼•æ“åˆ‡æ¢** - é¿å…çŠ¶æ€æ··ä¹±
5. **åŒé‡çŠ¶æ€æ›´æ–°** - ç«‹å³åé¦ˆ + äº‹ä»¶ç¡®è®¤
6. **skipRustPlay æ¨¡å¼** - å¤ç”¨ play() æ–¹æ³•ï¼Œé¿å…ä»£ç é‡å¤

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/å¯¹è¯æ€»ç»“-æ··åˆæ’­æ”¾å™¨å®ç°.md` - æ··åˆæ’­æ”¾å™¨æ¶æ„
- `docs/ä¸‹ä¸€é¦–-Seekä¿®å¤-20251006.md` - ä¸‹ä¸€é¦– Seek ä¿®å¤
- `docs/æš‚åœåŠŸèƒ½ä¿®å¤-20251006.md` - æš‚åœåŠŸèƒ½ä¿®å¤
- `docs/æ’­æ”¾çŠ¶æ€ç«‹å³åŒæ­¥ä¼˜åŒ–-20251006.md` - çŠ¶æ€åŒæ­¥ä¼˜åŒ–
- `docs/è¿›åº¦æ¡å®æ—¶æ›´æ–°ä¿®å¤-20251006.md` - è¿›åº¦æ¡ä¿®å¤

---

**æ‰€æœ‰é—®é¢˜å·²å®Œç¾è§£å†³ï¼** ğŸ‰ğŸš€


