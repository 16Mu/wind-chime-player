# ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚ - åŠŸèƒ½æ¥å…¥

**æ—¥æœŸ**: 2025å¹´10æœˆ4æ—¥  
**ç›®æ ‡å—ä¼—**: å¼€å‘è€…  
**éš¾åº¦**: ä¸­çº§åˆ°é«˜çº§

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
2. [Tauri IPC é€šä¿¡](#tauri-ipc-é€šä¿¡)
3. [ç»„ä»¶å®ç°](#ç»„ä»¶å®ç°)
4. [çŠ¶æ€ç®¡ç†](#çŠ¶æ€ç®¡ç†)
5. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
6. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Frontend (React)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  UI Components                                      â”‚ â”‚
â”‚  â”‚  - AudioDiagnosticTool                             â”‚ â”‚
â”‚  â”‚  - RemoteScanButton                                â”‚ â”‚
â”‚  â”‚  - PlaylistStatsCard                               â”‚ â”‚
â”‚  â”‚  - StreamingStatsPanel                             â”‚ â”‚
â”‚  â”‚  - LibraryStatsPanel                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â†•                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Tauri IPC Layer (@tauri-apps/api/core)           â”‚ â”‚
â”‚  â”‚  - invoke('command_name', { params })              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Backend (Rust)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Tauri Commands (#[tauri::command])                â”‚ â”‚
â”‚  â”‚  - debug_audio_system                              â”‚ â”‚
â”‚  â”‚  - remote_scan_library                             â”‚ â”‚
â”‚  â”‚  - playlists_get_stats                             â”‚ â”‚
â”‚  â”‚  - streaming_*                                     â”‚ â”‚
â”‚  â”‚  - test_library_stats                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â†•                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Business Logic Modules                            â”‚ â”‚
â”‚  â”‚  - audio_system/                                   â”‚ â”‚
â”‚  â”‚  - remote_source/                                  â”‚ â”‚
â”‚  â”‚  - playlists/                                      â”‚ â”‚
â”‚  â”‚  - streaming/                                      â”‚ â”‚
â”‚  â”‚  - db/                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡åŸåˆ™

1. **é«˜å†…èšä½è€¦åˆ**
   - æ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
   - é€šè¿‡ Tauri IPC ä¸åç«¯é€šä¿¡
   - æ— ç›´æ¥æ¨¡å—ä¾èµ–

2. **å•å‘æ•°æ®æµ**
   - ç”¨æˆ·æ“ä½œ â†’ UIç»„ä»¶
   - UIç»„ä»¶ â†’ Tauriå‘½ä»¤
   - Tauriå‘½ä»¤ â†’ åç«¯é€»è¾‘
   - åç«¯é€»è¾‘ â†’ è¿”å›ç»“æœ
   - ç»“æœ â†’ æ›´æ–°UIçŠ¶æ€

3. **å®¹é”™è®¾è®¡**
   - æ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½æœ‰ try-catch
   - å‹å¥½çš„é”™è¯¯æç¤º
   - ä¼˜é›…çš„é™çº§å¤„ç†

---

## Tauri IPC é€šä¿¡

### åŸºæœ¬æ¨¡å¼

#### Frontend (TypeScript)
```typescript
import { invoke } from '@tauri-apps/api/core';

// è°ƒç”¨ä¸å¸¦å‚æ•°çš„å‘½ä»¤
const result = await invoke<ReturnType>('command_name');

// è°ƒç”¨å¸¦å‚æ•°çš„å‘½ä»¤
const result = await invoke<ReturnType>('command_name', {
  paramName1: value1,
  paramName2: value2,
});
```

#### Backend (Rust)
```rust
#[tauri::command]
async fn command_name(
    param_name1: String,
    param_name2: i32,
) -> Result<ReturnType, String> {
    // ä¸šåŠ¡é€»è¾‘
    Ok(return_value)
}
```

### å®é™…æ¡ˆä¾‹

#### æ¡ˆä¾‹ 1: éŸ³é¢‘è¯Šæ–­

**Frontend**:
```typescript
const runAdvancedDebug = async () => {
  setIsRunning(true);
  try {
    const result = await invoke<string>('debug_audio_system');
    // å¤„ç†ç»“æœ
    parseDebugResult(result);
  } catch (error) {
    console.error('è°ƒè¯•å¤±è´¥:', error);
    showError(error);
  } finally {
    setIsRunning(false);
  }
};
```

**Backend**:
```rust
#[tauri::command]
async fn debug_audio_system() -> Result<String, String> {
    let mut output = String::new();
    
    // æ£€æŸ¥éŸ³é¢‘è®¾å¤‡
    match rodio::OutputStream::try_default() {
        Ok((_stream, handle)) => {
            output.push_str("âœ… é»˜è®¤éŸ³é¢‘è¾“å‡ºå¯ç”¨\n");
        }
        Err(e) => {
            output.push_str(&format!("âŒ éŸ³é¢‘è¾“å‡ºé”™è¯¯: {}\n", e));
        }
    }
    
    Ok(output)
}
```

#### æ¡ˆä¾‹ 2: è¿œç¨‹æ‰«æ

**Frontend**:
```typescript
const handleScan = async () => {
  setIsScanning(true);
  try {
    await invoke('remote_scan_library', {
      serverId: 'server-123',
      path: '/',
      recursive: true,
    });
    showSuccess('æ‰«æå®Œæˆ');
  } catch (error) {
    showError(`æ‰«æå¤±è´¥: ${error}`);
  } finally {
    setIsScanning(false);
  }
};
```

**Backend**:
```rust
#[tauri::command]
async fn remote_scan_library(
    server_id: String,
    path: String,
    recursive: bool,
    state: State<'_, AppState>,
) -> Result<(), String> {
    let scanner = state.scanner.lock().await;
    scanner.scan(&server_id, &path, recursive).await
        .map_err(|e| e.to_string())
}
```

---

## ç»„ä»¶å®ç°

### ç»„ä»¶æ¨¡æ¿

```typescript
import { useState, useEffect } from 'react';
import { invoke } from '@tauri-apps/api/core';

interface DataType {
  // å®šä¹‰æ•°æ®ç»“æ„
}

export function FeatureComponent() {
  // 1. çŠ¶æ€ç®¡ç†
  const [data, setData] = useState<DataType | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // 2. æ•°æ®åŠ è½½
  const loadData = async () => {
    setIsLoading(true);
    setError(null);
    
    try {
      const result = await invoke<DataType>('backend_command');
      setData(result);
    } catch (err) {
      console.error('åŠ è½½å¤±è´¥:', err);
      setError(`åŠ è½½å¤±è´¥: ${err}`);
    } finally {
      setIsLoading(false);
    }
  };

  // 3. ç”Ÿå‘½å‘¨æœŸ
  useEffect(() => {
    loadData();
  }, []);

  // 4. æ¸²æŸ“
  return (
    <div>
      {isLoading && <LoadingSpinner />}
      {error && <ErrorMessage message={error} />}
      {data && <DataDisplay data={data} />}
    </div>
  );
}
```

### å®é™…æ¡ˆä¾‹: PlaylistStatsCard

```typescript
export function PlaylistStatsCard() {
  const [stats, setStats] = useState<PlaylistStats | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    loadStats();
  }, []);

  const loadStats = async () => {
    setIsLoading(true);
    try {
      const result = await invoke<PlaylistStats>('playlists_get_stats');
      setStats(result);
    } catch (error) {
      console.error('åŠ è½½æ­Œå•ç»Ÿè®¡å¤±è´¥:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // åŠ è½½çŠ¶æ€
  if (isLoading) {
    return <SkeletonLoader />;
  }

  // æ— æ•°æ®çŠ¶æ€
  if (!stats) {
    return null;
  }

  // æ•°æ®å±•ç¤º
  return (
    <div className="grid grid-cols-5 gap-4">
      <StatCard label="æ­Œå•æ€»æ•°" value={stats.total_playlists} />
      <StatCard label="æ›²ç›®æ€»æ•°" value={stats.total_tracks} />
      {/* æ›´å¤šç»Ÿè®¡å¡ç‰‡ */}
    </div>
  );
}
```

---

## çŠ¶æ€ç®¡ç†

### Local State (useState)

ç”¨äºç»„ä»¶å†…éƒ¨çš„ä¸´æ—¶çŠ¶æ€ï¼š

```typescript
const [isOpen, setIsOpen] = useState(false);
const [data, setData] = useState<DataType | null>(null);
const [error, setError] = useState<string | null>(null);
```

### Global State (Context)

ç”¨äºè·¨ç»„ä»¶å…±äº«çš„çŠ¶æ€ï¼š

```typescript
// RemoteSourceContext.tsx
export const RemoteSourceContext = createContext<RemoteSourceContextType>(...);

export function useRemoteSource() {
  const context = useContext(RemoteSourceContext);
  return context;
}

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const { servers, refreshCacheStats } = useRemoteSource();
```

### çŠ¶æ€æ›´æ–°æ¨¡å¼

```typescript
// âœ… å¥½çš„åšæ³• - ä½¿ç”¨å‡½æ•°å¼æ›´æ–°
setCount(prevCount => prevCount + 1);

// âŒ é¿å… - ç›´æ¥ä½¿ç”¨å½“å‰å€¼
setCount(count + 1); // åœ¨å¼‚æ­¥æ“ä½œä¸­å¯èƒ½å‡ºé”™
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. é˜²æŠ–å’ŒèŠ‚æµ

```typescript
import { useDebounce } from '../hooks/useDebounce';

const debouncedSearchTerm = useDebounce(searchTerm, 500);

useEffect(() => {
  if (debouncedSearchTerm) {
    performSearch(debouncedSearchTerm);
  }
}, [debouncedSearchTerm]);
```

### 2. æ¡ä»¶æ¸²æŸ“

```typescript
// âœ… å¥½çš„åšæ³• - æ—©è¿”å›
if (isLoading) return <LoadingSpinner />;
if (error) return <ErrorMessage />;
if (!data) return null;

return <DataDisplay data={data} />;

// âŒ é¿å… - å¤šå±‚åµŒå¥—
return (
  <div>
    {isLoading ? (
      <LoadingSpinner />
    ) : error ? (
      <ErrorMessage />
    ) : data ? (
      <DataDisplay data={data} />
    ) : null}
  </div>
);
```

### 3. æŒ‰éœ€åŠ è½½

```typescript
// åªåœ¨éœ€è¦æ—¶åŠ è½½æ•°æ®
const loadDataOnDemand = async () => {
  if (!data) {
    await loadData();
  }
};
```

### 4. è‡ªåŠ¨åˆ·æ–°ä¼˜åŒ–

```typescript
useEffect(() => {
  if (autoRefresh) {
    const interval = setInterval(loadData, 3000);
    return () => clearInterval(interval); // æ¸…ç†å®šæ—¶å™¨
  }
}, [autoRefresh]);
```

---

## é”™è¯¯å¤„ç†

### å‰ç«¯é”™è¯¯å¤„ç†

```typescript
try {
  const result = await invoke<DataType>('command_name');
  setData(result);
} catch (error) {
  // 1. è®°å½•é”™è¯¯
  console.error('æ“ä½œå¤±è´¥:', error);
  
  // 2. ç”¨æˆ·å‹å¥½æç¤º
  setError(`æ“ä½œå¤±è´¥: ${error}`);
  
  // 3. å¯é€‰ï¼šä¸ŠæŠ¥é”™è¯¯
  // reportError(error);
}
```

### åç«¯é”™è¯¯å¤„ç†

```rust
#[tauri::command]
async fn some_command() -> Result<DataType, String> {
    let result = dangerous_operation()
        .await
        .map_err(|e| format!("æ“ä½œå¤±è´¥: {}", e))?;
    
    Ok(result)
}
```

### é”™è¯¯ç±»å‹

1. **ç½‘ç»œé”™è¯¯**: è¿œç¨‹æœåŠ¡å™¨è¿æ¥å¤±è´¥
2. **æƒé™é”™è¯¯**: ç¼ºå°‘å¿…è¦æƒé™
3. **æ•°æ®é”™è¯¯**: æ•°æ®æ ¼å¼ä¸æ­£ç¡®
4. **ä¸šåŠ¡é”™è¯¯**: ä¸šåŠ¡é€»è¾‘çº¦æŸ

---

## æœ€ä½³å®è·µ

### 1. TypeScript ç±»å‹å®‰å…¨

```typescript
// âœ… å®šä¹‰æ¸…æ™°çš„æ¥å£
interface PlaylistStats {
  total_playlists: number;
  total_tracks: number;
  total_duration_ms: number;
}

// âœ… ä½¿ç”¨æ³›å‹
const result = await invoke<PlaylistStats>('playlists_get_stats');

// âœ… ç±»å‹å®ˆå«
if (typeof result.total_playlists !== 'number') {
  throw new Error('Invalid data format');
}
```

### 2. ç»„ä»¶å‘½å

```typescript
// âœ… PascalCase for components
export function AudioDiagnosticTool() { }

// âœ… camelCase for functions
const loadStats = async () => { };

// âœ… UPPER_CASE for constants
const DEFAULT_TIMEOUT = 5000;
```

### 3. æ–‡ä»¶ç»„ç»‡

```
src/components/
  â”œâ”€â”€ AudioDiagnosticTool.tsx       # åŠŸèƒ½ç»„ä»¶
  â”œâ”€â”€ RemoteScanButton.tsx          # å¯å¤ç”¨æŒ‰é’®
  â”œâ”€â”€ PlaylistStatsCard.tsx         # æ•°æ®å±•ç¤ºå¡ç‰‡
  â”œâ”€â”€ StreamingStatsPanel.tsx       # å¤æ‚é¢æ¿
  â””â”€â”€ LibraryStatsPanel.tsx         # ç»Ÿè®¡é¢æ¿
```

### 4. æ ·å¼ç®¡ç†

```typescript
// âœ… ä½¿ç”¨ Tailwind CSS
<div className="bg-white dark:bg-dark-900 rounded-xl p-6">

// âœ… å“åº”å¼è®¾è®¡
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

// âœ… æ·±è‰²æ¨¡å¼æ”¯æŒ
<span className="text-slate-900 dark:text-white">
```

### 5. å¯è®¿é—®æ€§

```typescript
// âœ… ä½¿ç”¨è¯­ä¹‰åŒ–æ ‡ç­¾
<button aria-label="åˆ·æ–°ç»Ÿè®¡">
  <RefreshIcon />
</button>

// âœ… é”®ç›˜å¯¼èˆª
<div tabIndex={0} onKeyPress={handleKeyPress}>

// âœ… å±å¹•é˜…è¯»å™¨
<span className="sr-only">åŠ è½½ä¸­...</span>
```

---

## è°ƒè¯•æŠ€å·§

### 1. ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·

```typescript
// åœ¨å…³é”®ä½ç½®æ·»åŠ æ—¥å¿—
console.log('ğŸ“Š åŠ è½½ç»Ÿè®¡æ•°æ®:', stats);
console.error('âŒ æ“ä½œå¤±è´¥:', error);
console.warn('âš ï¸ è­¦å‘Š:', message);
```

### 2. Rust è°ƒè¯•

```rust
// ä½¿ç”¨ eprintln! è¾“å‡ºè°ƒè¯•ä¿¡æ¯
eprintln!("ğŸ” è°ƒè¯•ä¿¡æ¯: {:?}", data);

// ä½¿ç”¨ dbg! å®
let result = dbg!(some_function());
```

### 3. ç½‘ç»œè¯·æ±‚ç›‘æ§

åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ Network æ ‡ç­¾ä¸­æŸ¥çœ‹ï¼š
- `__TAURI_IPC__` - Tauri IPC è¯·æ±‚
- è¯·æ±‚å‚æ•°å’Œå“åº”

---

## æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

```typescript
describe('PlaylistStatsCard', () => {
  it('should display loading state', () => {
    render(<PlaylistStatsCard />);
    expect(screen.getByText('åŠ è½½ä¸­...')).toBeInTheDocument();
  });

  it('should display stats after loading', async () => {
    // Mock invoke
    (invoke as jest.Mock).mockResolvedValue({
      total_playlists: 10,
      total_tracks: 100,
    });

    render(<PlaylistStatsCard />);
    await waitFor(() => {
      expect(screen.getByText('10')).toBeInTheDocument();
    });
  });
});
```

### 2. é›†æˆæµ‹è¯•

1. å¯åŠ¨åº”ç”¨
2. å¯¼èˆªåˆ°åŠŸèƒ½é¡µé¢
3. è§¦å‘åŠŸèƒ½
4. éªŒè¯ç»“æœ

### 3. E2E æµ‹è¯•

ä½¿ç”¨ Playwright æˆ– Cypress è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ã€‚

---

## æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†5ä¸ªæ–°åŠŸèƒ½çš„æŠ€æœ¯å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… æ¶æ„è®¾è®¡å’Œé€šä¿¡æ¨¡å¼
2. âœ… ç»„ä»¶å®ç°å’ŒçŠ¶æ€ç®¡ç†
3. âœ… æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†
4. âœ… æœ€ä½³å®è·µå’Œè°ƒè¯•æŠ€å·§

**å…³é”®è¦ç‚¹**:
- ä½¿ç”¨ Tauri IPC è¿›è¡Œå‰åç«¯é€šä¿¡
- ä¿æŒç»„ä»¶çš„é«˜å†…èšä½è€¦åˆ
- é‡è§†ç”¨æˆ·ä½“éªŒå’Œé”™è¯¯å¤„ç†
- éµå¾ªä»£ç è§„èŒƒå’Œæœ€ä½³å®è·µ

---

**ä½œè€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ4æ—¥












