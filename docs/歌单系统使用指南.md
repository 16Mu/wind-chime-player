# 🎵 企业级歌单系统 - 使用指南

## ✨ 功能特点

### 🎯 核心功能
- ✅ **完整的CRUD操作** - 创建、读取、更新、删除歌单
- ✅ **智能歌单** - 根据规则自动筛选曲目
- ✅ **拖拽重排** - 支持曲目拖拽重新排序
- ✅ **导入导出** - 支持M3U/M3U8/JSON格式
- ✅ **收藏功能** - 标记常用歌单
- ✅ **统计信息** - 播放次数、曲目数等

### 🏗️ 架构设计

#### 高内聚低耦合
```
后端 (Rust)
├── playlist/mod.rs          - 模块入口
├── playlist/types.rs        - 类型定义
├── playlist/manager.rs      - 核心业务逻辑
├── playlist/smart_playlist.rs - 智能歌单引擎
├── playlist/exporter.rs     - 导出功能
└── playlist/importer.rs     - 导入功能

前端 (React/TypeScript)
├── contexts/PlaylistContext.tsx  - 状态管理（单一数据源）
├── components/playlist/
│   ├── PlaylistCard.tsx         - 纯展示组件
│   ├── PlaylistsView.tsx        - 容器组件
│   ├── PlaylistDetail.tsx       - 详情页组件
│   ├── CreatePlaylistDialog.tsx - 对话框组件
│   └── SmartPlaylistEditor.tsx  - 智能规则编辑器
└── types/                        - TypeScript类型定义
```

## 🚀 快速开始

### 1. 集成到应用

#### 1.1 添加Provider

在你的根组件中添加`PlaylistProvider`:

```tsx
// src/App.tsx
import { PlaylistProvider } from './contexts/PlaylistContext';

function App() {
  return (
    <PlaylistProvider>
      {/* 你的应用组件 */}
      <YourAppContent />
    </PlaylistProvider>
  );
}
```

#### 1.2 使用歌单列表视图

```tsx
import { PlaylistsView } from './components/playlist';
import { useState } from 'react';

function YourPlaylistPage() {
  const [showCreateDialog, setShowCreateDialog] = useState(false);
  const [selectedPlaylistId, setSelectedPlaylistId] = useState<number | null>(null);

  return (
    <div>
      {selectedPlaylistId ? (
        // 显示歌单详情
        <PlaylistDetail 
          playlistId={selectedPlaylistId}
          onBack={() => setSelectedPlaylistId(null)}
        />
      ) : (
        // 显示歌单列表
        <PlaylistsView
          onCreateClick={() => setShowCreateDialog(true)}
          onPlaylistClick={(id) => setSelectedPlaylistId(id)}
        />
      )}
      
      {showCreateDialog && (
        <CreatePlaylistDialog
          isOpen={showCreateDialog}
          onClose={() => setShowCreateDialog(false)}
          onSuccess={(id) => {
            setShowCreateDialog(false);
            setSelectedPlaylistId(id);
          }}
        />
      )}
    </div>
  );
}
```

### 2. 使用Context API

#### 2.1 基本操作

```tsx
import { usePlaylist } from './contexts/PlaylistContext';

function MyComponent() {
  const {
    playlists,          // 所有歌单
    currentPlaylist,    // 当前选中的歌单详情
    loading,            // 加载状态
    error,              // 错误信息
    
    // 操作方法
    createPlaylist,
    updatePlaylist,
    deletePlaylist,
  } = usePlaylist();

  // 创建歌单
  const handleCreate = async () => {
    const options = {
      name: '我的新歌单',
      description: '描述信息',
      color_theme: '#8B5CF6',
      is_smart: false,
      smart_rules: undefined,
    };
    
    const playlistId = await createPlaylist(options);
    console.log('创建成功，ID:', playlistId);
  };

  return (
    <div>
      {/* 你的UI */}
    </div>
  );
}
```

#### 2.2 智能歌单

```tsx
import { usePlaylist } from './contexts/PlaylistContext';

function SmartPlaylistExample() {
  const { createSmartPlaylist, updateSmartPlaylistRules } = usePlaylist();

  const handleCreateSmart = async () => {
    const rules = {
      rules: [
        {
          field: 'artist',
          operator: 'equals',
          value: 'Taylor Swift',
        },
        {
          field: 'duration',
          operator: 'less_than',
          value: '300000', // 5分钟
        },
      ],
      match_all: true, // AND逻辑
      limit: 50,        // 最多50首
    };

    const id = await createSmartPlaylist('Taylor Swift 短曲', rules);
    console.log('智能歌单创建成功:', id);
  };

  return <button onClick={handleCreateSmart}>创建智能歌单</button>;
}
```

## 📚 API参考

### PlaylistContext API

#### 状态

| 属性 | 类型 | 说明 |
|------|------|------|
| `playlists` | `Playlist[]` | 所有歌单列表 |
| `currentPlaylist` | `PlaylistWithTracks \| null` | 当前歌单详情（包含曲目） |
| `stats` | `PlaylistStats \| null` | 统计信息 |
| `loading` | `boolean` | 加载状态 |
| `error` | `string \| null` | 错误信息 |

#### 方法

##### CRUD操作

```typescript
// 加载歌单列表
loadPlaylists: () => Promise<void>

// 创建歌单
createPlaylist: (options: CreatePlaylistOptions) => Promise<number>

// 获取歌单详情
getPlaylistDetail: (id: number) => Promise<void>

// 更新歌单
updatePlaylist: (id: number, options: UpdatePlaylistOptions) => Promise<void>

// 删除歌单
deletePlaylist: (id: number) => Promise<void>
```

##### 曲目管理

```typescript
// 添加曲目
addTracksToPlaylist: (playlistId: number, trackIds: number[]) => Promise<void>

// 移除曲目
removeTrackFromPlaylist: (playlistId: number, trackId: number) => Promise<void>

// 重排曲目
reorderTracks: (playlistId: number, trackIds: number[]) => Promise<void>
```

##### 智能歌单

```typescript
// 创建智能歌单
createSmartPlaylist: (name: string, rules: SmartRules) => Promise<number>

// 更新规则
updateSmartPlaylistRules: (id: number, rules: SmartRules) => Promise<void>

// 刷新智能歌单
refreshSmartPlaylist: (id: number) => Promise<void>

// 刷新所有智能歌单
refreshAllSmartPlaylists: () => Promise<void>
```

##### 导入导出

```typescript
// 导出歌单
exportPlaylist: (id: number, filePath: string, format: ExportFormat) => Promise<void>

// 预览导出内容
exportPlaylistPreview: (id: number, format: ExportFormat) => Promise<string>

// 导入歌单
importPlaylist: (filePath: string) => Promise<number>
```

## 🎨 组件Props参考

### PlaylistCard

```typescript
interface PlaylistCardProps {
  playlist: Playlist;           // 歌单数据
  onClick?: () => void;         // 点击事件
  onFavoriteToggle?: () => void; // 收藏切换
  className?: string;           // 自定义样式
}
```

### PlaylistsView

```typescript
interface PlaylistsViewProps {
  onCreateClick?: () => void;           // 创建按钮点击
  onPlaylistClick?: (id: number) => void; // 歌单点击
}
```

### PlaylistDetail

```typescript
interface PlaylistDetailProps {
  playlistId: number;                    // 歌单ID
  onBack?: () => void;                   // 返回
  onEdit?: () => void;                   // 编辑
  onPlayTrack?: (trackId: number) => void; // 播放曲目
  onAddTracks?: () => void;              // 添加曲目
}
```

### CreatePlaylistDialog

```typescript
interface CreatePlaylistDialogProps {
  isOpen: boolean;                       // 是否显示
  onClose: () => void;                   // 关闭
  editPlaylist?: Playlist;              // 编辑模式：歌单数据
  onSuccess?: (id: number) => void;     // 成功回调
}
```

### SmartPlaylistEditor

```typescript
interface SmartPlaylistEditorProps {
  playlistId?: number;                  // 歌单ID（编辑模式）
  initialRules?: SmartRules;            // 初始规则
  onSave?: (rules: SmartRules) => void; // 保存回调
  onCancel?: () => void;                // 取消回调
}
```

## 💡 最佳实践

### 1. 状态管理

✅ **推荐**：使用Context提供的方法
```tsx
const { createPlaylist } = usePlaylist();
await createPlaylist(options);
```

❌ **不推荐**：直接调用Tauri命令
```tsx
// 不要这样做！会导致状态不同步
await invoke('playlists_create', { options });
```

### 2. 错误处理

```tsx
const { error, clearError } = usePlaylist();

useEffect(() => {
  if (error) {
    // 显示错误提示
    showNotification(error);
    // 清除错误
    clearError();
  }
}, [error]);
```

### 3. 性能优化

```tsx
// 使用useMemo避免不必要的重新计算
const sortedPlaylists = useMemo(() => {
  return [...playlists].sort((a, b) => 
    b.created_at - a.created_at
  );
}, [playlists]);
```

### 4. 组件组合

```tsx
// ✅ 好的做法：组合小组件
function MyPlaylistPage() {
  return (
    <div>
      <PlaylistsView />
      <CreatePlaylistDialog />
    </div>
  );
}

// ❌ 不好的做法：把所有逻辑写在一个大组件里
```

## 🔧 自定义和扩展

### 1. 自定义样式

所有组件都接受`className` prop：

```tsx
<PlaylistCard 
  playlist={playlist}
  className="my-custom-styles"
/>
```

### 2. 扩展智能规则

在`SmartPlaylistEditor.tsx`中添加新的字段类型：

```typescript
const fieldOptions = [
  // ... 现有字段
  { value: 'genre', label: '流派' },  // 新增
  { value: 'year', label: '年份' },   // 新增
];
```

### 3. 添加新的导出格式

在后端`exporter.rs`中实现新格式，然后在`ExportFormat`类型中添加：

```typescript
export type ExportFormat = 'M3U' | 'M3U8' | 'JSON' | 'XML'; // 新增XML
```

## 📦 打包和部署

系统已集成到Tauri应用中，随应用一起打包：

```bash
# 开发模式
npm run tauri dev

# 生产构建
npm run tauri build
```

## 🐛 故障排查

### 问题：歌单创建后不显示

**原因**：可能是Context未刷新

**解决**：
```tsx
await createPlaylist(options);
await loadPlaylists(); // 手动刷新
```

### 问题：智能歌单规则不生效

**检查**：
1. 规则语法是否正确
2. 是否调用了`refreshSmartPlaylist`
3. 数据库中是否有匹配的曲目

### 问题：导入失败

**检查**：
1. 文件格式是否正确（M3U/JSON）
2. 文件路径是否存在
3. 曲目路径是否在音乐库中

## 📄 许可证

本歌单系统遵循项目主许可证。

## 🤝 贡献

欢迎提交Issue和Pull Request！

---

**享受你的企业级歌单系统！** 🎉

