# 剩余问题修复指南

> 给新对话窗口的快速修复手册  
> 预计修复时间: 30-60 分钟

---

## ⚠️ 问题 1: 暂停后播放从头开始

### 复现
1. 播放歌曲
2. 等待 1 秒（引擎切换完成）
3. 点击暂停
4. 点击播放 → **从 0:00 开始**（错误！）

### 原因
```typescript
// src/components/PlaylistPlayer.tsx:254
const handlePlay = async () => {
  await hybridPlayer.play(currentTrack, []);  // ← 重新播放！
};
```

播放按钮调用了 `handlePlay()`，这会**重新播放**而不是**继续播放**。

### 修复方案

#### 步骤 1: 创建统一的播放/暂停切换函数

```typescript
// 在 PlaylistPlayer.tsx 中添加
const handlePlayPauseToggle = async () => {
  try {
    const { hybridPlayer } = await import('../services/hybridPlayer');
    
    if (playerState.is_playing) {
      // 正在播放 → 暂停
      await hybridPlayer.pause();
      console.log('⏸️ [PlaylistPlayer] 已暂停');
    } else if (playerState.current_track) {
      // 有歌曲但暂停 → 继续播放
      await hybridPlayer.resume();
      console.log('▶️ [PlaylistPlayer] 已继续播放');
    }
  } catch (error) {
    console.error('播放/暂停切换失败:', error);
  }
};
```

#### 步骤 2: 找到播放按钮并替换

搜索：
```bash
grep -n "onClick.*handlePlay\|handlePlay\|handlePause" src/components/PlaylistPlayer.tsx
```

或者搜索播放/暂停按钮的 JSX：
```tsx
{isPlaying ? (
  // 暂停按钮
  <button onClick={handlePause}>...</button>
) : (
  // 播放按钮
  <button onClick={handlePlay}>...</button>  ← 改这里
)}
```

替换为：
```tsx
<button onClick={handlePlayPauseToggle}>...</button>
```

---

## ⚠️ 问题 2: 下一曲后播放错误歌曲

### 复现
1. 播放歌曲 A
2. 点击下一曲 → 播放歌曲 B
3. 点击暂停
4. 点击播放 → **播放歌曲 A**（应该播放 B）

### 原因
`currentTrack` state 没有监听 Rust 的 `player-track-changed` 事件。

### 修复方案

在 `PlaylistPlayer.tsx` 中添加事件监听：

```typescript
// 在 useEffect 区域添加
useEffect(() => {
  const unlistenTrackChanged = listen('player-track-changed', (event: any) => {
    const newTrack = event.payload;
    if (newTrack) {
      setCurrentTrack(newTrack);
      console.log('🔄 [PlaylistPlayer] currentTrack 已同步:', newTrack.title);
    }
  });
  
  return () => {
    unlistenTrackChanged.then(fn => fn());
  };
}, []);
```

**位置**：在现有的 `useEffect` 附近添加（约 line 150-250 区域）

---

## ⚠️ 问题 3: 普通界面进度条不实时更新

### 症状
- 播放时进度条卡顿
- 只有歌词更新（1秒一次）时才跳一下

### 诊断步骤

#### 步骤 1: 找到进度条组件

搜索：
```bash
grep -n "ProgressBar\|progress.*bar\|进度条" src/components/PlaylistPlayer.tsx
```

或者检查：
- `src/components/player/ProgressBar.tsx`
- PlaylistPlayer 的 JSX 中的进度条渲染

#### 步骤 2: 检查数据源

进度条应该这样获取位置：
```typescript
// 正确方式
const getPosition = usePlaybackPosition();
const position = getPosition();  // 实时获取

// 错误方式
const position = playerState.position_ms;  // 只有事件更新才变
```

#### 步骤 3: 修复

如果进度条组件是这样：
```typescript
<ProgressBar 
  position={playerState.position_ms}  // ← 错误
  duration={track.duration_ms}
/>
```

改为：
```typescript
const getPosition = usePlaybackPosition();
const currentPosition = getPosition();  // 每帧获取

<ProgressBar 
  position={currentPosition}  // ← 正确
  duration={track.duration_ms}
/>
```

或者在 ProgressBar 组件内部：
```typescript
// ProgressBar.tsx
import { usePlaybackPosition } from '../../contexts/PlaybackContext';

function ProgressBar() {
  const getPosition = usePlaybackPosition();
  const position = getPosition();  // 实时获取
  
  // 使用 position...
}
```

---

## 🔍 调试技巧

### 启用位置调试日志

临时取消注释 `PlaybackContext.tsx` 中的调试日志：

```typescript
// line 119-120
if (Math.random() < 0.01) {
  console.log(`📊 [PlaybackContext] Web Audio 引擎，位置: ${positionMs.toFixed(0)}ms`);
}

// line 137-138
if (Math.random() < 0.01) {
  console.log(`📊 [PlaybackContext] Rust 引擎，位置: ${position.toFixed(0)}ms`);
}
```

改为：
```typescript
console.log(`📊 [PlaybackContext] Web Audio 引擎，位置: ${positionMs.toFixed(0)}ms`);
console.log(`📊 [PlaybackContext] Rust 引擎，位置: ${position.toFixed(0)}ms`);
```

然后观察控制台是否每帧都有位置更新。

---

## 📊 预期修复后的效果

### 测试 1: 暂停/继续
```
播放歌曲 → 听到声音
等待 1 秒 → 引擎切换完成
点击暂停 → ⏸️ 暂停
点击播放 → ▶️ 从暂停位置继续（不是从头）
```

### 测试 2: 下一曲
```
播放歌曲 A
点击下一曲 → 播放歌曲 B
点击暂停
点击播放 → 继续播放歌曲 B（不是 A）
```

### 测试 3: 进度条
```
播放歌曲
观察进度条 → 流畅移动（60fps）
不再卡顿
```

---

## 🚀 修复完成后

### Git 提交

```bash
git add .

git commit -m "fix: 🐛 修复混合播放器剩余问题 - v0.4.0.2

修复内容：
✅ 暂停后继续播放（不从头开始）
✅ 下一曲后currentTrack同步
✅ 普通界面进度条实时更新

技术细节：
- 统一播放/暂停按钮逻辑
- 监听player-track-changed同步state
- 进度条使用usePlaybackPosition

现在混合播放器100%完成！"

git tag -a v0.4.0.2 -m "v0.4.0.2 - 混合播放器完整版

所有问题已修复，100%完成"
```

---

## 📁 文件清单

### 需要修改的文件
1. `src/components/PlaylistPlayer.tsx` - 主要修改
   - 添加 `handlePlayPauseToggle`
   - 添加 `player-track-changed` 监听
   - 修复进度条数据源

2. 可能需要检查：
   - `src/components/player/ProgressBar.tsx`
   - `src/components/player/PlayerControls.tsx`

### 相关文档
- `docs/对话总结-混合播放器实现.md` - 完整对话总结
- `docs/混合播放器-最终问题清单.md` - 问题清单

---

**准备好了！开始修复吧！** 🎊

详细的上下文和技术细节都在 `docs/对话总结-混合播放器实现.md` 中。





