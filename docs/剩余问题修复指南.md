# å‰©ä½™é—®é¢˜ä¿®å¤æŒ‡å—

> ç»™æ–°å¯¹è¯çª—å£çš„å¿«é€Ÿä¿®å¤æ‰‹å†Œ  
> é¢„è®¡ä¿®å¤æ—¶é—´: 30-60 åˆ†é’Ÿ

---

## âš ï¸ é—®é¢˜ 1: æš‚åœåæ’­æ”¾ä»å¤´å¼€å§‹

### å¤ç°
1. æ’­æ”¾æ­Œæ›²
2. ç­‰å¾… 1 ç§’ï¼ˆå¼•æ“åˆ‡æ¢å®Œæˆï¼‰
3. ç‚¹å‡»æš‚åœ
4. ç‚¹å‡»æ’­æ”¾ â†’ **ä» 0:00 å¼€å§‹**ï¼ˆé”™è¯¯ï¼ï¼‰

### åŸå› 
```typescript
// src/components/PlaylistPlayer.tsx:254
const handlePlay = async () => {
  await hybridPlayer.play(currentTrack, []);  // â† é‡æ–°æ’­æ”¾ï¼
};
```

æ’­æ”¾æŒ‰é’®è°ƒç”¨äº† `handlePlay()`ï¼Œè¿™ä¼š**é‡æ–°æ’­æ”¾**è€Œä¸æ˜¯**ç»§ç»­æ’­æ”¾**ã€‚

### ä¿®å¤æ–¹æ¡ˆ

#### æ­¥éª¤ 1: åˆ›å»ºç»Ÿä¸€çš„æ’­æ”¾/æš‚åœåˆ‡æ¢å‡½æ•°

```typescript
// åœ¨ PlaylistPlayer.tsx ä¸­æ·»åŠ 
const handlePlayPauseToggle = async () => {
  try {
    const { hybridPlayer } = await import('../services/hybridPlayer');
    
    if (playerState.is_playing) {
      // æ­£åœ¨æ’­æ”¾ â†’ æš‚åœ
      await hybridPlayer.pause();
      console.log('â¸ï¸ [PlaylistPlayer] å·²æš‚åœ');
    } else if (playerState.current_track) {
      // æœ‰æ­Œæ›²ä½†æš‚åœ â†’ ç»§ç»­æ’­æ”¾
      await hybridPlayer.resume();
      console.log('â–¶ï¸ [PlaylistPlayer] å·²ç»§ç»­æ’­æ”¾');
    }
  } catch (error) {
    console.error('æ’­æ”¾/æš‚åœåˆ‡æ¢å¤±è´¥:', error);
  }
};
```

#### æ­¥éª¤ 2: æ‰¾åˆ°æ’­æ”¾æŒ‰é’®å¹¶æ›¿æ¢

æœç´¢ï¼š
```bash
grep -n "onClick.*handlePlay\|handlePlay\|handlePause" src/components/PlaylistPlayer.tsx
```

æˆ–è€…æœç´¢æ’­æ”¾/æš‚åœæŒ‰é’®çš„ JSXï¼š
```tsx
{isPlaying ? (
  // æš‚åœæŒ‰é’®
  <button onClick={handlePause}>...</button>
) : (
  // æ’­æ”¾æŒ‰é’®
  <button onClick={handlePlay}>...</button>  â† æ”¹è¿™é‡Œ
)}
```

æ›¿æ¢ä¸ºï¼š
```tsx
<button onClick={handlePlayPauseToggle}>...</button>
```

---

## âš ï¸ é—®é¢˜ 2: ä¸‹ä¸€æ›²åæ’­æ”¾é”™è¯¯æ­Œæ›²

### å¤ç°
1. æ’­æ”¾æ­Œæ›² A
2. ç‚¹å‡»ä¸‹ä¸€æ›² â†’ æ’­æ”¾æ­Œæ›² B
3. ç‚¹å‡»æš‚åœ
4. ç‚¹å‡»æ’­æ”¾ â†’ **æ’­æ”¾æ­Œæ›² A**ï¼ˆåº”è¯¥æ’­æ”¾ Bï¼‰

### åŸå› 
`currentTrack` state æ²¡æœ‰ç›‘å¬ Rust çš„ `player-track-changed` äº‹ä»¶ã€‚

### ä¿®å¤æ–¹æ¡ˆ

åœ¨ `PlaylistPlayer.tsx` ä¸­æ·»åŠ äº‹ä»¶ç›‘å¬ï¼š

```typescript
// åœ¨ useEffect åŒºåŸŸæ·»åŠ 
useEffect(() => {
  const unlistenTrackChanged = listen('player-track-changed', (event: any) => {
    const newTrack = event.payload;
    if (newTrack) {
      setCurrentTrack(newTrack);
      console.log('ğŸ”„ [PlaylistPlayer] currentTrack å·²åŒæ­¥:', newTrack.title);
    }
  });
  
  return () => {
    unlistenTrackChanged.then(fn => fn());
  };
}, []);
```

**ä½ç½®**ï¼šåœ¨ç°æœ‰çš„ `useEffect` é™„è¿‘æ·»åŠ ï¼ˆçº¦ line 150-250 åŒºåŸŸï¼‰

---

## âš ï¸ é—®é¢˜ 3: æ™®é€šç•Œé¢è¿›åº¦æ¡ä¸å®æ—¶æ›´æ–°

### ç—‡çŠ¶
- æ’­æ”¾æ—¶è¿›åº¦æ¡å¡é¡¿
- åªæœ‰æ­Œè¯æ›´æ–°ï¼ˆ1ç§’ä¸€æ¬¡ï¼‰æ—¶æ‰è·³ä¸€ä¸‹

### è¯Šæ–­æ­¥éª¤

#### æ­¥éª¤ 1: æ‰¾åˆ°è¿›åº¦æ¡ç»„ä»¶

æœç´¢ï¼š
```bash
grep -n "ProgressBar\|progress.*bar\|è¿›åº¦æ¡" src/components/PlaylistPlayer.tsx
```

æˆ–è€…æ£€æŸ¥ï¼š
- `src/components/player/ProgressBar.tsx`
- PlaylistPlayer çš„ JSX ä¸­çš„è¿›åº¦æ¡æ¸²æŸ“

#### æ­¥éª¤ 2: æ£€æŸ¥æ•°æ®æº

è¿›åº¦æ¡åº”è¯¥è¿™æ ·è·å–ä½ç½®ï¼š
```typescript
// æ­£ç¡®æ–¹å¼
const getPosition = usePlaybackPosition();
const position = getPosition();  // å®æ—¶è·å–

// é”™è¯¯æ–¹å¼
const position = playerState.position_ms;  // åªæœ‰äº‹ä»¶æ›´æ–°æ‰å˜
```

#### æ­¥éª¤ 3: ä¿®å¤

å¦‚æœè¿›åº¦æ¡ç»„ä»¶æ˜¯è¿™æ ·ï¼š
```typescript
<ProgressBar 
  position={playerState.position_ms}  // â† é”™è¯¯
  duration={track.duration_ms}
/>
```

æ”¹ä¸ºï¼š
```typescript
const getPosition = usePlaybackPosition();
const currentPosition = getPosition();  // æ¯å¸§è·å–

<ProgressBar 
  position={currentPosition}  // â† æ­£ç¡®
  duration={track.duration_ms}
/>
```

æˆ–è€…åœ¨ ProgressBar ç»„ä»¶å†…éƒ¨ï¼š
```typescript
// ProgressBar.tsx
import { usePlaybackPosition } from '../../contexts/PlaybackContext';

function ProgressBar() {
  const getPosition = usePlaybackPosition();
  const position = getPosition();  // å®æ—¶è·å–
  
  // ä½¿ç”¨ position...
}
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### å¯ç”¨ä½ç½®è°ƒè¯•æ—¥å¿—

ä¸´æ—¶å–æ¶ˆæ³¨é‡Š `PlaybackContext.tsx` ä¸­çš„è°ƒè¯•æ—¥å¿—ï¼š

```typescript
// line 119-120
if (Math.random() < 0.01) {
  console.log(`ğŸ“Š [PlaybackContext] Web Audio å¼•æ“ï¼Œä½ç½®: ${positionMs.toFixed(0)}ms`);
}

// line 137-138
if (Math.random() < 0.01) {
  console.log(`ğŸ“Š [PlaybackContext] Rust å¼•æ“ï¼Œä½ç½®: ${position.toFixed(0)}ms`);
}
```

æ”¹ä¸ºï¼š
```typescript
console.log(`ğŸ“Š [PlaybackContext] Web Audio å¼•æ“ï¼Œä½ç½®: ${positionMs.toFixed(0)}ms`);
console.log(`ğŸ“Š [PlaybackContext] Rust å¼•æ“ï¼Œä½ç½®: ${position.toFixed(0)}ms`);
```

ç„¶åè§‚å¯Ÿæ§åˆ¶å°æ˜¯å¦æ¯å¸§éƒ½æœ‰ä½ç½®æ›´æ–°ã€‚

---

## ğŸ“Š é¢„æœŸä¿®å¤åçš„æ•ˆæœ

### æµ‹è¯• 1: æš‚åœ/ç»§ç»­
```
æ’­æ”¾æ­Œæ›² â†’ å¬åˆ°å£°éŸ³
ç­‰å¾… 1 ç§’ â†’ å¼•æ“åˆ‡æ¢å®Œæˆ
ç‚¹å‡»æš‚åœ â†’ â¸ï¸ æš‚åœ
ç‚¹å‡»æ’­æ”¾ â†’ â–¶ï¸ ä»æš‚åœä½ç½®ç»§ç»­ï¼ˆä¸æ˜¯ä»å¤´ï¼‰
```

### æµ‹è¯• 2: ä¸‹ä¸€æ›²
```
æ’­æ”¾æ­Œæ›² A
ç‚¹å‡»ä¸‹ä¸€æ›² â†’ æ’­æ”¾æ­Œæ›² B
ç‚¹å‡»æš‚åœ
ç‚¹å‡»æ’­æ”¾ â†’ ç»§ç»­æ’­æ”¾æ­Œæ›² Bï¼ˆä¸æ˜¯ Aï¼‰
```

### æµ‹è¯• 3: è¿›åº¦æ¡
```
æ’­æ”¾æ­Œæ›²
è§‚å¯Ÿè¿›åº¦æ¡ â†’ æµç•…ç§»åŠ¨ï¼ˆ60fpsï¼‰
ä¸å†å¡é¡¿
```

---

## ğŸš€ ä¿®å¤å®Œæˆå

### Git æäº¤

```bash
git add .

git commit -m "fix: ğŸ› ä¿®å¤æ··åˆæ’­æ”¾å™¨å‰©ä½™é—®é¢˜ - v0.4.0.2

ä¿®å¤å†…å®¹ï¼š
âœ… æš‚åœåç»§ç»­æ’­æ”¾ï¼ˆä¸ä»å¤´å¼€å§‹ï¼‰
âœ… ä¸‹ä¸€æ›²åcurrentTrackåŒæ­¥
âœ… æ™®é€šç•Œé¢è¿›åº¦æ¡å®æ—¶æ›´æ–°

æŠ€æœ¯ç»†èŠ‚ï¼š
- ç»Ÿä¸€æ’­æ”¾/æš‚åœæŒ‰é’®é€»è¾‘
- ç›‘å¬player-track-changedåŒæ­¥state
- è¿›åº¦æ¡ä½¿ç”¨usePlaybackPosition

ç°åœ¨æ··åˆæ’­æ”¾å™¨100%å®Œæˆï¼"

git tag -a v0.4.0.2 -m "v0.4.0.2 - æ··åˆæ’­æ”¾å™¨å®Œæ•´ç‰ˆ

æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼Œ100%å®Œæˆ"
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. `src/components/PlaylistPlayer.tsx` - ä¸»è¦ä¿®æ”¹
   - æ·»åŠ  `handlePlayPauseToggle`
   - æ·»åŠ  `player-track-changed` ç›‘å¬
   - ä¿®å¤è¿›åº¦æ¡æ•°æ®æº

2. å¯èƒ½éœ€è¦æ£€æŸ¥ï¼š
   - `src/components/player/ProgressBar.tsx`
   - `src/components/player/PlayerControls.tsx`

### ç›¸å…³æ–‡æ¡£
- `docs/å¯¹è¯æ€»ç»“-æ··åˆæ’­æ”¾å™¨å®ç°.md` - å®Œæ•´å¯¹è¯æ€»ç»“
- `docs/æ··åˆæ’­æ”¾å™¨-æœ€ç»ˆé—®é¢˜æ¸…å•.md` - é—®é¢˜æ¸…å•

---

**å‡†å¤‡å¥½äº†ï¼å¼€å§‹ä¿®å¤å§ï¼** ğŸŠ

è¯¦ç»†çš„ä¸Šä¸‹æ–‡å’ŒæŠ€æœ¯ç»†èŠ‚éƒ½åœ¨ `docs/å¯¹è¯æ€»ç»“-æ··åˆæ’­æ”¾å™¨å®ç°.md` ä¸­ã€‚





