# æ’­æ”¾æ—¶é•¿ç»Ÿè®¡ä¼˜åŒ– - å®é™…æ’­æ”¾æ—¶é•¿è¿½è¸ª

## ğŸ¯ é—®é¢˜æè¿°

### åŸæœ‰é—®é¢˜
- **é”™è¯¯è¡Œä¸º**ï¼šç»Ÿè®¡ä½¿ç”¨æ­Œæ›²çš„å®Œæ•´æ—¶é•¿ï¼Œè€Œéå®é™…æ’­æ”¾æ—¶é•¿
- **åœºæ™¯ç¤ºä¾‹**ï¼š
  - ä¸€é¦–æ­Œ3åˆ†é’Ÿï¼Œç”¨æˆ·åªå¬äº†3ç§’å°±åˆ‡æ­Œ
  - ç³»ç»Ÿç»Ÿè®¡ï¼š3åˆ†é’Ÿ âŒ
  - åº”è¯¥ç»Ÿè®¡ï¼š3ç§’ âœ…

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒè®¾è®¡
é€šè¿‡ç›‘å¬æ’­æ”¾å™¨ä½ç½®å˜åŒ–äº‹ä»¶ï¼Œç²¾ç¡®è¿½è¸ªæ¯é¦–æ­Œçš„å®é™…æ’­æ”¾æ—¶é•¿ã€‚

```
å¼€å§‹æ’­æ”¾ âœ è®°å½•trackId + èµ·å§‹æ—¶é—´
    â†“
æŒç»­ç›‘å¬ âœ æ›´æ–°å½“å‰æ’­æ”¾ä½ç½®
    â†“
åˆ‡æ¢/åœæ­¢ âœ è®°å½•å®é™…æ’­æ”¾æ—¶é•¿ âœ åˆ·æ–°ç»Ÿè®¡
```

## ğŸ“Š æ•°æ®åº“Schemaæ‰©å±•

### `play_history` è¡¨
```sql
CREATE TABLE play_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    track_id INTEGER NOT NULL,
    played_at INTEGER NOT NULL,
    duration_played_ms INTEGER DEFAULT 0,  -- æ–°å¢ï¼šå®é™…æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
    FOREIGN KEY (track_id) REFERENCES tracks(id) ON DELETE CASCADE
);
```

**è¿ç§»é€»è¾‘**ï¼š
```sql
-- è‡ªåŠ¨ä¸ºå·²å­˜åœ¨çš„è¡¨æ·»åŠ å­—æ®µ
ALTER TABLE play_history ADD COLUMN duration_played_ms INTEGER DEFAULT 0;
```

## ğŸ¦€ åç«¯å®ç°

### 1. æ•°æ®åº“æ–¹æ³•

#### è®°å½•æ’­æ”¾å†å²
```rust
pub fn add_play_history(&self, track_id: i64, duration_played_ms: i64) -> Result<()> {
    let now = std::time::SystemTime::now()
        .duration_since(std::time::UNIX_EPOCH)
        .unwrap()
        .as_secs() as i64;
    
    self.conn.execute(
        "INSERT INTO play_history (track_id, played_at, duration_played_ms) VALUES (?1, ?2, ?3)",
        params![track_id, now, duration_played_ms],
    )?;
    Ok(())
}
```

#### ç»Ÿè®¡æŸ¥è¯¢
```rust
pub fn get_play_statistics(&self) -> Result<(i64, i64, i64)> {
    // æ€»æ’­æ”¾æ¬¡æ•°
    let total_plays: i64 = self.conn.query_row(
        "SELECT COUNT(*) FROM play_history",
        [], |row| row.get(0)
    )?;
    
    // ä¸åŒæ›²ç›®æ•°
    let unique_tracks: i64 = self.conn.query_row(
        "SELECT COUNT(DISTINCT track_id) FROM play_history",
        [], |row| row.get(0)
    )?;
    
    // âœ… ä½¿ç”¨å®é™…æ’­æ”¾æ—¶é•¿è€Œéæ›²ç›®å®Œæ•´æ—¶é•¿
    let total_duration_ms: i64 = self.conn.query_row(
        "SELECT COALESCE(SUM(duration_played_ms), 0) FROM play_history",
        [], |row| row.get(0)
    )?;
    
    Ok((total_plays, unique_tracks, total_duration_ms))
}
```

### 2. Tauriå‘½ä»¤

```rust
#[tauri::command]
async fn add_play_history(
    track_id: i64, 
    duration_played_ms: i64,  // æ–°å¢å‚æ•°
    state: State<'_, AppState>
) -> Result<(), String> {
    let db = state.inner().db.lock().map_err(|e| e.to_string())?;
    db.add_play_history(track_id, duration_played_ms)
        .map_err(|e| e.to_string())
}
```

## ğŸ“± å‰ç«¯å®ç°

### PlayHistoryContext æ ¸å¿ƒé€»è¾‘

#### 1. çŠ¶æ€è·Ÿè¸ª
```typescript
// ç”¨ ref è·Ÿè¸ªå½“å‰æ’­æ”¾ä¿¡æ¯ï¼ˆé¿å…è§¦å‘é‡æ¸²æŸ“ï¼‰
const currentPlayingRef = useRef<{
  trackId: number;
  startTime: number;
  lastPosition: number;  // å®æ—¶æ’­æ”¾ä½ç½®ï¼ˆæ¯«ç§’ï¼‰
} | null>(null);
```

#### 2. ç›‘å¬å™¨è®¾ç½®

**ç›‘å¬æ›²ç›®åˆ‡æ¢**ï¼š
```typescript
unlistenTrackChanged = await listen('player-track-changed', async (event) => {
  const trackData = event.payload;
  
  // 1ï¸âƒ£ å¦‚æœæœ‰ä¸Šä¸€é¦–æ­Œï¼Œå…ˆè®°å½•å®ƒçš„æ’­æ”¾æ—¶é•¿
  if (currentPlayingRef.current) {
    const playedDuration = currentPlayingRef.current.lastPosition;
    await recordPreviousTrack(playedDuration);
  }
  
  // 2ï¸âƒ£ è®°å½•æ–°æ›²ç›®çš„å¼€å§‹ä¿¡æ¯
  if (trackData && trackData.id) {
    currentPlayingRef.current = {
      trackId: trackData.id,
      startTime: Date.now(),
      lastPosition: 0,
    };
  }
  
  // 3ï¸âƒ£ å»¶è¿Ÿåˆ·æ–°UI
  setTimeout(async () => {
    // åˆ·æ–°å†å²åˆ—è¡¨å’Œç»Ÿè®¡æ•°æ®
  }, 1500);
});
```

**ç›‘å¬æ’­æ”¾ä½ç½®**ï¼š
```typescript
unlistenPosition = await listen('player-position-changed', (event) => {
  const positionMs = event.payload as number;
  // æŒç»­æ›´æ–°å½“å‰æ’­æ”¾ä½ç½®
  if (currentPlayingRef.current) {
    currentPlayingRef.current.lastPosition = positionMs;
  }
});
```

#### 3. è®°å½•æ’­æ”¾å†å²

```typescript
const recordPreviousTrack = useCallback(async (durationMs: number) => {
  const current = currentPlayingRef.current;
  if (!current) return;
  
  console.log(`ğŸ“ è®°å½•æ’­æ”¾: track_id=${current.trackId}, æ—¶é•¿=${durationMs}ms (${(durationMs/1000).toFixed(1)}ç§’)`);
  
  await invoke('add_play_history', { 
    trackId: current.trackId, 
    durationPlayedMs: durationMs  // å®é™…æ’­æ”¾æ—¶é•¿
  });
}, []);
```

#### 4. æ¸…ç†é€»è¾‘

```typescript
return () => {
  // ç»„ä»¶å¸è½½æ—¶ï¼Œè®°å½•å½“å‰æ­£åœ¨æ’­æ”¾çš„æ›²ç›®
  if (currentPlayingRef.current) {
    const playedDuration = currentPlayingRef.current.lastPosition;
    if (playedDuration > 0) {
      recordPreviousTrack(playedDuration);
    }
  }
  // æ¸…ç†ç›‘å¬å™¨
  if (unlistenTrackChanged) unlistenTrackChanged();
  if (unlistenPosition) unlistenPosition();
};
```

## ğŸ”„ å·¥ä½œæµç¨‹

### åœºæ™¯1ï¼šæ­£å¸¸åˆ‡æ­Œ
```
ç”¨æˆ·æ’­æ”¾æ­Œæ›²A
  â†“
position-changedäº‹ä»¶æŒç»­æ›´æ–° (0ms â†’ 1000ms â†’ 2000ms â†’ 3000ms)
  â†“
ç”¨æˆ·åˆ‡æ¢åˆ°æ­Œæ›²B
  â†“
track-changedäº‹ä»¶è§¦å‘
  â†“
è®°å½•æ­Œæ›²A: duration_played_ms = 3000ms âœ…
  â†“
å¼€å§‹è·Ÿè¸ªæ­Œæ›²B
```

### åœºæ™¯2ï¼šå¿«é€Ÿåˆ‡æ­Œ
```
ç”¨æˆ·æ’­æ”¾æ­Œæ›²A
  â†“
position: 0ms â†’ 500ms â†’ 1200ms
  â†“
ç”¨æˆ·åˆ‡æ¢åˆ°æ­Œæ›²B (åªå¬äº†1.2ç§’)
  â†“
è®°å½•æ­Œæ›²A: duration_played_ms = 1200ms âœ… (è€Œéå®Œæ•´çš„3åˆ†é’Ÿ)
  â†“
position: 0ms â†’ 2000ms
  â†“
ç”¨æˆ·åˆ‡æ¢åˆ°æ­Œæ›²C
  â†“
è®°å½•æ­Œæ›²B: duration_played_ms = 2000ms âœ…
```

### åœºæ™¯3ï¼šåº”ç”¨å…³é—­
```
ç”¨æˆ·æ­£åœ¨æ’­æ”¾æ­Œæ›²A
  â†“
position: 0ms â†’ 5000ms â†’ 10000ms
  â†“
ç”¨æˆ·å…³é—­åº”ç”¨
  â†“
cleanupå‡½æ•°è§¦å‘
  â†“
è®°å½•æ­Œæ›²A: duration_played_ms = 10000ms âœ…
```

## ğŸ“Š æ•°æ®å¯¹æ¯”

### ä¼˜åŒ–å‰
```
æ­Œæ›²: "Breathe" (duration_ms: 208000)
å®é™…æ’­æ”¾: 3ç§’å°±åˆ‡æ­Œäº†
ç»Ÿè®¡ç»“æœ: 208000ms (3åˆ†28ç§’) âŒ
```

### ä¼˜åŒ–å
```
æ­Œæ›²: "Breathe" (duration_ms: 208000)
å®é™…æ’­æ”¾: 3ç§’å°±åˆ‡æ­Œäº†
ç»Ÿè®¡ç»“æœ: 3000ms (3ç§’) âœ…
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯•1ï¼šçŸ­æ—¶æ’­æ”¾
1. æ’­æ”¾ä¸€é¦–3åˆ†é’Ÿçš„æ­Œæ›²
2. æ’­æ”¾5ç§’ååˆ‡æ­Œ
3. **éªŒè¯**ï¼šæ’­æ”¾è®°å½•æ˜¾ç¤º ~5ç§’

### æµ‹è¯•2ï¼šå®Œæ•´æ’­æ”¾
1. æ’­æ”¾ä¸€é¦–3åˆ†é’Ÿçš„æ­Œæ›²
2. å®Œæ•´å¬å®Œ
3. **éªŒè¯**ï¼šæ’­æ”¾è®°å½•æ˜¾ç¤º ~3åˆ†é’Ÿ

### æµ‹è¯•3ï¼šå¤šæ¬¡å¿«é€Ÿåˆ‡æ­Œ
1. è¿ç»­æ’­æ”¾5é¦–æ­Œï¼Œæ¯é¦–åªå¬3-5ç§’
2. **éªŒè¯**ï¼š
   - æ’­æ”¾æ¬¡æ•°ï¼š5æ¬¡
   - ç´¯è®¡æ—¶é•¿ï¼šçº¦15-25ç§’ï¼ˆè€Œéæ­Œæ›²æ€»æ—¶é•¿ï¼‰

### æµ‹è¯•4ï¼šç»Ÿè®¡æ•°æ®å‡†ç¡®æ€§
1. æ’­æ”¾3é¦–æ­Œï¼š
   - æ­Œæ›²A (3åˆ†é’Ÿ) - å¬äº†10ç§’
   - æ­Œæ›²B (4åˆ†é’Ÿ) - å¬äº†å®Œæ•´çš„4åˆ†é’Ÿ
   - æ­Œæ›²C (5åˆ†é’Ÿ) - å¬äº†30ç§’
2. **éªŒè¯**ï¼š
   - æ€»æ’­æ”¾æ¬¡æ•°ï¼š3
   - ç´¯è®¡æ—¶é•¿ï¼š10ç§’ + 4åˆ†é’Ÿ + 30ç§’ = 4åˆ†40ç§’ âœ…

## ğŸ“ æ—¥å¿—è¾“å‡ºç¤ºä¾‹

### æ­£å¸¸å·¥ä½œæ—¥å¿—
```
[PlayHistoryContext] ğŸµ æ£€æµ‹åˆ°æ›²ç›®åˆ‡æ¢: {id: 123, title: "Song A"}
[PlayHistoryContext] ğŸ“ è®°å½•æ’­æ”¾: track_id=122, æ—¶é•¿=3245ms (3.2ç§’)
[PlayHistoryContext] âœ… æ’­æ”¾å†å²å·²è®°å½•
[PlayHistoryContext] ğŸ†• å¼€å§‹è·Ÿè¸ªæ–°æ›²ç›®: 123
[PlayHistoryContext] ğŸ”„ åˆ·æ–°æ’­æ”¾å†å²å’Œç»Ÿè®¡æ•°æ®
[PlayHistoryContext] âœ… æ•°æ®åˆ·æ–°å®Œæˆ
```

### å¿«é€Ÿåˆ‡æ­Œæ—¥å¿—
```
[PlayHistoryContext] ğŸµ æ£€æµ‹åˆ°æ›²ç›®åˆ‡æ¢: {id: 124}
[PlayHistoryContext] ğŸ“ è®°å½•æ’­æ”¾: track_id=123, æ—¶é•¿=892ms (0.9ç§’)  âœ… åªå¬äº†ä¸åˆ°1ç§’
[PlayHistoryContext] âœ… æ’­æ”¾å†å²å·²è®°å½•
```

## âœ¨ ä¼˜åŒ–æ•ˆæœ

### æ•°æ®å‡†ç¡®æ€§
- âœ… ç²¾ç¡®è®°å½•æ¯é¦–æ­Œçš„å®é™…æ’­æ”¾æ—¶é•¿
- âœ… ç»Ÿè®¡æ•°æ®åæ˜ çœŸå®å¬æ­Œä¹ æƒ¯
- âœ… æ”¯æŒå¿«é€Ÿåˆ‡æ­Œåœºæ™¯

### ç”¨æˆ·ä½“éªŒ
- âœ… æ’­æ”¾æ—¶é•¿ç»Ÿè®¡æ›´æœ‰æ„ä¹‰
- âœ… èƒ½çœ‹å‡ºçœŸæ­£å–œæ¬¢çš„æ­Œæ›²ï¼ˆæ’­æ”¾æ—¶é•¿é•¿ï¼‰
- âœ… æ•°æ®åˆ†ææ›´å‡†ç¡®

### æ€§èƒ½å½±å“
- âœ… position-changed äº‹ä»¶ä»…æ›´æ–° refï¼Œä¸è§¦å‘é‡æ¸²æŸ“
- âœ… è®°å½•æ“ä½œå¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡UI
- âœ… é˜²æŠ–æœºåˆ¶é¿å…é¢‘ç¹åˆ·æ–°

## ğŸ” æŠ€æœ¯äº®ç‚¹

1. **ç²¾ç¡®è¿½è¸ª**ï¼šç›‘å¬ `player-position-changed` äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°æ’­æ”¾ä½ç½®
2. **æ— æ€§èƒ½æŸè€—**ï¼šä½¿ç”¨ `useRef` è€Œé `useState`ï¼Œé¿å…é¢‘ç¹é‡æ¸²æŸ“
3. **å®Œæ•´è¦†ç›–**ï¼šå¤„ç†åˆ‡æ­Œã€å…³é—­åº”ç”¨ç­‰æ‰€æœ‰åœºæ™¯
4. **é™çº§å…¼å®¹**ï¼šå·²æœ‰æ•°æ®è‡ªåŠ¨è¿ç§»ï¼ˆé»˜è®¤0msï¼‰

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### åç«¯
- âœ… `src-tauri/src/db.rs`
  - æ·»åŠ  `duration_played_ms` å­—æ®µåˆ° schema
  - æ·»åŠ å­—æ®µè¿ç§»é€»è¾‘
  - ä¿®æ”¹ `add_play_history` æ–¹æ³•
  - ä¿®æ”¹ `get_play_statistics` æŸ¥è¯¢

- âœ… `src-tauri/src/lib.rs`
  - ä¿®æ”¹ `add_play_history` å‘½ä»¤æ¥å—æ—¶é•¿å‚æ•°

### å‰ç«¯
- âœ… `src/contexts/PlayHistoryContext.tsx`
  - æ·»åŠ  `currentPlayingRef` è·Ÿè¸ªå½“å‰æ’­æ”¾
  - æ·»åŠ  `recordPreviousTrack` æ–¹æ³•
  - ç›‘å¬ `player-position-changed` äº‹ä»¶
  - ä¿®æ”¹ `player-track-changed` äº‹ä»¶å¤„ç†
  - æ·»åŠ æ¸…ç†é€»è¾‘

## ğŸ¯ éªŒæ”¶æ ‡å‡†

- [ ] çŸ­æ—¶æ’­æ”¾ï¼ˆ<10ç§’ï¼‰ç»Ÿè®¡å‡†ç¡®
- [ ] å®Œæ•´æ’­æ”¾ç»Ÿè®¡å‡†ç¡®
- [ ] å¿«é€Ÿåˆ‡æ­Œæ¯é¦–éƒ½è®°å½•æ­£ç¡®æ—¶é•¿
- [ ] å…³é—­åº”ç”¨å‰è®°å½•å½“å‰æ’­æ”¾
- [ ] æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤ºå®é™…æ’­æ”¾æ—¶é•¿
- [ ] ç»Ÿè®¡æ•°æ®ä¸­"æ€»æ’­æ”¾æ—¶é•¿"å‡†ç¡®
- [ ] æ€§èƒ½æ— æ˜æ˜¾å½±å“ï¼ˆä½¿ç”¨refé¿å…é‡æ¸²æŸ“ï¼‰

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **æš‚åœå¤„ç†**ï¼šå½“å‰åªç»Ÿè®¡æ’­æ”¾æ—¶é•¿ï¼Œæœªæ‰£é™¤æš‚åœæ—¶é—´
2. **æœ€å°æ’­æ”¾æ—¶é•¿**ï¼šå¯è®¾ç½®é˜ˆå€¼ï¼ˆå¦‚<3ç§’ä¸è®°å½•ï¼‰
3. **æ’­æ”¾å®Œæˆåº¦**ï¼šè®°å½•æ’­æ”¾è¿›åº¦ç™¾åˆ†æ¯”
4. **æ’­æ”¾æ¨¡å¼åˆ†æ**ï¼šåˆ†æç”¨æˆ·æ˜¯å¦ç»å¸¸è·³è¿‡æŸäº›æ­Œæ›²


