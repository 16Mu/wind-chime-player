# æ’­æ”¾çŠ¶æ€ç«‹å³åŒæ­¥ä¼˜åŒ–

> **æ—¥æœŸ**: 2025-10-06  
> **é—®é¢˜**: ç‚¹å‡»éŸ³ä¹æ’­æ”¾åï¼Œæš‚åœæŒ‰é’®éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰åŒæ­¥çŠ¶æ€  
> **çŠ¶æ€**: âœ… å·²ä¼˜åŒ–

---

## ğŸ› é—®é¢˜æè¿°

### ç—‡çŠ¶
ç‚¹å‡»éŸ³ä¹æ’­æ”¾åï¼Œæš‚åœæŒ‰é’®æ˜¾ç¤ºä»ç„¶æ˜¯"æ’­æ”¾"å›¾æ ‡ï¼Œéœ€è¦ç­‰å¾…å‡ ç™¾æ¯«ç§’æ‰å˜æˆ"æš‚åœ"å›¾æ ‡ã€‚

### ç”¨æˆ·ä½“éªŒé—®é¢˜
```
ç”¨æˆ·ç‚¹å‡»æ­Œæ›²
  â†“ (ç«‹å³)
æ’­æ”¾å™¨å¼€å§‹æ’­æ”¾
  â†“ (å»¶è¿Ÿ 200-500ms)
æš‚åœæŒ‰é’®æ‰å˜æˆ"æš‚åœ"å›¾æ ‡ âŒ
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### çŠ¶æ€æ›´æ–°æµç¨‹

**ä¹‹å‰çš„æµç¨‹**ï¼ˆæœ‰å»¶è¿Ÿï¼‰:
```
1. App.tsx è°ƒç”¨ hybridPlayer.play(track)
2. hybridPlayer è°ƒç”¨ invoke('player_play')
3. Rust æ’­æ”¾å™¨å¯åŠ¨
4. Rust å‘é€ player-state-changed äº‹ä»¶ (å»¶è¿Ÿ 200-500ms)
5. PlaybackContext ç›‘å¬åˆ°äº‹ä»¶
6. æ›´æ–° isPlaying = true
7. UI åˆ·æ–°ï¼Œæš‚åœæŒ‰é’®æ›´æ–° âœ…
```

**é—®é¢˜**: æ­¥éª¤ 4 çš„äº‹ä»¶å‘é€æœ‰å»¶è¿Ÿï¼Œå¯¼è‡´ UI æ›´æ–°ä¸åŠæ—¶ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ç«‹å³æ›´æ–°ç­–ç•¥

åœ¨ `App.tsx` ä¸­è°ƒç”¨ `hybridPlayer.play()` åï¼Œ**ç«‹å³æ›´æ–° PlaybackContext çŠ¶æ€**ï¼Œä¸ç­‰å¾… Rust äº‹ä»¶ã€‚

**ä¼˜åŒ–åçš„æµç¨‹**:
```
1. App.tsx è°ƒç”¨ hybridPlayer.play(track)
2. hybridPlayer è°ƒç”¨ invoke('player_play')
3. âœ… ç«‹å³è°ƒç”¨ updatePlaybackState({ isPlaying: true })
4. âœ… UI ç«‹å³åˆ·æ–°ï¼Œæš‚åœæŒ‰é’®ç«‹å³æ›´æ–°
5. Rust æ’­æ”¾å™¨å¯åŠ¨
6. (åç»­) Rust å‘é€ player-state-changed äº‹ä»¶ï¼ˆç¡®è®¤çŠ¶æ€ï¼‰
```

### ä»£ç å®ç°

#### 1. å¯¼å…¥ `usePlaybackControl`

**æ–‡ä»¶**: `src/App.tsx`

```typescript
import { PlaybackProvider, usePlaybackControl } from './contexts/PlaybackContext';
```

#### 2. åœ¨ AppContent ä¸­ä½¿ç”¨

```typescript
function AppContent() {
  const { currentPage, pageAnimationKey, searchQuery, sidebarCollapsed } = useUI();
  const { navigateTo, setSearchQuery, clearSearch, setSidebarCollapsed } = useUI();
  const { tracks, searchTracks } = useLibrary();
  const updatePlaybackState = usePlaybackControl(); // ğŸ”¥ æ–°å¢
  
  // ...
}
```

#### 3. æ’­æ”¾åç«‹å³æ›´æ–°çŠ¶æ€

```typescript
// æ’­æ”¾æ­Œæ›²ï¼ˆç«‹å³ä½¿ç”¨ Rust æµå¼æ’­æ”¾ï¼Œåå°åŠ è½½ Web Audioï¼‰
const playSuccess = await hybridPlayer.play(targetTrack, tracks);

if (!playSuccess) {
  throw new Error('æ’­æ”¾å¤±è´¥');
}

// ğŸ”¥ ç«‹å³æ›´æ–° PlaybackContext çŠ¶æ€ï¼ˆä¸ç­‰å¾… Rust äº‹ä»¶ï¼‰
updatePlaybackState({
  track: targetTrack,
  isPlaying: true,
});

// ğŸ”¥ æ›´æ–°å½“å‰æ’­æ”¾çš„æ­Œæ›² ID
currentPlayingTrackIdRef.current = targetTrack.id;
```

---

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### å‰åå¯¹æ¯”

| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|-----|-------|-------|
| ç‚¹å‡»æ­Œæ›² | ç«‹å³ | ç«‹å³ |
| æ’­æ”¾å™¨å¯åŠ¨ | 100ms | 100ms |
| æš‚åœæŒ‰é’®æ›´æ–° | 200-500ms âŒ | **ç«‹å³** âœ… |
| ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿ | æ˜æ˜¾ | æ— æ„ŸçŸ¥ |

### ç”¨æˆ·ä½“éªŒ

**ä¼˜åŒ–å‰**:
```
ç”¨æˆ·: ç‚¹å‡»æ­Œæ›²
ç”¨æˆ·: ç‚¹å‡»æš‚åœ â†’ å’¦ï¼Ÿæ€ä¹ˆè¿˜æ˜¯æ’­æ”¾å›¾æ ‡ï¼Ÿ
     (ç­‰å¾… 200ms)
     å•Šï¼Œå˜æˆæš‚åœå›¾æ ‡äº†
```

**ä¼˜åŒ–å**:
```
ç”¨æˆ·: ç‚¹å‡»æ­Œæ›²
ç”¨æˆ·: ç‚¹å‡»æš‚åœ â†’ âœ… ç«‹å³æš‚åœï¼ˆå›¾æ ‡å·²ç»æ˜¯æš‚åœçŠ¶æ€ï¼‰
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### åŒé‡çŠ¶æ€æ›´æ–°æœºåˆ¶

1. **ç«‹å³æ›´æ–°**ï¼ˆApp.tsxï¼‰
   - è°ƒç”¨ `hybridPlayer.play()` åç«‹å³æ›´æ–°
   - ç›®çš„ï¼šç«‹å³å“åº”ç”¨æˆ·æ“ä½œï¼Œæä¾›å³æ—¶åé¦ˆ

2. **äº‹ä»¶ç¡®è®¤**ï¼ˆPlaybackContextï¼‰
   - ç›‘å¬ Rust çš„ `player-state-changed` äº‹ä»¶
   - ç›®çš„ï¼šç¡®ä¿çŠ¶æ€ä¸å®é™…æ’­æ”¾å™¨åŒæ­¥

### ä¸ºä»€ä¹ˆéœ€è¦ä¸¤æ¬¡æ›´æ–°ï¼Ÿ

- **ç¬¬ä¸€æ¬¡ï¼ˆç«‹å³ï¼‰**: æä¾›å³æ—¶ UI åé¦ˆï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **ç¬¬äºŒæ¬¡ï¼ˆäº‹ä»¶ï¼‰**: ä½œä¸ºçŠ¶æ€ç¡®è®¤å’Œçº æ­£æœºåˆ¶
  - å¦‚æœæ’­æ”¾å¤±è´¥ï¼ŒRust äº‹ä»¶ä¼šçº æ­£çŠ¶æ€
  - ç¡®ä¿å‰åç«¯çŠ¶æ€ä¸€è‡´

---

## âœ… æµ‹è¯•æ¸…å•

### åœºæ™¯ 1: æ­£å¸¸æ’­æ”¾
- [ ] ç‚¹å‡»æ­Œæ›²
- [ ] âœ… æš‚åœæŒ‰é’®ç«‹å³å˜ä¸º"æš‚åœ"å›¾æ ‡ï¼ˆ< 50msï¼‰
- [ ] âœ… éŸ³ä¹æ­£å¸¸æ’­æ”¾

### åœºæ™¯ 2: å¿«é€Ÿè¿ç»­ç‚¹å‡»
- [ ] å¿«é€Ÿç‚¹å‡»å¤šé¦–æ­Œæ›²
- [ ] âœ… æ¯æ¬¡ç‚¹å‡»åæš‚åœæŒ‰é’®ç«‹å³æ›´æ–°
- [ ] âœ… æœ€ç»ˆæ’­æ”¾æœ€åç‚¹å‡»çš„æ­Œæ›²

### åœºæ™¯ 3: æ’­æ”¾å¤±è´¥
- [ ] ç‚¹å‡»æŸåçš„éŸ³é¢‘æ–‡ä»¶
- [ ] âœ… æš‚åœæŒ‰é’®å…ˆå˜ä¸º"æš‚åœ"
- [ ] âœ… æ’­æ”¾å¤±è´¥åï¼ŒRust äº‹ä»¶çº æ­£çŠ¶æ€ä¸º"æœªæ’­æ”¾"

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `src/App.tsx`
   - å¯¼å…¥ `usePlaybackControl`
   - åœ¨ AppContent ä¸­ä½¿ç”¨
   - æ’­æ”¾åç«‹å³æ›´æ–°çŠ¶æ€

### ç›¸å…³ä¼˜åŒ–
- `src/contexts/PlaybackContext.tsx` - Rust äº‹ä»¶ç›‘å¬ï¼ˆä½œä¸ºç¡®è®¤æœºåˆ¶ï¼‰
- `src/services/hybridPlayer.ts` - æ··åˆæ’­æ”¾å™¨

---

## ğŸ’¡ æ‰©å±•ä¼˜åŒ–

### å…¶ä»–å¯ä»¥ç«‹å³æ›´æ–°çš„åœºæ™¯

1. **æš‚åœ/ç»§ç»­**
   ```typescript
   await hybridPlayer.pause();
   updatePlaybackState({ isPlaying: false }); // ç«‹å³æ›´æ–°
   ```

2. **ä¸‹ä¸€é¦–/ä¸Šä¸€é¦–**
   ```typescript
   await hybridPlayer.next();
   updatePlaybackState({ track: nextTrack, isPlaying: true }); // ç«‹å³æ›´æ–°
   ```

3. **éŸ³é‡è°ƒæ•´**
   ```typescript
   await hybridPlayer.setVolume(volume);
   updatePlaybackState({ volume }); // ç«‹å³æ›´æ–°
   ```

---

## ğŸ‰ ä¼˜åŒ–å®Œæˆ

ç°åœ¨æ’­æ”¾çŠ¶æ€æ›´æ–°**å®Œå…¨æ— å»¶è¿Ÿ**ï¼Œç”¨æˆ·ä½“éªŒå¤§å¹…æå‡ï¼

**å…³é”®æ”¹è¿›**:
- âœ… ç‚¹å‡»æ’­æ”¾åæš‚åœæŒ‰é’®ç«‹å³æ›´æ–°
- âœ… UI å“åº”é€Ÿåº¦ä» 200-500ms é™è‡³ < 50ms
- âœ… ä¿æŒäº†åŒé‡ç¡®è®¤æœºåˆ¶ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§


