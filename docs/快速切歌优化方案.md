# å¿«é€Ÿåˆ‡æ­Œä¼˜åŒ–æ–¹æ¡ˆï¼ˆæœ€ç»ˆç‰ˆï¼‰

## é—®é¢˜æè¿°

å½“ç”¨æˆ·åœ¨éŸ³ä¹æ’­æ”¾å™¨ä¸­**å¿«é€Ÿè¿ç»­ç‚¹å‡»å¤šé¦–æ­Œæ›²**æ—¶ï¼ˆä¾‹å¦‚åœ¨2-3ç§’å†…ç‚¹å‡»10-20é¦–ï¼‰ï¼Œå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š

1. **æ’­æ”¾å»¶è¿Ÿä¸¥é‡** - ç‚¹å‡»åè¦ç­‰å¾…åå‡ ç§’æ‰å¼€å§‹æ’­æ”¾
2. **æ’­æ”¾é”™è¯¯çš„æ­Œæ›²** - æœ€ç»ˆæ’­æ”¾çš„ä¸æ˜¯æœ€åç‚¹å‡»çš„æ­Œæ›²ï¼Œè€Œæ˜¯ä¸­é—´æŸé¦–
3. **åªå¬åˆ°éƒ¨åˆ†æ­Œæ›²** - å¿«é€Ÿç‚¹å‡»20é¦–æ­Œï¼Œä½†åªå¬åˆ°å…¶ä¸­3-5é¦–çš„ç‰‡æ®µ

### æ ¹æœ¬åŸå› åˆ†æï¼ˆæœ€ç»ˆç¡®è®¤ï¼‰

ç»è¿‡æ·±å…¥åˆ†æåç«¯ä»£ç å‘ç°**çœŸæ­£çš„æ ¹æœ¬åŸå› **ï¼š

#### âŒ ä¹‹å‰çš„é”™è¯¯åˆ†æï¼š
- ~~é˜²æŠ–æœºåˆ¶å¤±æ•ˆ~~
- ~~æ—¶é—´æˆ³æ£€æŸ¥æ— æ•ˆ~~
- ~~å‰ç«¯è¯·æ±‚è¿‡å¤š~~

#### âœ… çœŸæ­£çš„é—®é¢˜ï¼š**åç«¯å‘½ä»¤å¾ªç¯é˜»å¡**

```rust
// player_adapter.rs - å‘½ä»¤å¤„ç†å¾ªç¯
loop {
    let cmd = cmd_rx.try_recv()?;
    
    let mut c = core.lock().await;  // âŒ è·å–é”
    c.handle_command(cmd).await;    // âŒ æŒæœ‰é”å¤„ç†å‘½ä»¤ï¼ˆ1-2ç§’ï¼‰
    drop(c);                         // âŒ å¤„ç†å®Œæ‰é‡Šæ”¾é”
}
```

**é—®é¢˜**ï¼š
1. æ¯ä¸ªPlayå‘½ä»¤å¤„ç†éœ€è¦1-2ç§’ï¼ˆåŠ è½½éŸ³é¢‘ã€åˆå§‹åŒ–æ’­æ”¾ç­‰ï¼‰
2. å¤„ç†æœŸé—´æŒæœ‰`core`é”ï¼Œä¸‹ä¸€ä¸ªå‘½ä»¤å¿…é¡»ç­‰å¾…
3. å¿«é€Ÿç‚¹å‡»20é¦–æ­Œ = 20-40ç§’å»¶è¿Ÿï¼

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè€ç‰ˆæœ¬æ²¡é—®é¢˜**ï¼šè€ç‰ˆæœ¬å¯èƒ½æ²¡æœ‰è¿™ä¸ªMutexé”ï¼Œæˆ–ä½¿ç”¨äº†ä¸åŒçš„å¹¶å‘ç­–ç•¥ã€‚

## æœ€ç»ˆä¼˜åŒ–æ–¹æ¡ˆï¼ˆåç«¯å¹¶å‘å¤„ç†ï¼‰

### æ ¸å¿ƒç­–ç•¥ï¼šèŠ‚æµï¼ˆThrottleï¼‰+ å¾…å¤„ç†é˜Ÿåˆ—

**ä¸ºä»€ä¹ˆä¸ç”¨é˜²æŠ–ï¼ˆDebounceï¼‰ï¼Ÿ**
- é˜²æŠ–ä¼šç­‰å¾…ç”¨æˆ·åœæ­¢ç‚¹å‡»åæ‰æ‰§è¡Œ
- å¦‚æœç”¨æˆ·ç‚¹å‡»é—´éš” > é˜²æŠ–æ—¶é—´ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«å‘é€
- å®é™…æµ‹è¯•ï¼šç”¨æˆ·ç‚¹å‡»é—´éš” 300-700msï¼Œé˜²æŠ–å®Œå…¨å¤±æ•ˆ

**èŠ‚æµæœºåˆ¶å·¥ä½œåŸç†ï¼š**
1. **ç¬¬ä¸€æ¬¡ç‚¹å‡»**ï¼šç«‹å³æ‰§è¡Œæ’­æ”¾
2. **èŠ‚æµçª—å£å†…ï¼ˆ300msï¼‰çš„ç‚¹å‡»**ï¼šåªæ›´æ–°å¾…å¤„ç†è¯·æ±‚ï¼Œä¸æ‰§è¡Œ
3. **èŠ‚æµçª—å£ç»“æŸ**ï¼šæ‰§è¡Œæœ€åä¸€ä¸ªå¾…å¤„ç†è¯·æ±‚
4. **æ–°çš„èŠ‚æµçª—å£**ï¼šé‡å¤ä»¥ä¸Šæµç¨‹

### 1. å‰ç«¯ä¼˜åŒ–ï¼ˆ`src/App.tsx`ï¼‰

#### æ ¸å¿ƒå®ç°ï¼šèŠ‚æµæœºåˆ¶

```typescript
// å¾…å¤„ç†çš„æ’­æ”¾è¯·æ±‚ï¼ˆå§‹ç»ˆä¿å­˜æœ€æ–°çš„ï¼‰
const pendingPlayRef = useRef<{ trackId: number; timestamp: number } | null>(null);
const playThrottleRef = useRef<NodeJS.Timeout | null>(null);

const handleTrackSelect = useCallback(async (track: Track) => {
  const timestamp = Date.now();
  const requestId = ++lastRequestIdRef.current;
  
  // ç«‹å³æ›´æ–°UI
  setSelectedTrack(track);
  
  // ğŸ”§ å…³é”®ï¼šä¿å­˜æœ€æ–°çš„æ’­æ”¾è¯·æ±‚
  pendingPlayRef.current = { trackId: track.id, timestamp };
  
  // å¦‚æœå·²ç»æœ‰èŠ‚æµå®šæ—¶å™¨ï¼Œåªæ›´æ–°å¾…å¤„ç†è¯·æ±‚
  if (playThrottleRef.current) {
    console.log(`â° æ›´æ–°å¾…å¤„ç†è¯·æ±‚ï¼ˆèŠ‚æµä¸­ï¼‰`);
    return;
  }
  
  // ç«‹å³æ‰§è¡Œç¬¬ä¸€æ¬¡è¯·æ±‚
  await executePlay();
  
  // è®¾ç½®èŠ‚æµå®šæ—¶å™¨ï¼Œ300msåæ‰§è¡Œæœ€æ–°çš„å¾…å¤„ç†è¯·æ±‚
  playThrottleRef.current = setTimeout(async () => {
    playThrottleRef.current = null;
    if (pendingPlayRef.current) {
      await executePlay();
    }
  }, 300);
}, [tracks]);
```

**æ•ˆæœ**ï¼š
- âœ… ç¬¬ä¸€æ¬¡ç‚¹å‡»ç«‹å³å“åº”ï¼ˆæ— å»¶è¿Ÿï¼‰
- âœ… å¿«é€Ÿç‚¹å‡»æ—¶åªæ‰§è¡Œç¬¬ä¸€æ¬¡å’Œæœ€åä¸€æ¬¡
- âœ… ä¸­é—´çš„æ‰€æœ‰è¯·æ±‚è¢«è·³è¿‡

#### æ”¹è¿›ç‚¹2ï¼šæ­Œè¯åŠ è½½è¯·æ±‚æ ¡éªŒï¼ˆ`src/components/PlaylistPlayer.tsx`ï¼‰
```typescript
// æ·»åŠ æ­Œè¯è¯·æ±‚IDè¿½è¸ª
const lyricsRequestIdRef = useRef(0);

const loadLyrics = async (trackId: number, requestId: number) => {
  // åŠ è½½å®Œæˆåæ£€æŸ¥è¯·æ±‚æ˜¯å¦è¿‡æœŸ
  if (requestId !== lyricsRequestIdRef.current) {
    console.log(`â­ï¸ [LRC#${requestId}] æ­Œè¯è¯·æ±‚å·²è¿‡æœŸï¼Œè·³è¿‡`);
    return;
  }
  // æ›´æ–°æ­Œè¯
};
```

**æ•ˆæœ**ï¼šé¿å…æ˜¾ç¤ºé”™è¯¯æ­Œæ›²çš„æ­Œè¯

### 2. åç«¯ä¼˜åŒ–ï¼ˆ`src-tauri/src/player/core.rs`ï¼‰

#### æ”¹è¿›ç‚¹1ï¼šå‘½ä»¤å…¥å£å¤„ç«‹å³æ£€æŸ¥æ—¶é—´æˆ³
```rust
pub async fn handle_command(&mut self, command: PlayerCommand) -> Result<()> {
    match command {
        PlayerCommand::Play(track_id, timestamp) => {
            // ğŸ¯ å…³é”®ï¼šåœ¨å…¥å£å¤„ç«‹å³æ£€æŸ¥ï¼Œè¿‡æœŸè¯·æ±‚ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            let current_latest = self.latest_play_timestamp.load(Ordering::SeqCst);
            if timestamp < current_latest {
                println!("â­ï¸ [CORE] æ’­æ”¾è¯·æ±‚å·²è¿‡æœŸï¼ˆå…¥å£æ£€æŸ¥ï¼‰ï¼Œç«‹å³æ‹’ç»");
                return Ok(()); // ç›´æ¥è¿”å›
            }
            
            self.latest_play_timestamp.store(timestamp, Ordering::SeqCst);
            self.handle_play(track_id, timestamp).await
        }
        // ...
    }
}
```

**æ•ˆæœ**ï¼šè¿‡æœŸè¯·æ±‚åœ¨å…¥å£å°±è¢«æ‹’ç»ï¼Œä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œ

#### æ”¹è¿›ç‚¹2ï¼šç²¾ç®€æ—¶é—´æˆ³æ£€æŸ¥ç‚¹
```rust
async fn handle_play(&mut self, track_id: i64, timestamp: i64) -> Result<()> {
    // è·å–æ›²ç›®
    let track = self.playlist_handle.jump_to(track_id).await?;
    
    // âœ… æ£€æŸ¥ç‚¹1ï¼šè·å–æ›²ç›®å
    if timestamp < self.latest_play_timestamp.load(Ordering::SeqCst) {
        return Ok(());
    }
    
    // åœæ­¢å½“å‰æ’­æ”¾ï¼ˆå¦‚æœéœ€è¦ï¼‰
    // ...
    
    // âœ… æ£€æŸ¥ç‚¹2ï¼šæ’­æ”¾å‰æœ€åæ£€æŸ¥
    if timestamp < self.latest_play_timestamp.load(Ordering::SeqCst) {
        return Ok(());
    }
    
    // æ‰§è¡Œæ’­æ”¾
    self.playback_handle.play(track.clone()).await?;
}
```

**æ•ˆæœ**ï¼šç¡®ä¿åªæœ‰æœ€æ–°è¯·æ±‚ä¼šçœŸæ­£æ’­æ”¾

## ä½¿ç”¨è¯´æ˜

### å¦‚ä½•åº”ç”¨è¿™äº›ä¼˜åŒ–

1. **é‡æ–°ç¼–è¯‘é¡¹ç›®**ï¼š
   ```bash
   # åœæ­¢å½“å‰è¿è¡Œçš„åº”ç”¨
   # ç„¶åé‡æ–°ç¼–è¯‘
   npm run tauri dev
   # æˆ–
   npm run tauri build
   ```

2. **éªŒè¯ä¼˜åŒ–æ˜¯å¦ç”Ÿæ•ˆ**ï¼š
   - æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œåº”è¯¥èƒ½çœ‹åˆ° `"â­ï¸ [CORE] æ’­æ”¾è¯·æ±‚å·²è¿‡æœŸï¼ˆå…¥å£æ£€æŸ¥ï¼‰"` 
   - æŸ¥çœ‹å‰ç«¯æ—¥å¿—ï¼Œåº”è¯¥èƒ½çœ‹åˆ° `"â­ï¸ [LRC#X] æ­Œè¯è¯·æ±‚å·²è¿‡æœŸï¼Œè·³è¿‡"`

3. **æµ‹è¯•å¿«é€Ÿåˆ‡æ­Œ**ï¼š
   - å¿«é€Ÿè¿ç»­ç‚¹å‡»å¤šé¦–æ­Œæ›²ï¼ˆ2-3ç§’å†…ç‚¹å‡»10-20é¦–ï¼‰
   - åº”è¯¥åªæ’­æ”¾æœ€åç‚¹å‡»çš„é‚£é¦–æ­Œ
   - å»¶è¿Ÿåº”è¯¥æ˜¾è‘—é™ä½ï¼ˆ150msé˜²æŠ– + å°‘é‡å¤„ç†æ—¶é—´ï¼‰

## é¢„æœŸæ•ˆæœ

### ä¼˜åŒ–å‰
- âŒ æ‰€æœ‰è¯·æ±‚éƒ½è¢«å¤„ç†ï¼Œå¯¼è‡´ä¸¥é‡å»¶è¿Ÿï¼ˆ10-20ç§’ï¼‰
- âŒ æ’­æ”¾ä¸­é—´æŸé¦–æ­Œè€Œéæœ€åç‚¹å‡»çš„
- âŒ æ­Œè¯æ˜¾ç¤ºé”™è¯¯
- âŒ å¬åˆ°å¤šé¦–æ­Œæ›²çš„ç‰‡æ®µ

### ä¼˜åŒ–åï¼ˆèŠ‚æµæ–¹æ¡ˆï¼‰
- âœ… ç¬¬ä¸€æ¬¡ç‚¹å‡»ç«‹å³å“åº”ï¼ˆ0å»¶è¿Ÿï¼‰
- âœ… å¿«é€Ÿç‚¹å‡»æ—¶åªæ‰§è¡Œç¬¬ä¸€æ¬¡å’Œæœ€åä¸€æ¬¡
- âœ… ä¸­é—´çš„æ‰€æœ‰è¯·æ±‚è¢«è·³è¿‡ï¼ˆä¸å‘é€åˆ°åç«¯ï¼‰
- âœ… æ­Œè¯æ­£ç¡®è·Ÿéšå½“å‰æ’­æ”¾æ›²ç›®
- âœ… æœ€ç»ˆæ’­æ”¾æœ€åç‚¹å‡»çš„æ­Œæ›²

### æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åï¼ˆèŠ‚æµï¼‰ |
|------|--------|--------------|
| å¿«é€Ÿç‚¹å‡»20é¦–æ­Œ | å‘é€20ä¸ªè¯·æ±‚ï¼Œå»¶è¿Ÿ10-20ç§’ | å‘é€2-3ä¸ªè¯·æ±‚ï¼Œå»¶è¿Ÿ<1ç§’ |
| ç¬¬ä¸€æ¬¡ç‚¹å‡»å“åº” | ç«‹å³ | ç«‹å³ï¼ˆæ— å˜åŒ–ï¼‰ |
| æœ€åç‚¹å‡»åˆ°æ’­æ”¾ | ç­‰å¾…é˜Ÿåˆ—æ¸…ç©ºï¼ˆ10-20ç§’ï¼‰ | 300mså†…å“åº” |
| å¬åˆ°çš„æ­Œæ›²ç‰‡æ®µ | 3-5é¦–ï¼ˆæ··ä¹±ï¼‰ | 1-2é¦–ï¼ˆæ¸…æ™°ï¼‰ |

## æ—¥å¿—ç¤ºä¾‹

### æˆåŠŸçš„æ—¥å¿—æ¨¡å¼
```
ğŸ¯ [1759429697679] [REQ#1] ç‚¹å‡»æ’­æ”¾: 3 å’Œä½ 
â° [1759429697679] [REQ#1] æ¸…é™¤é˜²æŠ–å®šæ—¶å™¨
ğŸ¯ [1759429698782] [REQ#2] ç‚¹å‡»æ’­æ”¾: 5 æˆ’çƒŸ
â° [1759429698782] [REQ#2] æ¸…é™¤é˜²æŠ–å®šæ—¶å™¨
â­ï¸ [1759429697679] [REQ#1] å·²è¢«æ–°è¯·æ±‚å–ä»£ï¼Œè·³è¿‡
ğŸ¯ [1759429700307] [REQ#3] ç‚¹å‡»æ’­æ”¾: 7 å¸Œæœ›æœ‰ç¾½æ¯›å’Œç¿…è†€
â° [1759429700307] [REQ#3] æ¸…é™¤é˜²æŠ–å®šæ—¶å™¨
â­ï¸ [1759429698782] [REQ#2] å·²è¢«æ–°è¯·æ±‚å–ä»£ï¼Œè·³è¿‡
...ï¼ˆæœ€åï¼‰
â–¶ï¸ [1759429733892] [REQ#10] å‘é€ Play(8, 1759429733892)
```

åç«¯æ—¥å¿—ï¼š
```
ğŸ“¨ [CORE] å¤„ç†å‘½ä»¤: Play(3, 1759429697679)
â­ï¸ [CORE] æ’­æ”¾è¯·æ±‚å·²è¿‡æœŸï¼ˆå…¥å£æ£€æŸ¥: è¯·æ±‚=1759429697679, æœ€æ–°=1759429733892ï¼‰ï¼Œç«‹å³æ‹’ç»
...
ğŸ“¨ [CORE] å¤„ç†å‘½ä»¤: Play(8, 1759429733892)
â–¶ï¸ [CORE] å¤„ç†Playå‘½ä»¤: track_id=8, timestamp=1759429733892
âœ… [CORE] æ’­æ”¾å‘½ä»¤å¤„ç†å®Œæˆ
```

## æ³¨æ„äº‹é¡¹

1. **å¿…é¡»é‡æ–°ç¼–è¯‘æ‰èƒ½ç”Ÿæ•ˆ** - ä»£ç ä¿®æ”¹åéœ€è¦é‡å¯åº”ç”¨
2. **é˜²æŠ–æ—¶é—´å¯è°ƒæ•´** - å¦‚æœ150msæ„Ÿè§‰å“åº”æ…¢ï¼Œå¯ä»¥é™ä½åˆ°100ms
3. **æ—¶é—´æˆ³æœºåˆ¶** - ä½¿ç”¨`Date.now()`ç¡®ä¿æ¯ä¸ªè¯·æ±‚æœ‰å”¯ä¸€é€’å¢çš„æ—¶é—´æˆ³

## ç›¸å…³æ–‡ä»¶

- `src/App.tsx` - å‰ç«¯æ’­æ”¾è¯·æ±‚å¤„ç†
- `src/components/PlaylistPlayer.tsx` - æ­Œè¯åŠ è½½é€»è¾‘
- `src-tauri/src/player/core.rs` - åç«¯å‘½ä»¤å¤„ç†

