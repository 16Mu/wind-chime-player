# æš‚åœåŠŸèƒ½ä¿®å¤

> **æ—¥æœŸ**: 2025-10-06  
> **é—®é¢˜**: ç‚¹å‡»"ä¸‹ä¸€é¦–"åæ— æ³•æš‚åœæ’­æ”¾  
> **çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

### ç—‡çŠ¶
ç‚¹å‡»"ä¸‹ä¸€é¦–"åï¼Œæš‚åœæŒ‰é’®æ— å“åº”ï¼Œæ— æ³•æš‚åœæ’­æ”¾ã€‚

### å¤ç°æ­¥éª¤
```
1. æ’­æ”¾ä»»æ„æ­Œæ›²
2. ç‚¹å‡» "ä¸‹ä¸€é¦–"
3. ç‚¹å‡» "æš‚åœ" æŒ‰é’® â†’ æ— ååº”ï¼
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜åˆ†æ

PlaybackContext ä¸­**ç¼ºå°‘ Rust æ’­æ”¾å™¨äº‹ä»¶ç›‘å¬**ï¼Œå¯¼è‡´ `isPlaying` çŠ¶æ€ä¸æ›´æ–°ã€‚

**ä»£ç é—®é¢˜**:
```typescript
// src/contexts/PlaybackContext.tsx

// âŒ åªç›‘å¬äº† Web Audio çš„å›è°ƒ
await webAudioPlayer.initialize({
  onPlaybackStateChanged: (isPlaying) => {
    setState(prev => ({ ...prev, isPlaying }));
  },
  // ...
});

// âŒ æ²¡æœ‰ç›‘å¬ Rust çš„ player-state-changed äº‹ä»¶ï¼
```

**ç»“æœ**:
- å½“ä½¿ç”¨ Rust å¼•æ“æ’­æ”¾æ—¶ï¼ˆç‚¹å‡»"ä¸‹ä¸€é¦–"åçš„å‰ 1 ç§’ï¼‰ï¼Œ`isPlaying` çŠ¶æ€ä¸æ›´æ–°
- æš‚åœæŒ‰é’®çš„ `playerState.is_playing` å§‹ç»ˆä¸º `false`
- `handlePlayPauseToggle` é€»è¾‘é”™è¯¯ï¼Œè°ƒç”¨äº† `resume()` è€Œä¸æ˜¯ `pause()`

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ·»åŠ  Rust äº‹ä»¶ç›‘å¬

**æ–‡ä»¶**: `src/contexts/PlaybackContext.tsx`

æ·»åŠ å¯¹ Rust æ’­æ”¾å™¨äº‹ä»¶çš„ç›‘å¬ï¼š

```typescript
// ğŸ”¥ ç›‘å¬ Rust æ’­æ”¾å™¨äº‹ä»¶ï¼ˆå½“ä½¿ç”¨ Rust å¼•æ“æ—¶ï¼‰
useEffect(() => {
  const setupRustListeners = async () => {
    // ç›‘å¬æ’­æ”¾çŠ¶æ€å˜åŒ–
    const unlistenState = await listen('player-state-changed', (event: any) => {
      const rustState = event.payload as any;
      console.log('ğŸµ [PlaybackContext] Rust çŠ¶æ€å˜åŒ–:', rustState);
      
      setState(prev => ({
        ...prev,
        track: rustState.current_track || prev.track,
        isPlaying: rustState.is_playing ?? prev.isPlaying,
        volume: rustState.volume ?? prev.volume,
      }));
      
      const position = typeof rustState.position_ms === 'number' && !isNaN(rustState.position_ms)
        ? rustState.position_ms
        : 0;
      positionRef.current = position;
    });
    
    // ç›‘å¬æ›²ç›®å˜åŒ–
    const unlistenTrack = await listen('player-track-changed', (event: any) => {
      const newTrack = event.payload || null;
      console.log('ğŸµ [PlaybackContext] Rust æ›²ç›®å˜åŒ–:', newTrack?.title);
      setState(prev => ({ ...prev, track: newTrack }));
      positionRef.current = 0;
    });
    
    // ç›‘å¬ä½ç½®å˜åŒ–
    const unlistenPosition = await listen('player-position-changed', (event: any) => {
      positionRef.current = event.payload as number;
    });
    
    return () => {
      unlistenState();
      unlistenTrack();
      unlistenPosition();
    };
  };
  
  let cleanup: (() => void) | null = null;
  setupRustListeners().then(fn => { cleanup = fn; });
  
  return () => {
    if (cleanup) cleanup();
  };
}, []);
```

### å¯¼å…¥å¿…è¦çš„æ¨¡å—

```typescript
import { listen } from '@tauri-apps/api/event';
```

---

## ğŸ¯ ä¿®å¤åçš„æµç¨‹

### æš‚åœæµç¨‹
```
ç”¨æˆ·ç‚¹å‡» "ä¸‹ä¸€é¦–"
  â†“
Rust å¼€å§‹æ’­æ”¾æ–°æ­Œæ›²
  â†“
è§¦å‘ player-state-changed äº‹ä»¶ { is_playing: true }
  â†“
âœ… PlaybackContext ç›‘å¬åˆ°äº‹ä»¶ï¼Œæ›´æ–° isPlaying = true
  â†“
ç”¨æˆ·ç‚¹å‡» "æš‚åœ"
  â†“
handlePlayPauseToggle æ£€æŸ¥ playerState.is_playing === true
  â†“
âœ… è°ƒç”¨ hybridPlayer.pause()
  â†“
âœ… æ’­æ”¾æš‚åœæˆåŠŸ
```

---

## ğŸ“Š é¢„æœŸæ—¥å¿—

### æ­£å¸¸çš„æš‚åœæ—¥å¿—

```
ğŸµ [PlaybackContext] Rust çŠ¶æ€å˜åŒ–: { is_playing: true, ... }
ç”¨æˆ·ç‚¹å‡»æš‚åœ...
â¸ï¸ [HybridPlayer] æš‚åœ (Rust)
â¸ï¸ [PlaylistPlayer] å·²æš‚åœ
```

---

## âœ… æµ‹è¯•æ¸…å•

### åœºæ™¯ 1: Rust å¼•æ“ä¸‹æš‚åœ
- [ ] æ’­æ”¾æ­Œæ›²
- [ ] ç‚¹å‡» "ä¸‹ä¸€é¦–"
- [ ] ç«‹å³ç‚¹å‡» "æš‚åœ" â†’ âœ… åº”è¯¥æš‚åœ

### åœºæ™¯ 2: Web Audio å¼•æ“ä¸‹æš‚åœ
- [ ] æ’­æ”¾æ­Œæ›²
- [ ] ç­‰å¾… 1 ç§’ï¼ˆWeb Audio åˆ‡æ¢å®Œæˆï¼‰
- [ ] ç‚¹å‡» "æš‚åœ" â†’ âœ… åº”è¯¥æš‚åœ

### åœºæ™¯ 3: æš‚åœåç»§ç»­
- [ ] æ’­æ”¾å¹¶æš‚åœ
- [ ] ç‚¹å‡» "æ’­æ”¾" â†’ âœ… åº”è¯¥ç»§ç»­æ’­æ”¾

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `src/contexts/PlaybackContext.tsx`
   - æ·»åŠ  Rust äº‹ä»¶ç›‘å¬
   - å¯¼å…¥ `listen` from `@tauri-apps/api/event`

### ç›¸å…³é—®é¢˜
- ä¸‹ä¸€é¦–åæ— æ³• Seekï¼ˆå·²åœ¨å¦ä¸€ä¸ªæ–‡æ¡£ä¸­ä¿®å¤ï¼‰
- æ’­æ”¾çŠ¶æ€åŒæ­¥é—®é¢˜

---

**ä¿®å¤å®Œæˆï¼** ğŸ‰


