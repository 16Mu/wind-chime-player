# 暂停功能修复

> **日期**: 2025-10-06  
> **问题**: 点击"下一首"后无法暂停播放  
> **状态**: ✅ 已修复

---

## 🐛 问题描述

### 症状
点击"下一首"后，暂停按钮无响应，无法暂停播放。

### 复现步骤
```
1. 播放任意歌曲
2. 点击 "下一首"
3. 点击 "暂停" 按钮 → 无反应！
```

---

## 🔍 根本原因

### 问题分析

PlaybackContext 中**缺少 Rust 播放器事件监听**，导致 `isPlaying` 状态不更新。

**代码问题**:
```typescript
// src/contexts/PlaybackContext.tsx

// ❌ 只监听了 Web Audio 的回调
await webAudioPlayer.initialize({
  onPlaybackStateChanged: (isPlaying) => {
    setState(prev => ({ ...prev, isPlaying }));
  },
  // ...
});

// ❌ 没有监听 Rust 的 player-state-changed 事件！
```

**结果**:
- 当使用 Rust 引擎播放时（点击"下一首"后的前 1 秒），`isPlaying` 状态不更新
- 暂停按钮的 `playerState.is_playing` 始终为 `false`
- `handlePlayPauseToggle` 逻辑错误，调用了 `resume()` 而不是 `pause()`

---

## ✅ 解决方案

### 添加 Rust 事件监听

**文件**: `src/contexts/PlaybackContext.tsx`

添加对 Rust 播放器事件的监听：

```typescript
// 🔥 监听 Rust 播放器事件（当使用 Rust 引擎时）
useEffect(() => {
  const setupRustListeners = async () => {
    // 监听播放状态变化
    const unlistenState = await listen('player-state-changed', (event: any) => {
      const rustState = event.payload as any;
      console.log('🎵 [PlaybackContext] Rust 状态变化:', rustState);
      
      setState(prev => ({
        ...prev,
        track: rustState.current_track || prev.track,
        isPlaying: rustState.is_playing ?? prev.isPlaying,
        volume: rustState.volume ?? prev.volume,
      }));
      
      const position = typeof rustState.position_ms === 'number' && !isNaN(rustState.position_ms)
        ? rustState.position_ms
        : 0;
      positionRef.current = position;
    });
    
    // 监听曲目变化
    const unlistenTrack = await listen('player-track-changed', (event: any) => {
      const newTrack = event.payload || null;
      console.log('🎵 [PlaybackContext] Rust 曲目变化:', newTrack?.title);
      setState(prev => ({ ...prev, track: newTrack }));
      positionRef.current = 0;
    });
    
    // 监听位置变化
    const unlistenPosition = await listen('player-position-changed', (event: any) => {
      positionRef.current = event.payload as number;
    });
    
    return () => {
      unlistenState();
      unlistenTrack();
      unlistenPosition();
    };
  };
  
  let cleanup: (() => void) | null = null;
  setupRustListeners().then(fn => { cleanup = fn; });
  
  return () => {
    if (cleanup) cleanup();
  };
}, []);
```

### 导入必要的模块

```typescript
import { listen } from '@tauri-apps/api/event';
```

---

## 🎯 修复后的流程

### 暂停流程
```
用户点击 "下一首"
  ↓
Rust 开始播放新歌曲
  ↓
触发 player-state-changed 事件 { is_playing: true }
  ↓
✅ PlaybackContext 监听到事件，更新 isPlaying = true
  ↓
用户点击 "暂停"
  ↓
handlePlayPauseToggle 检查 playerState.is_playing === true
  ↓
✅ 调用 hybridPlayer.pause()
  ↓
✅ 播放暂停成功
```

---

## 📊 预期日志

### 正常的暂停日志

```
🎵 [PlaybackContext] Rust 状态变化: { is_playing: true, ... }
用户点击暂停...
⏸️ [HybridPlayer] 暂停 (Rust)
⏸️ [PlaylistPlayer] 已暂停
```

---

## ✅ 测试清单

### 场景 1: Rust 引擎下暂停
- [ ] 播放歌曲
- [ ] 点击 "下一首"
- [ ] 立即点击 "暂停" → ✅ 应该暂停

### 场景 2: Web Audio 引擎下暂停
- [ ] 播放歌曲
- [ ] 等待 1 秒（Web Audio 切换完成）
- [ ] 点击 "暂停" → ✅ 应该暂停

### 场景 3: 暂停后继续
- [ ] 播放并暂停
- [ ] 点击 "播放" → ✅ 应该继续播放

---

## 📝 相关文件

### 修改的文件
1. `src/contexts/PlaybackContext.tsx`
   - 添加 Rust 事件监听
   - 导入 `listen` from `@tauri-apps/api/event`

### 相关问题
- 下一首后无法 Seek（已在另一个文档中修复）
- 播放状态同步问题

---

**修复完成！** 🎉


