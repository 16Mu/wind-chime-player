# å¯¹è¯æ€»ç»“ - æ··åˆæ’­æ”¾å™¨å®ç°

> æ—¥æœŸ: 2025-10-06  
> å¯¹è¯ç›®æ ‡: å®ç°é«˜æ€§èƒ½éŸ³é¢‘æ’­æ”¾ï¼Œè§£å†³ seek å»¶è¿Ÿé—®é¢˜  
> å®Œæˆåº¦: 90%

---

## ğŸ“– èƒŒæ™¯å’Œç›®æ ‡

### åˆå§‹é—®é¢˜
ç”¨æˆ·å‘ç° **Rust åç«¯æ’­æ”¾å™¨è§£ç æ…¢**ï¼š
- FLAC æ–‡ä»¶è§£ç éœ€è¦ **5-8 ç§’**
- ç‚¹å‡»æ’­æ”¾åè¦ç­‰å¾ˆä¹…æ‰èƒ½å¬åˆ°å£°éŸ³
- Seek è·³è½¬å»¶è¿Ÿ 200-500ms

### å‚è€ƒé¡¹ç›®
é˜…è¯»äº† **https://github.com/asxez/MusicBox** (Electron éŸ³ä¹æ’­æ”¾å™¨)ï¼š
- ä½¿ç”¨ Web Audio API
- è§£ç é€Ÿåº¦å¿«ï¼ˆ100-500msï¼‰
- Seek 0 å»¶è¿Ÿï¼ˆçº¯å†…å­˜æ“ä½œï¼‰
- å®Œæ•´æ–‡ä»¶è§£ç åˆ°å†…å­˜

### æœ€ç»ˆæ–¹æ¡ˆ
**æ··åˆæ’­æ”¾å™¨æ¶æ„**ï¼ˆåŒå¼•æ“ï¼‰ï¼š
```
ç‚¹å‡»æ’­æ”¾
  â†“ (100ms)
Rust æµå¼æ’­æ”¾ â†’ ç”¨æˆ·ç«‹å³å¬åˆ°å£°éŸ³
  â†“ (åŒæ—¶è¿›è¡Œ)
Web Audio åå°åŠ è½½ï¼ˆ800msï¼‰
  â†“ (è‡ªåŠ¨)
å¼•æ“åˆ‡æ¢ â†’ æ”¯æŒ 0 å»¶è¿Ÿ seek
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯åŠ¨å¿«ï¼š100ms å¬åˆ°å£°éŸ³
- âœ… Seek å¿«ï¼šæœ€ç»ˆ < 10ms
- âœ… å…¼é¡¾é€Ÿåº¦ä¸ä½“éªŒ

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

#### 1. **Web Audio Player** (`src/services/webAudioPlayer.ts`)
- ä½¿ç”¨ Web Audio API è§£ç 
- å®Œæ•´æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼ˆAudioBufferï¼‰
- æ”¯æŒ 0 å»¶è¿Ÿ seek
- æ’­æ”¾ã€æš‚åœã€éŸ³é‡æ§åˆ¶

#### 2. **Hybrid Player** (`src/services/hybridPlayer.ts`)
- åŒå¼•æ“ç®¡ç†å™¨
- ä»»åŠ¡å–æ¶ˆæœºåˆ¶
- æ™ºèƒ½ seek è·¯ç”±
- è‡ªåŠ¨å¼•æ“åˆ‡æ¢

#### 3. **Playback Context** (`src/contexts/PlaybackContext.tsx`)
- çŠ¶æ€ç®¡ç†
- åŒå±‚ ref æ¨¡å¼è§£å†³é—­åŒ…é—®é¢˜
- æ™ºèƒ½ä½ç½®è·¯ç”±ï¼ˆæ ¹æ®å¼•æ“ï¼‰
- äº‹ä»¶ç›‘å¬å’ŒçŠ¶æ€åŒæ­¥

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### åç«¯ï¼ˆRustï¼‰

**æ–°å¢å‘½ä»¤** (`src-tauri/src/lib.rs`)ï¼š
1. `read_audio_file` - å¼‚æ­¥è¯»å–æ–‡ä»¶ï¼ˆæœªä½¿ç”¨ï¼Œå› ä¸ºæ”¹ç”¨ Tauri fs æ’ä»¶ï¼‰
2. `get_track` - è·å–æ­Œæ›²ä¿¡æ¯
3. `get_current_position` - è·å–æ’­æ”¾ä½ç½®ï¼ˆç”¨äºå¼•æ“åˆ‡æ¢ï¼‰

**PlayerCommand æ‰©å±•** (`src-tauri/src/player/types/commands.rs`)ï¼š
- `GetPosition(oneshot::Sender<Option<u64>>)` å˜ä½“

**PlayerCore å¤„ç†** (`src-tauri/src/player/core.rs`)ï¼š
- `handle_command` å¤„ç† `GetPosition`

**Playback Actor ä¿®æ”¹** (`src-tauri/src/player/actors/playback_actor.rs`)ï¼š
- æ¢å¤æµå¼æ’­æ”¾ï¼ˆä¸å†å®Œæ•´é¢„è§£ç ï¼‰
- æœ¬åœ°æ–‡ä»¶ï¼šæµå¼è§£ç ï¼Œç«‹å³æ’­æ”¾
- WebDAV æ–‡ä»¶ï¼šæµå¼æ’­æ”¾ï¼ˆå·²æœ‰ï¼‰

**ä¾èµ–**ï¼š
- `tauri-plugin-fs = "2"` (Cargo.toml)
- åˆå§‹åŒ– `tauri_plugin_fs::init()` (lib.rs)

**æƒé™** (`src-tauri/capabilities/default.json`)ï¼š
- `fs:default`
- `fs:allow-read-file`
- `fs:read-all`
- `fs:scope` with `**` path

---

### å‰ç«¯ï¼ˆTypeScriptï¼‰

**æ–°å¢æ¨¡å—**ï¼š

1. **`src/services/webAudioPlayer.ts`** (492 è¡Œ)
   - Web Audio API å®Œæ•´å°è£…
   - ä½¿ç”¨ Tauri fs æ’ä»¶è¯»å–æ–‡ä»¶
   - ä¸»è¦æ–¹æ³•ï¼š
     - `initialize()` - åˆå§‹åŒ–
     - `loadTrack()` - åŠ è½½æ­Œæ›²
     - `play()` - æ’­æ”¾
     - `pause()` - æš‚åœ
     - `stop()` - åœæ­¢
     - `seek()` - è·³è½¬ï¼ˆ0 å»¶è¿Ÿï¼‰
     - `setVolume()` - éŸ³é‡
     - `nextTrack()` / `previousTrack()` - åˆ‡æ­Œ

2. **`src/services/hybridPlayer.ts`** (428 è¡Œ)
   - åŒå¼•æ“ç®¡ç†å™¨
   - ä¸»è¦åŠŸèƒ½ï¼š
     - ç«‹å³å¯åŠ¨ Rust æµå¼æ’­æ”¾
     - åå°åŠ è½½ Web Audio
     - è‡ªåŠ¨æ— ç¼åˆ‡æ¢å¼•æ“
     - ä»»åŠ¡å–æ¶ˆæœºåˆ¶ï¼ˆé˜²æ­¢å¿«é€Ÿåˆ‡æ­Œå†²çªï¼‰
     - æ™ºèƒ½ seek è·¯ç”±
     - è¯¦ç»†æ—¶é—´è¿½è¸ªæ—¥å¿—

3. **`src/services/playbackControl.ts`**
   - ç»Ÿä¸€æ’­æ”¾æ§åˆ¶ APIï¼ˆå¤‡ç”¨ï¼Œæœªä½¿ç”¨ï¼‰

**ä¿®æ”¹çš„ç»„ä»¶**ï¼š

1. **`src/App.tsx`**
   - `handleTrackSelect` ä½¿ç”¨ `hybridPlayer.play()`
   - æ·»åŠ é˜²é‡å¤æ’­æ”¾é€»è¾‘
   - æ·»åŠ å®šæ—¶å™¨æ¸…ç†
   - æ·»åŠ å½“å‰æ’­æ”¾æ›²ç›®è¿½è¸ª

2. **`src/components/PlaylistPlayer.tsx`**
   - `handlePause` â†’ `hybridPlayer.pause()`
   - `handleResume` â†’ `hybridPlayer.resume()`
   - `handleNext` â†’ `hybridPlayer.next()`
   - `handlePrevious` â†’ `hybridPlayer.previous()`
   - `handleSeek` â†’ `hybridPlayer.seek()`
   - `handleVolumeChange` â†’ `hybridPlayer.setVolume()`
   - `handlePlay` â†’ `hybridPlayer.play([])`ï¼ˆä¿®å¤äº† tracks æœªå®šä¹‰ï¼‰
   - è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€æ›² â†’ `hybridPlayer.next()`

3. **`src/components/ImmersiveLyricsView.tsx`**
   - è¿›åº¦æ¡ seek â†’ `hybridPlayer.seek()`
   - æ­Œè¯ç‚¹å‡» seek â†’ `hybridPlayer.seek()`
   - æ’­æ”¾/æš‚åœæŒ‰é’® â†’ `hybridPlayer.pause/resume()`
   - ä¸‹ä¸€æ›²/ä¸Šä¸€æ›² â†’ `hybridPlayer.next/previous()`

4. **`src/components/LyricsDisplay.tsx`**
   - æ­Œè¯ç‚¹å‡» seek â†’ `hybridPlayer.seek()`

5. **`src/components/LibraryPage.tsx`**
   - æ’­æ”¾å…¨éƒ¨ â†’ `hybridPlayer.play()`

6. **`src/components/library/LibraryOverview.tsx`**
   - æ’­æ”¾æœ€è¿‘æ›²ç›® â†’ `hybridPlayer.play()`

7. **`src/contexts/PlaybackContext.tsx`** (å…³é”®ä¿®æ”¹)
   - åˆå§‹åŒ–æ··åˆæ’­æ”¾å™¨å’Œ Web Audio Player
   - åŒå±‚ ref æ¨¡å¼ï¼š`getPositionRef.current = () => {...}`
   - æ™ºèƒ½ä½ç½®è·¯ç”±ï¼ˆæ ¹æ®å¼•æ“é€‰æ‹©æ•°æ®æºï¼‰
   - **åªåœ¨ Rust å¼•æ“ä¸‹å¤„ç† Rust äº‹ä»¶**ï¼ˆé˜²æ­¢è¦†ç›–ï¼‰
   - å¼•æ“åˆ‡æ¢å›è°ƒ
   - rAF å¼ºåˆ¶ä½ç½®æ›´æ–°

**ä¾èµ–**ï¼š
- `@tauri-apps/plugin-fs@2.4.2` (package.json)

---

## ğŸ”§ å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. åŒå±‚ ref æ¨¡å¼ï¼ˆè§£å†³é—­åŒ…é—®é¢˜ï¼‰

```typescript
// PlaybackContext.tsx

// ç¬¬ä¸€å±‚ï¼šå®é™…å®ç°ï¼ˆæ¯æ¬¡æ¸²æŸ“éƒ½æ›´æ–°ï¼‰
getPositionRef.current = () => {
  if (currentEngineRef.current === 'webaudio' && webAudioPlayerRef.current) {
    return webAudioPlayerRef.current.getPosition() * 1000;
  }
  return positionRef.current;
};

// ç¬¬äºŒå±‚ï¼šç¨³å®šå¼•ç”¨ï¼ˆä¸å˜ï¼‰
const getPosition = useCallback(() => getPositionRef.current(), []);
```

**æ•ˆæœ**ï¼š
- å‡½æ•°å¼•ç”¨ç¨³å®šï¼ˆä¸å¯¼è‡´é‡æ¸²æŸ“ï¼‰
- æ€»æ˜¯è¿”å›æœ€æ–°å€¼ï¼ˆè®¿é—®æœ€æ–° refsï¼‰

---

### 2. å¼•æ“çŠ¶æ€è·¯ç”±

```typescript
// åªåœ¨ Rust å¼•æ“ä¸‹å¤„ç† Rust äº‹ä»¶
const unlistenPosition = listen('player-position-changed', (event) => {
  if (currentEngineRef.current === 'rust') {
    positionRef.current = event.payload;
  }
  // Web Audio å¼•æ“ä¸‹å¿½ç•¥
});

const unlistenState = listen('player-state-changed', (event) => {
  if (currentEngineRef.current === 'rust') {
    setState({ ...rustState });
  }
  // Web Audio å¼•æ“ä¸‹å¿½ç•¥
});
```

**é˜²æ­¢**ï¼š
- åœæ­¢ Rust æ—¶æŠŠ Web Audio çš„çŠ¶æ€ä¹Ÿè¦†ç›–äº†
- ä½ç½®å½’é›¶é—®é¢˜

---

### 3. ä»»åŠ¡å–æ¶ˆæœºåˆ¶

```typescript
// hybridPlayer.ts

async play(track) {
  // ğŸ”¥ å–æ¶ˆä¹‹å‰çš„åå°ä»»åŠ¡
  if (this.currentLoadingTask) {
    this.shouldCancelLoading = true;
    await this.currentLoadingTask.catch(() => {});
  }
  
  this.currentTrackId = track.id;
  this.shouldCancelLoading = false;
  
  // å¯åŠ¨æ–°ä»»åŠ¡
  this.currentLoadingTask = this.loadWebAudioInBackground(track);
}

async loadWebAudioInBackground(track) {
  const taskTrackId = track.id;
  
  // æ£€æŸ¥ç‚¹ 1
  if (this.currentTrackId !== taskTrackId) {
    console.log('ğŸš« ä»»åŠ¡å·²å–æ¶ˆ');
    return;
  }
  
  await webAudioPlayer.loadTrack(track);
  
  // æ£€æŸ¥ç‚¹ 2
  if (this.currentTrackId !== taskTrackId) {
    console.log('ğŸš« ä»»åŠ¡åœ¨è§£ç å®Œæˆåè¢«å–æ¶ˆ');
    return;
  }
  
  await this.switchToWebAudio();
}
```

**é˜²æ­¢**ï¼š
- å¿«é€Ÿåˆ‡æ­Œæ—¶å¤šä¸ªåå°ä»»åŠ¡å†²çª
- å¾ªç¯æ’­æ”¾/æš‚åœ

---

### 4. å¼•æ“åˆ‡æ¢æµç¨‹

```typescript
async switchToWebAudio() {
  // 1. è·å– Rust å½“å‰ä½ç½®
  const currentPosition = await invoke('get_current_position');
  
  // 2. åœæ­¢ Rust
  await invoke('player_stop');
  
  // 3. Web Audio ä»ç›¸åŒä½ç½®ç»§ç»­
  await webAudioPlayer.seek(currentPosition / 1000);
  await webAudioPlayer.play();
  
  // 4. æ›´æ–°å¼•æ“æ ‡å¿—
  this.currentEngine = 'webaudio';
  
  // 5. é€šçŸ¥ PlaybackContext
  onEngineSwitch('webaudio');
}
```

---

## ğŸ› å·²ä¿®å¤çš„é‡å¤§ Bug

### Bug 1: Rust å®Œæ•´é¢„è§£ç ï¼ˆ5 ç§’ç­‰å¾…ï¼‰
**ä¿®å¤**ï¼šæ¢å¤æµå¼æ’­æ”¾
```rust
// playback_actor.rs (line 328-340)
let decoder = AudioDecoder::new(&track.path);
let source = decoder.decode()?;  // æµå¼ï¼Œç«‹å³è¿”å›
Ok(Box::new(source))
```

### Bug 2: å¿«é€Ÿåˆ‡æ­Œå¤šä»»åŠ¡å†²çª
**ä¿®å¤**ï¼šä»»åŠ¡å–æ¶ˆæœºåˆ¶
- æ¯æ¬¡æ’­æ”¾æ–°æ­Œå–æ¶ˆæ—§ä»»åŠ¡
- å¤šç‚¹æœ‰æ•ˆæ€§æ£€æŸ¥

### Bug 3: ä¸‰ä¸ªéŸ³è½¨åŒæ—¶æ’­æ”¾
**ä¿®å¤**ï¼š
- PlaylistPlayer `handlePlay` æ›¿æ¢ä¸º `hybridPlayer.play()`
- ImmersiveLyricsView æ‰€æœ‰æŒ‰é’®æ›¿æ¢
- æ‰€æœ‰æ—§çš„ `invoke('player_*')` è°ƒç”¨æ›¿æ¢

### Bug 4: ä½ç½®è¢« Rust è¦†ç›–
**ä¿®å¤**ï¼š
```typescript
// åªåœ¨ Rust å¼•æ“ä¸‹æ›´æ–° positionRef
if (currentEngineRef.current === 'rust') {
  positionRef.current = event.payload;
}
```

### Bug 5: æ­Œæ›²åˆ‡æ¢å¼•æ“æœªé‡ç½®
**ä¿®å¤**ï¼š
```typescript
const unlistenTrack = listen('player-track-changed', (event) => {
  if (newTrack.id !== lastTrackIdRef.current) {
    currentEngineRef.current = 'rust';
    lastTrackIdRef.current = newTrack.id;
  }
});
```

### Bug 6-12: å…¶ä»–æ§åˆ¶æŒ‰é’®
å…¨éƒ¨æ›¿æ¢ä¸º `hybridPlayer` è°ƒç”¨

---

## âš ï¸ å‰©ä½™é—®é¢˜ï¼ˆ3ä¸ªï¼‰

### é—®é¢˜ 1: æš‚åœåæ’­æ”¾ä»å¤´å¼€å§‹

**å¤ç°æ­¥éª¤**ï¼š
1. æ’­æ”¾æ­Œæ›²
2. ç­‰å¾…å¼•æ“åˆ‡æ¢ï¼ˆ800msï¼‰
3. ç‚¹å‡»æš‚åœ
4. ç‚¹å‡»æ’­æ”¾ â†’ **ä» 0:00 å¼€å§‹**

**åŸå› **ï¼š
- æ’­æ”¾æŒ‰é’®è°ƒç”¨ `handlePlay()`
- `handlePlay()` è°ƒç”¨ `hybridPlayer.play(currentTrack, [])`
- è¿™æ˜¯**é‡æ–°æ’­æ”¾**ï¼Œè€Œä¸æ˜¯**ç»§ç»­æ’­æ”¾**

**æœŸæœ›**ï¼š
- æš‚åœåç‚¹å‡» â†’ è°ƒç”¨ `hybridPlayer.resume()`
- è€Œä¸æ˜¯ `hybridPlayer.play()`

**ä½ç½®**ï¼š
- `src/components/PlaylistPlayer.tsx:254`
- éœ€è¦åŒºåˆ†"æ’­æ”¾æ–°æ­Œ"å’Œ"ç»§ç»­æ’­æ”¾"

---

### é—®é¢˜ 2: ä¸‹ä¸€æ›²åæ’­æ”¾é”™è¯¯æ­Œæ›²

**å¤ç°æ­¥éª¤**ï¼š
1. æ’­æ”¾æ­Œæ›² A
2. è¿›å…¥æ²‰æµ¸å¼æ­Œè¯
3. ç‚¹å‡»ä¸‹ä¸€æ›² â†’ æ’­æ”¾æ­Œæ›² B
4. å›åˆ°æ™®é€šç•Œé¢
5. ç‚¹å‡»æ’­æ”¾ â†’ **æ’­æ”¾æ­Œæ›² A**ï¼ˆé”™è¯¯ï¼ï¼‰

**åŸå› **ï¼š
- `currentTrack` state æ²¡æœ‰ç›‘å¬ `player-track-changed` äº‹ä»¶
- ä¸‹ä¸€æ›²å Rust çš„å½“å‰æ­Œæ›²æ˜¯ B
- ä½† `currentTrack` è¿˜æ˜¯ A

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// PlaylistPlayer.tsx
useEffect(() => {
  const unlisten = listen('player-track-changed', (event) => {
    const newTrack = event.payload;
    setCurrentTrack(newTrack);  // â† åŒæ­¥ currentTrack
  });
  
  return () => unlisten.then(fn => fn());
}, []);
```

---

### é—®é¢˜ 3: æ™®é€šç•Œé¢è¿›åº¦æ¡ä¸å®æ—¶æ›´æ–°

**ç—‡çŠ¶**ï¼š
- æ’­æ”¾æ—¶è¿›åº¦æ¡å¡é¡¿
- åªæœ‰æ­Œè¯æ›´æ–°æ—¶æ‰è·³ä¸€ä¸‹

**å¯èƒ½åŸå› **ï¼š
- è¿›åº¦æ¡ç»„ä»¶ç›´æ¥è¯»å– `playerState.position_ms`
- è€Œä¸æ˜¯è°ƒç”¨ `getPosition()`

**éœ€è¦æ£€æŸ¥**ï¼š
- æ™®é€šç•Œé¢çš„è¿›åº¦æ¡ç»„ä»¶
- ç¡®ä¿ä½¿ç”¨ `usePlaybackPosition()` hook

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

### ä¿®æ”¹æ–‡ä»¶
- **åç«¯**: 5 ä¸ªæ–‡ä»¶
  - `src-tauri/src/lib.rs`
  - `src-tauri/src/player/types/commands.rs`
  - `src-tauri/src/player/core.rs`
  - `src-tauri/src/player/actors/playback_actor.rs`
  - `src-tauri/Cargo.toml`
  - `src-tauri/capabilities/default.json`

- **å‰ç«¯**: 10 ä¸ªæ–‡ä»¶
  - æ–°å¢ 3 ä¸ªï¼ˆwebAudioPlayer, hybridPlayer, playbackControlï¼‰
  - ä¿®æ”¹ 7 ä¸ªï¼ˆApp, PlaylistPlayer, ImmersiveLyricsView, LyricsDisplay, LibraryPage, LibraryOverview, PlaybackContextï¼‰

- **é…ç½®**: 2 ä¸ªæ–‡ä»¶
  - `package.json`
  - `README.md`

### ä»£ç è¡Œæ•°
- æ–°å¢ï¼š~1500 è¡Œ
- ä¿®æ”¹ï¼š~300 è¡Œ
- åˆ é™¤ï¼š~50 è¡Œ

---

## ğŸ¯ æ€§èƒ½æŒ‡æ ‡

### å®é™…æµ‹è¯•ç»“æœ

| æŒ‡æ ‡ | v0.4.0ï¼ˆæ—§ï¼‰ | v0.4.0.1ï¼ˆæ–°ï¼‰ | æå‡ |
|------|-------------|---------------|------|
| ç‚¹å‡»åˆ°å¬åˆ°å£°éŸ³ | 5-8 ç§’ | **100ms** | **50-80å€** |
| FLAC è§£ç  | 5-8 ç§’ | 800msï¼ˆåå°ï¼‰ | **6-10å€** |
| Seekï¼ˆRusté˜¶æ®µï¼‰ | 200-500ms | 200-500ms | - |
| Seekï¼ˆåˆ‡æ¢åï¼‰ | 200-500ms | **< 10ms** | **20-50å€** |
| å¼•æ“åˆ‡æ¢ | - | 800-1000ms | æ–°åŠŸèƒ½ |

### ç”¨æˆ·ä½“éªŒæ—¶é—´çº¿
```
T+0ms    - ç‚¹å‡»æ’­æ”¾
T+100ms  - ğŸ”Š å¬åˆ°å£°éŸ³ï¼ˆRustï¼‰
T+800ms  - âš¡ æ”¯æŒå¿«é€Ÿ seekï¼ˆWeb Audioï¼‰
```

---

## ğŸ“ é‡è¦ API

### hybridPlayer

```typescript
await hybridPlayer.initialize(callbacks);

await hybridPlayer.play(track, playlist);  // æ’­æ”¾æ–°æ­Œ
await hybridPlayer.pause();                // æš‚åœ
await hybridPlayer.resume();               // ç»§ç»­
await hybridPlayer.stop();                 // åœæ­¢
await hybridPlayer.seek(positionMs);       // Seek
await hybridPlayer.setVolume(volume);      // éŸ³é‡
await hybridPlayer.next();                 // ä¸‹ä¸€é¦–
await hybridPlayer.previous();             // ä¸Šä¸€é¦–

hybridPlayer.getCurrentEngine();           // è·å–å½“å‰å¼•æ“
hybridPlayer.isWebAudioEngineReady();      // Web Audio æ˜¯å¦å°±ç»ª
```

### PlaybackContext

```typescript
const state = usePlaybackState();          // æ’­æ”¾çŠ¶æ€
const getPosition = usePlaybackPosition(); // ä½ç½®getter
const position = getPosition();            // è·å–ä½ç½®
```

---

## ğŸ” è°ƒè¯•æ—¥å¿—

### æ­£å¸¸æ’­æ”¾æµç¨‹
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸµ [HybridPlayer] [15:35:54.765] T+0ms - æ’­æ”¾: æ­Œæ›²å (ID: X)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ T+0ms - ã€é˜¶æ®µ1ã€‘å¯åŠ¨ Rust æµå¼æ’­æ”¾...
âœ… T+100ms - Rust æ’­æ”¾å™¨å·²å¯åŠ¨
ğŸµ T+100ms - ğŸ”Š ç”¨æˆ·å¬åˆ°å£°éŸ³äº†ï¼
ğŸ’¾ T+100ms - ã€é˜¶æ®µ2ã€‘åå°åŠ è½½ Web Audio...
âœ… T+800ms - Web Audio åå°åŠ è½½å®Œæˆ
ğŸ”„ T+800ms - ã€é˜¶æ®µ3ã€‘å‡†å¤‡åˆ‡æ¢å¼•æ“...
ğŸ“Š T+804ms - è·å– Rust æ’­æ”¾ä½ç½®: 704ms
â¹ï¸ T+806ms - Rust æ’­æ”¾å™¨å·²åœæ­¢
âœ… T+806ms - Web Audio æ’­æ”¾å¯åŠ¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‰ T+806ms - å¼•æ“åˆ‡æ¢å®Œæˆï¼ Rust â†’ Web Audio
ğŸ¯ T+806ms - âš¡ ç°åœ¨æ”¯æŒ 0 å»¶è¿Ÿ seek (<10ms)ï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### å¿«é€Ÿåˆ‡æ­Œ
```
ğŸµ T+0ms - æ’­æ”¾: æ­Œæ›²1 (ID: 1)
âœ… T+100ms - ç”¨æˆ·å¬åˆ°å£°éŸ³
ğŸ’¾ T+100ms - åå°åŠ è½½ (track 1)...

ğŸš« æ£€æµ‹åˆ°æ–°æ’­æ”¾è¯·æ±‚ï¼Œå–æ¶ˆä¹‹å‰çš„åå°ä»»åŠ¡ (track 1)

ğŸµ T+0ms - æ’­æ”¾: æ­Œæ›²2 (ID: 2)
âœ… T+95ms - ç”¨æˆ·å¬åˆ°å£°éŸ³
ğŸ’¾ T+95ms - åå°åŠ è½½ (track 2)...

ğŸš« ä»»åŠ¡åœ¨è§£ç å®Œæˆåè¢«å–æ¶ˆ (track 1)

âœ… T+756ms - Web Audio åå°åŠ è½½å®Œæˆ (track 2)
ğŸ‰ T+762ms - å¼•æ“åˆ‡æ¢å®Œæˆï¼(track 2)
```

### Seek æ“ä½œ
```
âš¡ [HybridPlayer] Seek â†’ 30.00s [å¼•æ“: Rust] [è€—æ—¶: 245ms]
âš¡ [HybridPlayer] Seek â†’ 60.00s [å¼•æ“: Web Audio] [è€—æ—¶: 3ms] âœ¨ 0 å»¶è¿Ÿ!
```

---

## ğŸ“‚ ç›¸å…³æ–‡æ¡£

å·²åˆ›å»ºçš„æ–‡æ¡£ï¼š
1. `docs/Web-Audio-Player-å®ç°å®Œæˆ.md` - Web Audio æŠ€æœ¯å®ç°
2. `docs/æ··åˆæ’­æ”¾å™¨æ¶æ„è¯´æ˜.md` - æ¶æ„è®¾è®¡
3. `docs/æ··åˆæ’­æ”¾å™¨-é¢„æœŸæ—¥å¿—ç¤ºä¾‹.md` - æ—¥å¿—ç¤ºä¾‹
4. `docs/æ··åˆæ’­æ”¾å™¨-å·²ä¿®å¤é—®é¢˜.md` - å·²è§£å†³é—®é¢˜
5. `docs/æ··åˆæ’­æ”¾å™¨-é—®é¢˜è¯Šæ–­æŒ‡å—.md` - è¯Šæ–­æ­¥éª¤
6. `docs/æ··åˆæ’­æ”¾å™¨-å®ç°æ£€æŸ¥æ¸…å•.md` - å®Œæ•´æ€§æ£€æŸ¥
7. `docs/æ··åˆæ’­æ”¾å™¨-æœ€ç»ˆé—®é¢˜æ¸…å•.md` - å½“å‰çŠ¶æ€
8. `docs/CHANGELOG-v0.4.0.1.md` - ç‰ˆæœ¬æ—¥å¿—
9. `GIT-COMMANDS-v0.4.0.1.md` - Git å‘½ä»¤
10. `README.md` - æ›´æ–°äº†æŠ€æœ¯äº®ç‚¹ï¼ˆç§»é™¤äº†å¤–éƒ¨å‚è€ƒï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œï¼ˆæ–°å¯¹è¯çª—å£ï¼‰

### ç«‹å³ä¿®å¤ï¼ˆé¢„è®¡ 30 åˆ†é’Ÿï¼‰

#### ä¿®å¤ 1: æš‚åœ/ç»§ç»­é€»è¾‘
**æ–‡ä»¶**: `src/components/PlaylistPlayer.tsx`

éœ€è¦ä¿®æ”¹æ’­æ”¾æŒ‰é’®é€»è¾‘ï¼š
```typescript
// å½“å‰çš„é—®é¢˜ä»£ç ï¼ˆline 254ï¼‰
const handlePlay = async () => {
  await hybridPlayer.play(currentTrack, []);  // â† é‡æ–°æ’­æ”¾
};

// å»ºè®®ä¿®æ”¹ä¸º
const handlePlayPauseToggle = async () => {
  if (playerState.is_playing) {
    await hybridPlayer.pause();
  } else if (playerState.current_track) {
    await hybridPlayer.resume();  // â† ç»§ç»­æ’­æ”¾
  }
};
```

ç„¶åæ‰¾åˆ°æ’­æ”¾æŒ‰é’®çš„ `onClick` å¹¶æ›¿æ¢ã€‚

---

#### ä¿®å¤ 2: åŒæ­¥ currentTrack
**æ–‡ä»¶**: `src/components/PlaylistPlayer.tsx`

æ·»åŠ äº‹ä»¶ç›‘å¬ï¼š
```typescript
useEffect(() => {
  const unlisten = listen('player-track-changed', (event: any) => {
    const newTrack = event.payload;
    setCurrentTrack(newTrack);
    console.log('ğŸ”„ [PlaylistPlayer] currentTrack å·²åŒæ­¥:', newTrack?.title);
  });
  
  return () => {
    unlisten.then(fn => fn());
  };
}, []);
```

---

#### ä¿®å¤ 3: è¿›åº¦æ¡å®æ—¶æ›´æ–°
**æ–‡ä»¶**: æŸ¥æ‰¾æ™®é€šç•Œé¢çš„è¿›åº¦æ¡ç»„ä»¶

å¯èƒ½éœ€è¦æ£€æŸ¥ï¼š
- `src/components/PlaylistPlayer.tsx` ä¸­æ¸²æŸ“çš„è¿›åº¦æ¡
- ç¡®ä¿ä½¿ç”¨ `usePlaybackPosition()` hook
- æˆ–è€…æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„è¿›åº¦æ¡ç»„ä»¶

---

## ğŸ” å…³é”®ä»£ç ä½ç½®

### hybridPlayer çŠ¶æ€
- å½“å‰å¼•æ“ï¼š`hybridPlayer.currentEngine`
- Web Audio å°±ç»ªï¼š`hybridPlayer.isWebAudioReady`
- å½“å‰æ­Œæ›² IDï¼š`hybridPlayer.currentTrackId`

### PlaybackContext refs
- å¼•æ“æ ‡å¿—ï¼š`currentEngineRef.current`
- Web Audio å¼•ç”¨ï¼š`webAudioPlayerRef.current`
- ä¸Šä¸€é¦–æ­Œ IDï¼š`lastTrackIdRef.current`

### å…³é”®æ–¹æ³•
- è·å–ä½ç½®ï¼š`getPositionRef.current()`
- æ™ºèƒ½è·¯ç”±ï¼šæ ¹æ® `currentEngineRef.current` é€‰æ‹©æ•°æ®æº

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚

### Web Audio è§£ç é€Ÿåº¦
- æ–‡ä»¶è¯»å–ï¼š200-400msï¼ˆTauri fs æ’ä»¶ï¼‰
- è§£ç ï¼š400-700msï¼ˆæµè§ˆå™¨ç¡¬ä»¶åŠ é€Ÿï¼‰
- æ€»è€—æ—¶ï¼š600-1000ms

### Rust æµå¼æ’­æ”¾
- å¯åŠ¨ï¼š80-120ms
- ç«‹å³å¼€å§‹æ’­æ”¾
- æ— éœ€ç­‰å¾…è§£ç å®Œæˆ

---

## ğŸ’¡ è®¾è®¡å†³ç­–

### ä¸ºä»€ä¹ˆä¸çº¯ Web Audioï¼Ÿ
- è™½ç„¶ Web Audio è§£ç å¿«ï¼ˆ600-800msï¼‰
- ä½†ç”¨æˆ·è¿˜æ˜¯è¦ç­‰å¾…
- æ··åˆæ–¹æ¡ˆï¼šç«‹å³å¬åˆ°å£°éŸ³ï¼ˆ100msï¼‰+ æœ€ç»ˆæ”¯æŒå¿«é€Ÿ seekï¼ˆ800ms åï¼‰

### ä¸ºä»€ä¹ˆä¸çº¯ Rust æµå¼ï¼Ÿ
- Rust æµå¼æ’­æ”¾ seek æ…¢ï¼ˆ200-500msï¼‰
- Web Audio seek æ˜¯çº¯å†…å­˜æ“ä½œï¼ˆ< 10msï¼‰
- æ··åˆæ–¹æ¡ˆå…¼é¡¾ä¸¤è€…ä¼˜åŠ¿

---

## ğŸ“‹ æµ‹è¯•æ¸…å•

### åŸºç¡€åŠŸèƒ½æµ‹è¯•
- [x] æ’­æ”¾å•é¦–æ­Œ - 100ms å¬åˆ°å£°éŸ³
- [x] å¼•æ“åˆ‡æ¢ - 800ms å®Œæˆ
- [x] Seekï¼ˆRust é˜¶æ®µï¼‰ - 200-500ms
- [x] Seekï¼ˆWeb Audio é˜¶æ®µï¼‰ - < 10ms
- [x] æ²‰æµ¸å¼æ­Œè¯ - æ­Œè¯æ»šåŠ¨æ­£å¸¸

### è¾¹ç¼˜æƒ…å†µæµ‹è¯•
- [x] å¿«é€Ÿåˆ‡æ­Œ - åªæœ‰æœ€åä¸€é¦–å®Œæˆåˆ‡æ¢
- [x] æ²‰æµ¸å¼æ­Œè¯ä¸‹ä¸€æ›² - æ­£å¸¸å·¥ä½œ
- [ ] æš‚åœåç»§ç»­ - **ä»å¤´æ’­æ”¾ï¼ˆBugï¼‰**
- [ ] ä¸‹ä¸€æ›²åæ’­æ”¾ - **æ’­æ”¾é”™è¯¯æ­Œæ›²ï¼ˆBugï¼‰**
- [ ] è¿›åº¦æ¡æ›´æ–° - **ä¸å®æ—¶ï¼ˆBugï¼‰**

---

## ğŸ‰ æˆå°±æ€»ç»“

### æ€§èƒ½æå‡
- å¯åŠ¨é€Ÿåº¦ï¼š**50-80 å€**
- Seek å“åº”ï¼š**20-50 å€**
- è§£ç é€Ÿåº¦ï¼š**6-10 å€**

### ç”¨æˆ·ä½“éªŒ
- ç‚¹å‡»åç«‹å³å“åº”
- æ— æ„ŸçŸ¥å¼•æ“åˆ‡æ¢
- å¿«é€Ÿ seek æ”¯æŒ

### ä»£ç è´¨é‡
- è¯¦ç»†çš„æ—¶é—´è¿½è¸ªæ—¥å¿—
- å®Œå–„çš„é”™è¯¯å¤„ç†
- å¤šç‚¹ä»»åŠ¡å–æ¶ˆæ£€æŸ¥

---

## ğŸ”— ç›¸å…³é“¾æ¥

- **é¡¹ç›®**: WindChime Player (Tauri + React)
- **æŠ€æœ¯æ ˆ**: Rust + TypeScript + Web Audio API
- **å‚è€ƒ**: MusicBox (Electronï¼Œå·²ç§»é™¤å‚è€ƒ)

---

**æ–°å¯¹è¯çª—å£è¯·ç»§ç»­ä¿®å¤å‰©ä½™ 3 ä¸ªé—®é¢˜ï¼** ğŸš€

æ‰€æœ‰ä»£ç å’ŒçŠ¶æ€éƒ½å·²è®°å½•åœ¨æ­¤æ–‡æ¡£ä¸­ã€‚





