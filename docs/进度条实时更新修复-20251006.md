# è¿›åº¦æ¡å®æ—¶æ›´æ–°ä¿®å¤

> **æ—¥æœŸ**: 2025-10-06  
> **é—®é¢˜**: è¿›åº¦æ¡ä¸ä¼šå®æ—¶æ›´æ–°  
> **çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

### ç—‡çŠ¶
æ’­æ”¾éŸ³ä¹æ—¶ï¼Œè¿›åº¦æ¡ä¸ä¼šå®æ—¶ç§»åŠ¨ï¼Œåœç•™åœ¨æŸä¸ªä½ç½®ä¸åŠ¨ã€‚

### ç”¨æˆ·ä½“éªŒé—®é¢˜
```
æ’­æ”¾å™¨æ­£åœ¨æ’­æ”¾éŸ³ä¹ ğŸµ
  â†“
è¿›åº¦æ¡åœç•™åœ¨ 0:00 ä¸åŠ¨ âŒ
  æˆ–
è¿›åº¦æ¡åœç•™åœ¨ä¸Šä¸€é¦–æ­Œçš„ä½ç½® âŒ
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### ä½ç½®è·å–é€»è¾‘é”™è¯¯

**ä¹‹å‰çš„å®ç°**:
```typescript
// PlaybackContext.tsx
const getPosition = useCallback((): number => {
  try {
    // âŒ æ€»æ˜¯å°è¯•ä» Web Audio Player è·å–
    const position = webAudioPlayer.getPosition();
    return position * 1000;
  } catch (error) {
    // âŒ å‡ºé”™æ—¶è¿”å› positionRefï¼Œä½†å€¼å¯èƒ½æ˜¯ 0 æˆ–æ—§å€¼
    return positionRef.current;
  }
}, []);
```

**é—®é¢˜**:
1. **Rust å¼•æ“é˜¶æ®µ**ï¼ˆæ’­æ”¾å¼€å§‹ 0-800msï¼‰
   - `webAudioPlayer` è¿˜æ²¡åŠ è½½å½“å‰æ­Œæ›²
   - `getPosition()` æŠ›å‡ºé”™è¯¯
   - è¿”å› `positionRef.current = 0`
   - è¿›åº¦æ¡åœç•™åœ¨ 0:00

2. **ç¼ºå°‘å¼•æ“çŠ¶æ€è·Ÿè¸ª**
   - æ²¡æœ‰ `currentEngineRef` æ¥åŒºåˆ†å½“å‰ä½¿ç”¨å“ªä¸ªå¼•æ“
   - æ— æ³•æ™ºèƒ½è·¯ç”±ä½ç½®è·å–

3. **ä½ç½®äº‹ä»¶è¢«è¦†ç›–**
   - Rust å’Œ Web Audio çš„ä½ç½®äº‹ä»¶éƒ½æ›´æ–° `positionRef`
   - å¼•æ“åˆ‡æ¢åï¼ŒRust äº‹ä»¶ä»åœ¨æ›´æ–°ä½ç½®ï¼Œè¦†ç›– Web Audio çš„ä½ç½®

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åŒå±‚ Ref æ¨¡å¼ + å¼•æ“çŠ¶æ€è·¯ç”±

**æ–‡ä»¶**: `src/contexts/PlaybackContext.tsx`

#### æ·»åŠ å¼•æ“çŠ¶æ€è·Ÿè¸ª

```typescript
// ğŸ”¥ å¼•æ“çŠ¶æ€ï¼ˆç”¨äºæ™ºèƒ½è·¯ç”±ä½ç½®è·å–ï¼‰
const webAudioPlayerRef = useRef<any>(null);
const currentEngineRef = useRef<'rust' | 'webaudio'>('rust');
const lastTrackIdRef = useRef<number | null>(null);
```

#### å®ç°åŒå±‚ Ref æ¨¡å¼

```typescript
// ğŸ”¥ åŒå±‚ ref æ¨¡å¼ï¼šè§£å†³é—­åŒ…é—®é¢˜
const getPositionRef = useRef<() => number>(() => 0);

// ğŸ”¥ æ›´æ–° getPosition å®ç°ï¼ˆæ€»æ˜¯è®¿é—®æœ€æ–°çš„ refsï¼‰
getPositionRef.current = () => {
  const engine = currentEngineRef.current;
  
  // ğŸ”¥ å¦‚æœæ˜¯ Web Audio å¼•æ“ï¼Œç›´æ¥ä» Web Audio Player è·å–
  if (engine === 'webaudio' && webAudioPlayerRef.current) {
    try {
      const position = webAudioPlayerRef.current.getPosition();
      const positionMs = position * 1000;
      return positionMs;
    } catch (error) {
      console.error('è·å– Web Audio ä½ç½®å¤±è´¥:', error);
      return positionRef.current;
    }
  }
  
  // Rust å¼•æ“ï¼šä» ref è·å–ï¼ˆç”± Tauri äº‹ä»¶æ›´æ–°ï¼‰
  const position = positionRef.current;
  if (typeof position !== 'number' || isNaN(position)) {
    return 0;
  }
  
  return position;
};

// ğŸ”¥ å¯¼å‡ºçš„ getPositionï¼ˆç¨³å®šå¼•ç”¨ï¼‰
const getPosition = useCallback(() => getPositionRef.current(), []);
```

### 2. ä¿å­˜ Web Audio Player å¼•ç”¨

```typescript
// ğŸ”¥ ä¿å­˜ Web Audio Player å¼•ç”¨ï¼ˆç”¨äºè·å–å®æ—¶ä½ç½®ï¼‰
webAudioPlayerRef.current = webAudioPlayer;
```

### 3. æ·»åŠ å¼•æ“åˆ‡æ¢å›è°ƒ

```typescript
// ğŸ”¥ åˆå§‹åŒ–æ··åˆæ’­æ”¾å™¨ï¼ˆæ·»åŠ å¼•æ“åˆ‡æ¢å›è°ƒï¼‰
const { hybridPlayer } = await import('../services/hybridPlayer');
await hybridPlayer.initialize({
  // å¼•æ“åˆ‡æ¢å›è°ƒ
  onEngineSwitch: (engine) => {
    console.log(`ğŸ”„ [PlaybackContext] å¼•æ“åˆ‡æ¢: ${engine}`);
    
    // ğŸ”¥ æ›´æ–°å½“å‰å¼•æ“æ ‡å¿—
    currentEngineRef.current = engine;
    
    if (engine === 'webaudio') {
      console.log('âœ… [PlaybackContext] ç°åœ¨æ”¯æŒ 0 å»¶è¿Ÿ seekï¼');
      console.log('ğŸ”„ [PlaybackContext] åˆ‡æ¢åˆ° Web Audio ä½ç½®æ›´æ–°');
      // å¼•æ“åˆ‡æ¢åï¼Œç¡®ä¿æ’­æ”¾çŠ¶æ€ä¸º true
      setState(prev => ({ ...prev, isPlaying: true }));
    }
  },
  // ...
});
```

### 4. åªåœ¨å¯¹åº”å¼•æ“ä¸‹æ›´æ–°ä½ç½®

**Rust äº‹ä»¶ç›‘å¬**:
```typescript
const unlistenPosition = await listen('player-position-changed', (event: any) => {
  // ğŸ”¥ åªåœ¨ Rust å¼•æ“ä¸‹æ›´æ–° positionRef
  if (currentEngineRef.current === 'rust') {
    positionRef.current = event.payload as number;
  }
  // Web Audio å¼•æ“ä¸‹å¿½ç•¥ Rust çš„ä½ç½®äº‹ä»¶
});
```

**Web Audio å›è°ƒ**:
```typescript
onPositionChanged: (position) => {
  // ğŸ”¥ åªåœ¨ Web Audio å¼•æ“ä¸‹æ›´æ–°ä½ç½®
  if (currentEngineRef.current === 'webaudio') {
    positionRef.current = position * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
  }
},
```

### 5. æ­Œæ›²åˆ‡æ¢æ—¶é‡ç½®å¼•æ“

```typescript
const unlistenTrack = await listen('player-track-changed', (event: any) => {
  const newTrack = event.payload || null;
  setState(prev => ({ ...prev, track: newTrack }));
  positionRef.current = 0;
  
  // ğŸ”¥ æ­Œæ›²åˆ‡æ¢æ—¶é‡ç½®å¼•æ“ä¸º Rustï¼ˆæ–°æ­Œæ›²ä» Rust å¼€å§‹ï¼‰
  if (newTrack && newTrack.id !== lastTrackIdRef.current) {
    currentEngineRef.current = 'rust';
    lastTrackIdRef.current = newTrack.id;
    console.log(`ğŸ”„ [PlaybackContext] æ­Œæ›²åˆ‡æ¢ (ID: ${newTrack.id})ï¼Œå¼•æ“é‡ç½®ä¸º Rust`);
  }
});
```

---

## ğŸ¯ ä¿®å¤åçš„æµç¨‹

### Rust å¼•æ“é˜¶æ®µï¼ˆ0-800msï¼‰
```
æ’­æ”¾å¼€å§‹
  â†“
currentEngineRef.current = 'rust'
  â†“
Rust å‘é€ player-position-changed äº‹ä»¶
  â†“
positionRef.current = äº‹ä»¶ä½ç½®
  â†“
getPosition() æ£€æŸ¥ currentEngineRef === 'rust'
  â†“
âœ… è¿”å› positionRef.current
  â†“
âœ… è¿›åº¦æ¡å®æ—¶æ›´æ–°
```

### Web Audio å¼•æ“é˜¶æ®µï¼ˆ800ms åï¼‰
```
Web Audio åŠ è½½å®Œæˆ
  â†“
å¼•æ“åˆ‡æ¢: currentEngineRef.current = 'webaudio'
  â†“
getPosition() æ£€æŸ¥ currentEngineRef === 'webaudio'
  â†“
âœ… ä» webAudioPlayer.getPosition() è·å–å®æ—¶ä½ç½®
  â†“
âœ… è¿›åº¦æ¡å®æ—¶æ›´æ–°ï¼ˆ0 å»¶è¿Ÿï¼‰
```

---

## ğŸ“Š æŠ€æœ¯è¦ç‚¹

### 1. åŒå±‚ Ref æ¨¡å¼

**ä½œç”¨**: è§£å†³é—­åŒ…é—®é¢˜ï¼Œç¡®ä¿ `getPosition` å§‹ç»ˆè®¿é—®æœ€æ–°çš„å¼•æ“çŠ¶æ€ã€‚

**å®ç°**:
- **ç¬¬ä¸€å±‚**: `getPositionRef.current`ï¼ˆæ¯æ¬¡æ¸²æŸ“éƒ½æ›´æ–°å®ç°ï¼‰
- **ç¬¬äºŒå±‚**: `getPosition`ï¼ˆç¨³å®šçš„ useCallback å¼•ç”¨ï¼‰

### 2. æ™ºèƒ½ä½ç½®è·¯ç”±

æ ¹æ® `currentEngineRef.current` æ™ºèƒ½é€‰æ‹©ä½ç½®æ¥æºï¼š
- `rust` â†’ ä» `positionRef.current` è·å–ï¼ˆRust äº‹ä»¶æ›´æ–°ï¼‰
- `webaudio` â†’ ä» `webAudioPlayer.getPosition()` è·å–ï¼ˆå®æ—¶ï¼‰

### 3. å¼•æ“çŠ¶æ€éš”ç¦»

ç¡®ä¿å„å¼•æ“çš„äº‹ä»¶åªæ›´æ–°å¯¹åº”å¼•æ“çš„çŠ¶æ€ï¼Œé¿å…äº’ç›¸è¦†ç›–ã€‚

---

## âœ… æµ‹è¯•æ¸…å•

### åœºæ™¯ 1: æ’­æ”¾å¼€å§‹ï¼ˆRust é˜¶æ®µï¼‰
- [ ] ç‚¹å‡»æ­Œæ›²æ’­æ”¾
- [ ] è§‚å¯Ÿè¿›åº¦æ¡ â†’ âœ… åº”è¯¥ä» 0:00 å¼€å§‹å®æ—¶ç§»åŠ¨
- [ ] å‰ 800ms å†…è¿›åº¦æ¡åº”è¯¥æµç•…æ›´æ–°

### åœºæ™¯ 2: å¼•æ“åˆ‡æ¢ï¼ˆWeb Audio é˜¶æ®µï¼‰
- [ ] æ’­æ”¾ 1 ç§’å
- [ ] è§‚å¯Ÿæ§åˆ¶å° â†’ åº”è¯¥çœ‹åˆ° "å¼•æ“åˆ‡æ¢: webaudio"
- [ ] è¿›åº¦æ¡ç»§ç»­æµç•…æ›´æ–° â†’ âœ… æ— ç¼åˆ‡æ¢

### åœºæ™¯ 3: ä¸‹ä¸€é¦–
- [ ] ç‚¹å‡» "ä¸‹ä¸€é¦–"
- [ ] è¿›åº¦æ¡ç«‹å³é‡ç½®ä¸º 0:00 â†’ âœ…
- [ ] æ–°æ­Œæ’­æ”¾æ—¶è¿›åº¦æ¡å®æ—¶æ›´æ–° â†’ âœ…

### åœºæ™¯ 4: æš‚åœ/ç»§ç»­
- [ ] æš‚åœæ’­æ”¾
- [ ] è¿›åº¦æ¡åœæ­¢ â†’ âœ…
- [ ] ç»§ç»­æ’­æ”¾
- [ ] è¿›åº¦æ¡ä»æš‚åœä½ç½®ç»§ç»­ â†’ âœ…

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `src/contexts/PlaybackContext.tsx`
   - æ·»åŠ å¼•æ“çŠ¶æ€è·Ÿè¸ªï¼ˆ`currentEngineRef`ï¼‰
   - å®ç°åŒå±‚ Ref æ¨¡å¼
   - æ·»åŠ æ™ºèƒ½ä½ç½®è·¯ç”±
   - å¼•æ“çŠ¶æ€éš”ç¦»
   - æ­Œæ›²åˆ‡æ¢æ—¶é‡ç½®å¼•æ“

### ç›¸å…³ä¿®å¤
- æš‚åœåŠŸèƒ½ä¿®å¤ï¼ˆRust äº‹ä»¶ç›‘å¬ï¼‰
- æ’­æ”¾çŠ¶æ€ç«‹å³åŒæ­¥ä¼˜åŒ–
- ä¸‹ä¸€é¦–å Seek ä¿®å¤ï¼ˆåå°åŠ è½½ï¼‰

---

## ğŸ’¡ å…³é”®æ”¹è¿›

| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|-------|-------|
| Rust é˜¶æ®µè¿›åº¦ | åœç•™åœ¨ 0:00 âŒ | å®æ—¶æ›´æ–° âœ… |
| Web Audio é˜¶æ®µ | è·å–å¤±è´¥ âŒ | å®æ—¶æ›´æ–°ï¼ˆ0å»¶è¿Ÿï¼‰âœ… |
| å¼•æ“åˆ‡æ¢ | ä½ç½®è·³å˜ âŒ | æ— ç¼åˆ‡æ¢ âœ… |
| ä¸‹ä¸€é¦– | ä½ç½®é”™ä¹± âŒ | æ­£ç¡®é‡ç½® âœ… |

---

**ä¿®å¤å®Œæˆï¼** ğŸ‰

è¿›åº¦æ¡ç°åœ¨åœ¨æ‰€æœ‰åœºæ™¯ä¸‹éƒ½èƒ½å®æ—¶ã€æµç•…åœ°æ›´æ–°äº†ï¼


