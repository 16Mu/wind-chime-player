# 播放记录自动更新优化

## 🎯 问题

1. 播放新曲目后，播放记录页面不会自动更新数据
2. 在 `player_play` 命令中直接记录历史可能影响播放功能

## ✅ 解决方案

### 核心设计：事件驱动 + 完全解耦

通过监听播放器事件来记录播放历史，而不是在播放命令中直接记录，实现完全解耦：

**播放流程** ➜ **播放器发送事件** ➜ **前端监听并记录** ➜ **刷新UI**

### 1. 事件监听 + 自动记录

在 `PlayHistoryContext` 中监听播放器事件并自动记录：

```typescript
// 监听播放器曲目切换事件，自动记录播放历史并刷新数据
useEffect(() => {
  let refreshTimeout: NodeJS.Timeout | null = null;
  
  const unlisten = listen('player-track-changed', async (event: any) => {
    const trackData = event.payload;
    console.log('[PlayHistoryContext] 检测到曲目切换:', trackData);
    
    // ✅ 立即记录播放历史（不阻塞UI）
    if (trackData && trackData.id) {
      try {
        await invoke('add_play_history', { trackId: trackData.id });
        console.log('[PlayHistoryContext] ✅ 播放历史已记录');
      } catch (err) {
        console.warn('[PlayHistoryContext] ⚠️ 记录失败:', err);
        // 失败不影响播放，只打印警告
      }
    }
    
    // 防抖：延迟1秒后刷新UI
    if (refreshTimeout) {
      clearTimeout(refreshTimeout);
    }
    
    refreshTimeout = setTimeout(() => {
      loadHistory();
      loadStatistics();
    }, 1000);
  });

  return () => {
    if (refreshTimeout) clearTimeout(refreshTimeout);
    unlisten.then(fn => fn());
  };
}, [loadHistory, loadStatistics]);
```

**关键特性**：
- ✅ 监听 `player-track-changed` 事件
- ✅ **立即记录**播放历史到数据库
- ✅ 防抖延迟刷新UI（避免频繁操作）
- ✅ 失败不影响播放功能
- ✅ 正确的清理逻辑

### 2. 手动刷新功能

添加了手动刷新按钮和最后更新时间显示：

**新增状态**：
```typescript
const [lastUpdateTime, setLastUpdateTime] = useState<number | null>(null);
```

**刷新方法**：
```typescript
const refresh = useCallback(async () => {
  await Promise.all([loadHistory(), loadStatistics()]);
}, [loadHistory, loadStatistics]);
```

**UI改进**：
- ✅ 刷新按钮（带loading状态和旋转动画）
- ✅ 最后更新时间显示（智能相对时间）
- ✅ 定时更新时间显示（每10秒刷新一次）

### 3. 相对时间显示

```typescript
const formatUpdateTime = (timestamp: number | null) => {
  if (!timestamp) return '未更新';
  const now = Date.now();
  const diff = now - timestamp;
  
  if (diff < 5000) return '刚刚更新';
  if (diff < 60000) return `${Math.floor(diff / 1000)}秒前`;
  if (diff < 3600000) return `${Math.floor(diff / 60000)}分钟前`;
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}小时前`;
  return new Date(timestamp).toLocaleString('zh-CN', {
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
  });
};
```

## 📋 修改文件列表

### 1. `src/contexts/PlayHistoryContext.tsx`
- ✅ 导入 `listen` 和 `useEffect`
- ✅ 添加 `lastUpdateTime` 状态
- ✅ 添加 `refresh` 方法
- ✅ 添加事件监听逻辑
- ✅ 在数据加载成功后更新 `lastUpdateTime`

### 2. `src/components/PlayHistoryPage.tsx`
- ✅ 导入 `RefreshCw` 图标
- ✅ 添加相对时间格式化函数
- ✅ 添加定时更新逻辑（每10秒）
- ✅ 添加刷新按钮到工具栏
- ✅ 添加最后更新时间显示

## 🎨 UI改进

### 工具栏布局优化

```
[排序按钮组] [🕐 更新时间]              [🔄 刷新] [🗑️ 清空历史]
```

- 左侧：排序按钮 + 更新时间
- 右侧：操作按钮（刷新、清空）

### 交互反馈

1. **刷新按钮**：
   - 加载时图标旋转（`animate-spin`）
   - 加载时禁用按钮
   - 鼠标悬停提示

2. **更新时间**：
   - 智能相对时间（刚刚、X秒前、X分钟前...）
   - 每10秒自动更新显示
   - 图标 + 文字组合

## 🔄 工作流程

```
播放器播放新曲目
    ↓
触发 player-track-changed 事件
    ↓
PlayHistoryContext 监听到事件
    ↓
防抖延迟 1 秒
    ↓
自动刷新历史数据和统计
    ↓
更新 lastUpdateTime
    ↓
UI 显示"刚刚更新"
    ↓
每10秒更新显示时间
```

## ✨ 用户体验提升

### 之前
- ❌ 播放新曲目后数据不更新
- ❌ 需要手动刷新页面
- ❌ 不知道数据是否最新

### 之后
- ✅ 自动检测播放事件并刷新
- ✅ 一键手动刷新功能
- ✅ 清晰的更新时间提示
- ✅ 防抖优化（避免频繁刷新）
- ✅ 加载状态反馈

## 🚀 性能优化

1. **防抖机制**：避免频繁切歌时多次请求
2. **异步刷新**：不阻塞UI
3. **智能更新**：只在需要时更新显示
4. **事件清理**：避免内存泄漏

## 🧪 测试建议

1. ✅ 播放一首歌，检查1秒后历史是否自动更新
2. ✅ 快速切换多首歌，检查防抖是否生效
3. ✅ 点击刷新按钮，检查加载状态
4. ✅ 观察更新时间显示是否正确
5. ✅ 等待10秒以上，检查相对时间是否更新

## 📝 代码质量

- ✅ TypeScript 类型安全
- ✅ 无 linting 错误
- ✅ 正确的清理逻辑
- ✅ 良好的错误处理
- ✅ 清晰的注释

