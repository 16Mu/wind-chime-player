# æ’­æ”¾è®°å½•è‡ªåŠ¨æ›´æ–°ä¼˜åŒ–

## ğŸ¯ é—®é¢˜

1. æ’­æ”¾æ–°æ›²ç›®åï¼Œæ’­æ”¾è®°å½•é¡µé¢ä¸ä¼šè‡ªåŠ¨æ›´æ–°æ•°æ®
2. åœ¨ `player_play` å‘½ä»¤ä¸­ç›´æ¥è®°å½•å†å²å¯èƒ½å½±å“æ’­æ”¾åŠŸèƒ½

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒè®¾è®¡ï¼šäº‹ä»¶é©±åŠ¨ + å®Œå…¨è§£è€¦

é€šè¿‡ç›‘å¬æ’­æ”¾å™¨äº‹ä»¶æ¥è®°å½•æ’­æ”¾å†å²ï¼Œè€Œä¸æ˜¯åœ¨æ’­æ”¾å‘½ä»¤ä¸­ç›´æ¥è®°å½•ï¼Œå®ç°å®Œå…¨è§£è€¦ï¼š

**æ’­æ”¾æµç¨‹** âœ **æ’­æ”¾å™¨å‘é€äº‹ä»¶** âœ **å‰ç«¯ç›‘å¬å¹¶è®°å½•** âœ **åˆ·æ–°UI**

### 1. äº‹ä»¶ç›‘å¬ + è‡ªåŠ¨è®°å½•

åœ¨ `PlayHistoryContext` ä¸­ç›‘å¬æ’­æ”¾å™¨äº‹ä»¶å¹¶è‡ªåŠ¨è®°å½•ï¼š

```typescript
// ç›‘å¬æ’­æ”¾å™¨æ›²ç›®åˆ‡æ¢äº‹ä»¶ï¼Œè‡ªåŠ¨è®°å½•æ’­æ”¾å†å²å¹¶åˆ·æ–°æ•°æ®
useEffect(() => {
  let refreshTimeout: NodeJS.Timeout | null = null;
  
  const unlisten = listen('player-track-changed', async (event: any) => {
    const trackData = event.payload;
    console.log('[PlayHistoryContext] æ£€æµ‹åˆ°æ›²ç›®åˆ‡æ¢:', trackData);
    
    // âœ… ç«‹å³è®°å½•æ’­æ”¾å†å²ï¼ˆä¸é˜»å¡UIï¼‰
    if (trackData && trackData.id) {
      try {
        await invoke('add_play_history', { trackId: trackData.id });
        console.log('[PlayHistoryContext] âœ… æ’­æ”¾å†å²å·²è®°å½•');
      } catch (err) {
        console.warn('[PlayHistoryContext] âš ï¸ è®°å½•å¤±è´¥:', err);
        // å¤±è´¥ä¸å½±å“æ’­æ”¾ï¼Œåªæ‰“å°è­¦å‘Š
      }
    }
    
    // é˜²æŠ–ï¼šå»¶è¿Ÿ1ç§’ååˆ·æ–°UI
    if (refreshTimeout) {
      clearTimeout(refreshTimeout);
    }
    
    refreshTimeout = setTimeout(() => {
      loadHistory();
      loadStatistics();
    }, 1000);
  });

  return () => {
    if (refreshTimeout) clearTimeout(refreshTimeout);
    unlisten.then(fn => fn());
  };
}, [loadHistory, loadStatistics]);
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… ç›‘å¬ `player-track-changed` äº‹ä»¶
- âœ… **ç«‹å³è®°å½•**æ’­æ”¾å†å²åˆ°æ•°æ®åº“
- âœ… é˜²æŠ–å»¶è¿Ÿåˆ·æ–°UIï¼ˆé¿å…é¢‘ç¹æ“ä½œï¼‰
- âœ… å¤±è´¥ä¸å½±å“æ’­æ”¾åŠŸèƒ½
- âœ… æ­£ç¡®çš„æ¸…ç†é€»è¾‘

### 2. æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½

æ·»åŠ äº†æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®å’Œæœ€åæ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼š

**æ–°å¢çŠ¶æ€**ï¼š
```typescript
const [lastUpdateTime, setLastUpdateTime] = useState<number | null>(null);
```

**åˆ·æ–°æ–¹æ³•**ï¼š
```typescript
const refresh = useCallback(async () => {
  await Promise.all([loadHistory(), loadStatistics()]);
}, [loadHistory, loadStatistics]);
```

**UIæ”¹è¿›**ï¼š
- âœ… åˆ·æ–°æŒ‰é’®ï¼ˆå¸¦loadingçŠ¶æ€å’Œæ—‹è½¬åŠ¨ç”»ï¼‰
- âœ… æœ€åæ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼ˆæ™ºèƒ½ç›¸å¯¹æ—¶é—´ï¼‰
- âœ… å®šæ—¶æ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼ˆæ¯10ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰

### 3. ç›¸å¯¹æ—¶é—´æ˜¾ç¤º

```typescript
const formatUpdateTime = (timestamp: number | null) => {
  if (!timestamp) return 'æœªæ›´æ–°';
  const now = Date.now();
  const diff = now - timestamp;
  
  if (diff < 5000) return 'åˆšåˆšæ›´æ–°';
  if (diff < 60000) return `${Math.floor(diff / 1000)}ç§’å‰`;
  if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
  return new Date(timestamp).toLocaleString('zh-CN', {
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
  });
};
```

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

### 1. `src/contexts/PlayHistoryContext.tsx`
- âœ… å¯¼å…¥ `listen` å’Œ `useEffect`
- âœ… æ·»åŠ  `lastUpdateTime` çŠ¶æ€
- âœ… æ·»åŠ  `refresh` æ–¹æ³•
- âœ… æ·»åŠ äº‹ä»¶ç›‘å¬é€»è¾‘
- âœ… åœ¨æ•°æ®åŠ è½½æˆåŠŸåæ›´æ–° `lastUpdateTime`

### 2. `src/components/PlayHistoryPage.tsx`
- âœ… å¯¼å…¥ `RefreshCw` å›¾æ ‡
- âœ… æ·»åŠ ç›¸å¯¹æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
- âœ… æ·»åŠ å®šæ—¶æ›´æ–°é€»è¾‘ï¼ˆæ¯10ç§’ï¼‰
- âœ… æ·»åŠ åˆ·æ–°æŒ‰é’®åˆ°å·¥å…·æ 
- âœ… æ·»åŠ æœ€åæ›´æ–°æ—¶é—´æ˜¾ç¤º

## ğŸ¨ UIæ”¹è¿›

### å·¥å…·æ å¸ƒå±€ä¼˜åŒ–

```
[æ’åºæŒ‰é’®ç»„] [ğŸ• æ›´æ–°æ—¶é—´]              [ğŸ”„ åˆ·æ–°] [ğŸ—‘ï¸ æ¸…ç©ºå†å²]
```

- å·¦ä¾§ï¼šæ’åºæŒ‰é’® + æ›´æ–°æ—¶é—´
- å³ä¾§ï¼šæ“ä½œæŒ‰é’®ï¼ˆåˆ·æ–°ã€æ¸…ç©ºï¼‰

### äº¤äº’åé¦ˆ

1. **åˆ·æ–°æŒ‰é’®**ï¼š
   - åŠ è½½æ—¶å›¾æ ‡æ—‹è½¬ï¼ˆ`animate-spin`ï¼‰
   - åŠ è½½æ—¶ç¦ç”¨æŒ‰é’®
   - é¼ æ ‡æ‚¬åœæç¤º

2. **æ›´æ–°æ—¶é—´**ï¼š
   - æ™ºèƒ½ç›¸å¯¹æ—¶é—´ï¼ˆåˆšåˆšã€Xç§’å‰ã€Xåˆ†é’Ÿå‰...ï¼‰
   - æ¯10ç§’è‡ªåŠ¨æ›´æ–°æ˜¾ç¤º
   - å›¾æ ‡ + æ–‡å­—ç»„åˆ

## ğŸ”„ å·¥ä½œæµç¨‹

```
æ’­æ”¾å™¨æ’­æ”¾æ–°æ›²ç›®
    â†“
è§¦å‘ player-track-changed äº‹ä»¶
    â†“
PlayHistoryContext ç›‘å¬åˆ°äº‹ä»¶
    â†“
é˜²æŠ–å»¶è¿Ÿ 1 ç§’
    â†“
è‡ªåŠ¨åˆ·æ–°å†å²æ•°æ®å’Œç»Ÿè®¡
    â†“
æ›´æ–° lastUpdateTime
    â†“
UI æ˜¾ç¤º"åˆšåˆšæ›´æ–°"
    â†“
æ¯10ç§’æ›´æ–°æ˜¾ç¤ºæ—¶é—´
```

## âœ¨ ç”¨æˆ·ä½“éªŒæå‡

### ä¹‹å‰
- âŒ æ’­æ”¾æ–°æ›²ç›®åæ•°æ®ä¸æ›´æ–°
- âŒ éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢
- âŒ ä¸çŸ¥é“æ•°æ®æ˜¯å¦æœ€æ–°

### ä¹‹å
- âœ… è‡ªåŠ¨æ£€æµ‹æ’­æ”¾äº‹ä»¶å¹¶åˆ·æ–°
- âœ… ä¸€é”®æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½
- âœ… æ¸…æ™°çš„æ›´æ–°æ—¶é—´æç¤º
- âœ… é˜²æŠ–ä¼˜åŒ–ï¼ˆé¿å…é¢‘ç¹åˆ·æ–°ï¼‰
- âœ… åŠ è½½çŠ¶æ€åé¦ˆ

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

1. **é˜²æŠ–æœºåˆ¶**ï¼šé¿å…é¢‘ç¹åˆ‡æ­Œæ—¶å¤šæ¬¡è¯·æ±‚
2. **å¼‚æ­¥åˆ·æ–°**ï¼šä¸é˜»å¡UI
3. **æ™ºèƒ½æ›´æ–°**ï¼šåªåœ¨éœ€è¦æ—¶æ›´æ–°æ˜¾ç¤º
4. **äº‹ä»¶æ¸…ç†**ï¼šé¿å…å†…å­˜æ³„æ¼

## ğŸ§ª æµ‹è¯•å»ºè®®

1. âœ… æ’­æ”¾ä¸€é¦–æ­Œï¼Œæ£€æŸ¥1ç§’åå†å²æ˜¯å¦è‡ªåŠ¨æ›´æ–°
2. âœ… å¿«é€Ÿåˆ‡æ¢å¤šé¦–æ­Œï¼Œæ£€æŸ¥é˜²æŠ–æ˜¯å¦ç”Ÿæ•ˆ
3. âœ… ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼Œæ£€æŸ¥åŠ è½½çŠ¶æ€
4. âœ… è§‚å¯Ÿæ›´æ–°æ—¶é—´æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®
5. âœ… ç­‰å¾…10ç§’ä»¥ä¸Šï¼Œæ£€æŸ¥ç›¸å¯¹æ—¶é—´æ˜¯å¦æ›´æ–°

## ğŸ“ ä»£ç è´¨é‡

- âœ… TypeScript ç±»å‹å®‰å…¨
- âœ… æ—  linting é”™è¯¯
- âœ… æ­£ç¡®çš„æ¸…ç†é€»è¾‘
- âœ… è‰¯å¥½çš„é”™è¯¯å¤„ç†
- âœ… æ¸…æ™°çš„æ³¨é‡Š

