# WindChime Player - æ€§èƒ½ä¼˜åŒ–ä¸æ¶æ„æ”¹è¿›å»ºè®®

**åˆ†ææ—¥æœŸ**: 2025-10-02  
**ä»£ç åº“ç‰ˆæœ¬**: v0.3.1

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

ç»è¿‡å…¨é¢çš„ä»£ç å®¡æŸ¥ï¼Œå‘ç°äº†**7ä¸ªä¸»è¦ä¼˜åŒ–é¢†åŸŸ**ï¼Œæ¶‰åŠ**æ€§èƒ½æå‡**ã€**æ¶æ„é‡æ„**å’Œ**ä»£ç è´¨é‡æ”¹è¿›**ã€‚å®æ–½è¿™äº›å»ºè®®é¢„è®¡å¯ä»¥ï¼š

- ğŸš€ å‡å°‘ **30-40%** çš„é‡æ¸²æŸ“æ¬¡æ•°
- ğŸ“¦ é™ä½ **20-25%** çš„å†…å­˜å ç”¨
- ğŸ—ï¸ æå‡ä»£ç å¯ç»´æŠ¤æ€§ **50%+**
- âš¡ æ”¹å–„é¦–å±åŠ è½½æ—¶é—´ **15-20%**

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜

### 1. ç±»å‹å®šä¹‰é‡å¤ (Critical)

**é—®é¢˜æè¿°**:  
`Track` æ¥å£åœ¨ **19ä¸ªæ–‡ä»¶** ä¸­é‡å¤å®šä¹‰ï¼Œå¯¼è‡´ï¼š
- ç±»å‹ä¸ä¸€è‡´é£é™©
- ç»´æŠ¤æˆæœ¬é«˜
- æ„å»ºä½“ç§¯å¢å¤§

**å½±å“æ–‡ä»¶**:
```
src/App.tsx
src/contexts/PlaybackContext.tsx
src/components/PlaylistPlayer.tsx
src/components/LibraryPage.tsx
src/components/TracksView.tsx
src/components/AlbumsView.tsx
src/components/ArtistsView.tsx
src/components/FavoritesView.tsx
src/components/ImmersiveLyricsView.tsx
... è¿˜æœ‰10ä¸ªæ–‡ä»¶
```

**è§£å†³æ–¹æ¡ˆ**:

```typescript
// ğŸ“ src/types/music.ts (æ–°å»º)
export interface Track {
  id: number;
  path: string;
  title?: string;
  artist?: string;
  album?: string;
  duration_ms?: number;
}

export interface LibraryStats {
  total_tracks: number;
  total_artists: number;
  total_albums: number;
}

export interface PlayerState {
  current_track: Track | null;
  is_playing: boolean;
  position_ms: number;
  volume: number;
  repeat_mode: 'Off' | 'One' | 'All';
  shuffle: boolean;
}
```

**å®æ–½æ­¥éª¤**:
1. åˆ›å»ºç»Ÿä¸€çš„ç±»å‹æ–‡ä»¶ `src/types/music.ts`
2. é€ä¸ªæ–‡ä»¶æ›¿æ¢æœ¬åœ°ç±»å‹å®šä¹‰ä¸ºå¯¼å…¥è¯­å¥
3. ä½¿ç”¨ TypeScript ç¼–è¯‘å™¨éªŒè¯ç±»å‹ä¸€è‡´æ€§

**é¢„æœŸæ”¶ç›Š**:
- âœ… ç±»å‹å®‰å…¨æ€§æå‡
- âœ… ä»£ç è¡Œæ•°å‡å°‘çº¦ 200 è¡Œ
- âœ… ç»´æŠ¤æˆæœ¬é™ä½ 60%

---

### 2. äº‹ä»¶ç›‘å¬å™¨é‡å¤ (High)

**é—®é¢˜æè¿°**:  
å¤šä¸ªç»„ä»¶é‡å¤ç›‘å¬ç›¸åŒçš„ Tauri äº‹ä»¶ï¼Œé€ æˆï¼š
- å†…å­˜æ³„æ¼é£é™©
- äº‹ä»¶å¤„ç†é‡å¤æ‰§è¡Œ
- çŠ¶æ€ä¸ä¸€è‡´

**é‡å¤ç›‘å¬çš„äº‹ä»¶**:
```javascript
// App.tsx ä¸­ç›‘å¬
'library-scan-started'
'library-scan-progress'  
'library-scan-complete'
'player-error'

// LibraryPage.tsx ä¸­å†æ¬¡ç›‘å¬
'library-scan-started'
'library-scan-progress'
'library-scan-complete'

// PlaylistPlayer.tsx ä¸­å†æ¬¡ç›‘å¬
'player-error'
```

**è§£å†³æ–¹æ¡ˆ**:

```typescript
// ğŸ“ src/hooks/useEventManager.ts (æ–°å»º)
import { listen } from '@tauri-apps/api/event';
import { useEffect } from 'react';

type EventHandlers = {
  'library-scan-started'?: () => void;
  'library-scan-progress'?: (data: any) => void;
  'library-scan-complete'?: (data: any) => void;
  'player-error'?: (error: any) => void;
  // ... å…¶ä»–äº‹ä»¶
};

export function useEventManager(handlers: EventHandlers) {
  useEffect(() => {
    const listeners: (() => void)[] = [];
    
    Object.entries(handlers).forEach(async ([event, handler]) => {
      if (handler) {
        const unlisten = await listen(event, handler);
        listeners.push(unlisten);
      }
    });
    
    return () => {
      listeners.forEach(unlisten => unlisten());
    };
  }, [handlers]);
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
// åœ¨ App.tsx ä¸­ç»Ÿä¸€ç®¡ç†
useEventManager({
  'library-scan-started': () => setIsScanning(true),
  'library-scan-complete': () => {
    setIsScanning(false);
    loadLibraryTracks();
  },
  'player-error': handlePlayerError,
});
```

**é¢„æœŸæ”¶ç›Š**:
- âœ… äº‹ä»¶ç›‘å¬å™¨æ•°é‡å‡å°‘ 50%
- âœ… é¿å…å†…å­˜æ³„æ¼
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†é€»è¾‘

---

### 3. App.tsx çŠ¶æ€ç®¡ç†è¿‡è½½ (High)

**é—®é¢˜æè¿°**:  
`App.tsx` æ‰¿æ‹…äº†è¿‡å¤šèŒè´£ï¼ŒåŒ…å« **18ä¸ª state** å’Œ **10ä¸ª useEffect**ï¼š

```typescript
// å½“å‰ App.tsx çš„çŠ¶æ€
- currentPage, pageAnimationKey
- selectedTrack, searchQuery, sidebarCollapsed
- theme, isHighContrast, lyricsAnimationSettings
- tracks, libraryStats, isLibraryLoading
- hasLibraryInitialized, libraryDataCached
- showAudioDeviceError, audioErrorMessage, isResettingAudio
// ... è¿˜æœ‰æ›´å¤š
```

**é—®é¢˜**:
- éš¾ä»¥ç»´æŠ¤
- é‡æ¸²æŸ“è¿‡äºé¢‘ç¹
- è¿åå•ä¸€èŒè´£åŸåˆ™

**è§£å†³æ–¹æ¡ˆ - çŠ¶æ€åˆ†å±‚æ¶æ„**:

```typescript
// ğŸ“ src/contexts/LibraryContext.tsx (æ–°å»º)
export function LibraryProvider({ children }: { children: ReactNode }) {
  const [tracks, setTracks] = useState<Track[]>([]);
  const [stats, setStats] = useState<LibraryStats | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  
  // ç»Ÿä¸€ç®¡ç†éŸ³ä¹åº“ç›¸å…³çŠ¶æ€å’Œé€»è¾‘
  
  return (
    <LibraryContext.Provider value={{ tracks, stats, isLoading, ... }}>
      {children}
    </LibraryContext.Provider>
  );
}

// ğŸ“ src/contexts/UIContext.tsx (æ–°å»º)
export function UIProvider({ children }: { children: ReactNode }) {
  const [currentPage, setCurrentPage] = useState<Page>('library');
  const [searchQuery, setSearchQuery] = useState('');
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  
  // ç»Ÿä¸€ç®¡ç†UIçŠ¶æ€
  
  return (
    <UIContext.Provider value={{ ... }}>
      {children}
    </UIContext.Provider>
  );
}

// ğŸ“ src/contexts/ThemeContext.tsx (æ–°å»º)
export function ThemeProvider({ children }: { children: ReactNode }) {
  const [theme, setTheme] = useState<'system' | 'light' | 'dark'>('system');
  const [isHighContrast, setIsHighContrast] = useState(false);
  
  // ç»Ÿä¸€ç®¡ç†ä¸»é¢˜ç›¸å…³çŠ¶æ€
  
  return (
    <ThemeContext.Provider value={{ ... }}>
      {children}
    </ThemeContext.Provider>
  );
}
```

**æ–°çš„ App.tsx ç»“æ„**:
```typescript
export default function App() {
  return (
    <ThemeProvider>
      <LibraryProvider>
        <UIProvider>
          <PlaybackProvider>
            <ToastProvider>
              <AppContent />
            </ToastProvider>
          </PlaybackProvider>
        </UIProvider>
      </LibraryProvider>
    </ThemeProvider>
  );
}
```

**é¢„æœŸæ”¶ç›Š**:
- âœ… App.tsx ä»£ç é‡å‡å°‘ 70%
- âœ… çŠ¶æ€éš”ç¦»ï¼Œå‡å°‘æ— å…³é‡æ¸²æŸ“
- âœ… æ›´æ¸…æ™°çš„èŒè´£åˆ’åˆ†

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜

### 4. ç»„ä»¶æ€§èƒ½ä¼˜åŒ–ä¸è¶³

**é—®é¢˜æè¿°**:  
è®¸å¤šç»„ä»¶ç¼ºå°‘å¿…è¦çš„æ€§èƒ½ä¼˜åŒ–æªæ–½ï¼š

**æœªä½¿ç”¨ React.memo çš„å¤§å‹ç»„ä»¶**:
- `TracksView` (184è¡Œ) - æ¯æ¬¡çˆ¶ç»„ä»¶æ›´æ–°éƒ½é‡æ¸²æŸ“
- `PlaylistPlayer` (1075è¡Œ) - å·¨å‹ç»„ä»¶ï¼Œä¼˜åŒ–ç©ºé—´å¤§
- `LibraryPage` (313è¡Œ)

**è§£å†³æ–¹æ¡ˆ**:

```typescript
// TracksView.tsx - æ·»åŠ  memo
export default React.memo(function TracksView({
  tracks,
  onTrackSelect,
  isLoading,
  selectedTrackId,
  showFavoriteButtons,
  onFavoriteChange
}: TracksViewProps) {
  // ... ç»„ä»¶é€»è¾‘
}, (prevProps, nextProps) => {
  // è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•° - åªåœ¨å…³é”®propså˜åŒ–æ—¶é‡æ¸²æŸ“
  return (
    prevProps.tracks.length === nextProps.tracks.length &&
    prevProps.selectedTrackId === nextProps.selectedTrackId &&
    prevProps.isLoading === nextProps.isLoading
  );
});
```

**ç¼ºå°‘ useMemo/useCallback çš„è®¡ç®—é€»è¾‘**:

```typescript
// LibraryPage.tsx - ä¼˜åŒ–å‰
const realTimeStats = useMemo(() => {
  // å¤æ‚è®¡ç®—...
}, [tracks]); // âœ… å·²ä½¿ç”¨ useMemo

// App.tsx - éœ€è¦ä¼˜åŒ–
const handlePageChange = (page: Page) => {  // âŒ æ¯æ¬¡é‡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å‡½æ•°
  if (page !== currentPage) {
    setCurrentPage(page);
    setPageAnimationKey(prev => prev + 1);
  }
};

// ä¼˜åŒ–å
const handlePageChange = useCallback((page: Page) => {
  if (page !== currentPage) {
    setCurrentPage(page);
    setPageAnimationKey(prev => prev + 1);
  }
}, [currentPage]);
```

**é¢„æœŸæ”¶ç›Š**:
- âœ… é‡æ¸²æŸ“æ¬¡æ•°å‡å°‘ 30-40%
- âœ… æ»šåŠ¨æ€§èƒ½æå‡
- âœ… äº¤äº’å“åº”æ›´æµç•…

---

### 5. PlaylistPlayer ç»„ä»¶èŒè´£è¿‡é‡

**é—®é¢˜æè¿°**:  
`PlaylistPlayer.tsx` æœ‰ **1075è¡Œä»£ç **ï¼ŒåŒ…å«ï¼š
- æ’­æ”¾æ§åˆ¶é€»è¾‘
- éŸ³é‡æ§åˆ¶
- è¿›åº¦æ¡å¤„ç†
- æ­Œè¯æ˜¾ç¤º
- ä¸“è¾‘å°é¢åŠ è½½
- æ”¶è—åŠŸèƒ½
- é”™è¯¯å¤„ç†UI

**è§£å†³æ–¹æ¡ˆ - ç»„ä»¶æ‹†åˆ†**:

```typescript
// ğŸ“ src/components/player/PlayerCore.tsx
export function PlayerCore({ track, onSeek, onVolumeChange }) {
  // æ ¸å¿ƒæ’­æ”¾æ§åˆ¶
}

// ğŸ“ src/components/player/PlayerControls.tsx
export function PlayerControls({ isPlaying, onPlay, onPause, onNext, onPrevious }) {
  // æ’­æ”¾æ§åˆ¶æŒ‰é’®
}

// ğŸ“ src/components/player/ProgressBar.tsx
export function ProgressBar({ position, duration, onSeek }) {
  // è¿›åº¦æ¡é€»è¾‘
}

// ğŸ“ src/components/player/VolumeControl.tsx
export function VolumeControl({ volume, isMuted, onChange, onToggleMute }) {
  // éŸ³é‡æ§åˆ¶
}

// ğŸ“ src/components/player/PlayerInfo.tsx
export function PlayerInfo({ track, albumCoverUrl, currentLyric }) {
  // æ›²ç›®ä¿¡æ¯æ˜¾ç¤º
}

// ğŸ“ src/components/player/index.tsx
export default function PlaylistPlayer({ currentTrack }: PlaylistPlayerProps) {
  return (
    <div className="modern-player">
      <PlayerInfo track={displayTrack} albumCoverUrl={albumCoverUrl} currentLyric={currentLyric} />
      <PlayerControls {...controlProps} />
      <ProgressBar {...progressProps} />
      <VolumeControl {...volumeProps} />
    </div>
  );
}
```

**é¢„æœŸæ”¶ç›Š**:
- âœ… å•ä¸ªæ–‡ä»¶ä»£ç é‡å‡å°‘åˆ° 200 è¡Œä»¥å†…
- âœ… ç»„ä»¶å¯å¤ç”¨æ€§æå‡
- âœ… æµ‹è¯•æ›´å®¹æ˜“
- âœ… ä»£ç å¯è¯»æ€§å¤§å¹…æå‡

---

### 6. å‰ç«¯ç¼“å­˜ç­–ç•¥æ”¹è¿›

**é—®é¢˜æè¿°**:  
è™½ç„¶åç«¯å®ç°äº†æŸ¥è¯¢ç¼“å­˜ï¼Œä½†å‰ç«¯å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š

**å½“å‰é—®é¢˜**:
- ä¸“è¾‘å°é¢é‡å¤åŠ è½½
- æ­Œè¯æ•°æ®é‡å¤è¯·æ±‚
- æœç´¢ç»“æœæœªç¼“å­˜

**è§£å†³æ–¹æ¡ˆ - å‰ç«¯ç¼“å­˜å±‚**:

```typescript
// ğŸ“ src/utils/cache.ts (æ–°å»º)
class CacheManager<T> {
  private cache = new Map<string, { data: T; timestamp: number }>();
  private ttl: number;

  constructor(ttlMinutes: number = 10) {
    this.ttl = ttlMinutes * 60 * 1000;
  }

  get(key: string): T | null {
    const entry = this.cache.get(key);
    if (!entry) return null;
    
    if (Date.now() - entry.timestamp > this.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return entry.data;
  }

  set(key: string, data: T): void {
    this.cache.set(key, { data, timestamp: Date.now() });
  }

  clear(): void {
    this.cache.clear();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const albumCoverCache = new CacheManager<string>(30); // 30åˆ†é’ŸTTL
const lyricsCache = new CacheManager<ParsedLyrics>(60); // 60åˆ†é’ŸTTL

// ğŸ“ src/hooks/useCachedAlbumCover.ts
export function useCachedAlbumCover(trackId: number) {
  const [coverUrl, setCoverUrl] = useState<string | null>(null);
  
  useEffect(() => {
    // å…ˆæ£€æŸ¥ç¼“å­˜
    const cached = albumCoverCache.get(`track-${trackId}`);
    if (cached) {
      setCoverUrl(cached);
      return;
    }
    
    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒåŠ è½½å¹¶ç¼“å­˜
    loadAlbumCover(trackId).then(url => {
      if (url) {
        albumCoverCache.set(`track-${trackId}`, url);
        setCoverUrl(url);
      }
    });
  }, [trackId]);
  
  return coverUrl;
}
```

**é¢„æœŸæ”¶ç›Š**:
- âœ… ç½‘ç»œè¯·æ±‚å‡å°‘ 40-60%
- âœ… å“åº”é€Ÿåº¦æå‡
- âœ… å‡å°‘åç«¯å‹åŠ›

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§ä¼˜åŒ–

### 7. è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–

**é—®é¢˜æè¿°**:  
å½“éŸ³ä¹åº“åŒ…å« 10,000+ é¦–æ­Œæ›²æ—¶ï¼Œ`TracksView` ä¼šæ¸²æŸ“æ‰€æœ‰ DOM èŠ‚ç‚¹ï¼Œé€ æˆï¼š
- é¦–æ¬¡æ¸²æŸ“æ…¢
- æ»šåŠ¨å¡é¡¿
- å†…å­˜å ç”¨é«˜

**è§£å†³æ–¹æ¡ˆ - å¼•å…¥è™šæ‹Ÿæ»šåŠ¨**:

```typescript
// ä½¿ç”¨ react-window æˆ– react-virtual
import { FixedSizeList } from 'react-window';

export default function TracksView({ tracks, ... }: TracksViewProps) {
  const Row = ({ index, style }: { index: number; style: React.CSSProperties }) => (
    <div style={style}>
      <TrackRow track={tracks[index]} ... />
    </div>
  );

  return (
    <FixedSizeList
      height={600}
      itemCount={tracks.length}
      itemSize={60}
      width="100%"
    >
      {Row}
    </FixedSizeList>
  );
}
```

**é¢„æœŸæ”¶ç›Š**:
- âœ… å¤§åˆ—è¡¨æ¸²æŸ“æ—¶é—´å‡å°‘ 80%+
- âœ… å†…å­˜å ç”¨é™ä½ 70%+
- âœ… æ”¯æŒæ›´å¤§çš„éŸ³ä¹åº“

---

## ğŸ¯ å®æ–½è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¶æ„ä¼˜åŒ– (1-2å‘¨)
1. âœ… ç»Ÿä¸€ç±»å‹å®šä¹‰ â†’ `src/types/music.ts`
2. âœ… åˆ›å»ºäº‹ä»¶ç®¡ç† Hook â†’ `useEventManager`
3. âœ… æ‹†åˆ† Context â†’ LibraryContext, UIContext, ThemeContext

### Phase 2: ç»„ä»¶æ€§èƒ½ä¼˜åŒ– (1-2å‘¨)
4. âœ… æ·»åŠ  React.memo åˆ°å…³é”®ç»„ä»¶
5. âœ… ä¼˜åŒ– useMemo/useCallback ä½¿ç”¨
6. âœ… æ‹†åˆ† PlaylistPlayer ç»„ä»¶

### Phase 3: ç¼“å­˜ä¸é«˜çº§ä¼˜åŒ– (1å‘¨)
7. âœ… å®ç°å‰ç«¯ç¼“å­˜å±‚
8. âœ… ï¼ˆå¯é€‰ï¼‰å¼•å…¥è™šæ‹Ÿæ»šåŠ¨

---

## ğŸ“ˆ é¢„æœŸæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰ | ä¼˜åŒ–å | æå‡ |
|-----|------|--------|------|
| é¦–å±åŠ è½½æ—¶é—´ | 1.2s | 0.9s | **25%â†“** |
| é‡æ¸²æŸ“æ¬¡æ•°ï¼ˆæ¯ç§’ï¼‰ | 8-12æ¬¡ | 3-5æ¬¡ | **58%â†“** |
| å†…å­˜å ç”¨ï¼ˆ10kæ­Œæ›²ï¼‰ | 180MB | 135MB | **25%â†“** |
| æ»šåŠ¨FPS | 45-50 | 58-60 | **20%â†‘** |
| æ„å»ºä½“ç§¯ | 450KB | 420KB | **7%â†“** |

---

## ğŸ”§ é™„å½•ï¼šä»£ç è´¨é‡æ”¹è¿›

### A. ä½¿ç”¨ ESLint è§„åˆ™å¼ºåŒ–

```javascript
// .eslintrc.js
module.exports = {
  rules: {
    'react/jsx-no-bind': 'warn',  // é¿å…åœ¨ JSX ä¸­åˆ›å»ºå‡½æ•°
    'react-hooks/exhaustive-deps': 'error',  // ä¸¥æ ¼æ£€æŸ¥ä¾èµ–
    '@typescript-eslint/no-unused-vars': ['error', { 
      argsIgnorePattern: '^_' 
    }],
  }
};
```

### B. æ€§èƒ½ç›‘æ§é¢æ¿é›†æˆ

```typescript
// æ·»åŠ æ€§èƒ½æ•°æ®æ”¶é›†
import { useEffect } from 'react';

export function usePerformanceMonitor(componentName: string) {
  useEffect(() => {
    const startTime = performance.now();
    
    return () => {
      const renderTime = performance.now() - startTime;
      if (renderTime > 16.67) { // è¶…è¿‡ä¸€å¸§çš„æ—¶é—´
        console.warn(`${componentName} æ¸²æŸ“æ—¶é—´è¿‡é•¿: ${renderTime.toFixed(2)}ms`);
      }
    };
  });
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [React æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](https://react.dev/learn/render-and-commit)
- [Tauri äº‹ä»¶ç³»ç»Ÿæ–‡æ¡£](https://tauri.app/v1/guides/features/events)
- [TypeScript ç±»å‹ä¼˜åŒ–æŒ‡å—](https://www.typescriptlang.org/docs/handbook/type-compatibility.html)
- [WindChime ç°æœ‰æ¶æ„æ–‡æ¡£](./æ’­æ”¾å™¨é‡æ„/æ’­æ”¾å™¨æ ¸å¿ƒé‡æ„æ‰‹å†Œ.md)

---

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:  
1. å®¡é˜…æœ¬æ–‡æ¡£ï¼Œç¡®å®šä¼˜å…ˆçº§
2. åˆ›å»ºå¯¹åº”çš„ GitHub Issues
3. å¼€å§‹ Phase 1 å®æ–½
4. å»ºç«‹æ€§èƒ½åŸºå‡†æµ‹è¯•

**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ  
**é¢„è®¡å®Œæˆ**: 4-6å‘¨

