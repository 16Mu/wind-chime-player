# "ä¸‹ä¸€é¦–" åæ— æ³• Seek é—®é¢˜ä¿®å¤

> **æ—¥æœŸ**: 2025-10-06  
> **é—®é¢˜**: ç‚¹å‡»"ä¸‹ä¸€é¦–"æˆ–"è‡ªåŠ¨ä¸‹ä¸€é¦–"åï¼Œseek åŠŸèƒ½å¤±æ•ˆ  
> **çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

### ç—‡çŠ¶
1. åœ¨éŸ³ä¹åº“é€‰æ‹©éŸ³ä¹æ’­æ”¾ â†’ seek æ­£å¸¸ âœ…
2. ç‚¹å‡»"ä¸‹ä¸€é¦–"æˆ–"è‡ªåŠ¨ä¸‹ä¸€é¦–" â†’ seek å¤±è´¥ âŒ
   - æ‹–åŠ¨è¿›åº¦æ¡æ— å“åº”
   - ç‚¹å‡»æ­Œè¯æ— æ³•è·³è½¬
   - Rust seek å‘½ä»¤å¤±è´¥ï¼ˆæµå¼æ’­æ”¾ä¸æ”¯æŒï¼‰

### å¤ç°æ­¥éª¤
```
1. æ’­æ”¾ä»»æ„æ­Œæ›² (æ­£å¸¸)
2. ç‚¹å‡» "ä¸‹ä¸€é¦–" æŒ‰é’®
3. å°è¯•æ‹–åŠ¨è¿›åº¦æ¡ â†’ å¤±è´¥ï¼
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜åˆ†æ

**æ­£å¸¸æ’­æ”¾æµç¨‹**ï¼ˆä»éŸ³ä¹åº“ç‚¹å‡»ï¼‰:
```
ç”¨æˆ·ç‚¹å‡»æ­Œæ›²
  â†“
App.tsx è°ƒç”¨ hybridPlayer.play(track)
  â†“
1. Rust æµå¼æ’­æ”¾å¯åŠ¨ (100ms)
2. åå° Web Audio åŠ è½½å¯åŠ¨ (800ms)
3. è‡ªåŠ¨åˆ‡æ¢åˆ° Web Audio
  â†“
âœ… Seek å¯ç”¨ï¼ˆWeb Audio æ”¯æŒ 0 å»¶è¿Ÿ seekï¼‰
```

**"ä¸‹ä¸€é¦–" æµç¨‹**ï¼ˆé—®é¢˜åœºæ™¯ï¼‰:
```
ç”¨æˆ·ç‚¹å‡» "ä¸‹ä¸€é¦–"
  â†“
hybridPlayer.next() â†’ invoke('player_next')
  â†“
Rust æ’­æ”¾ä¸‹ä¸€é¦–
  â†“
è§¦å‘ player-track-changed äº‹ä»¶
  â†“
âŒ åå° Web Audio åŠ è½½æœªå¯åŠ¨ï¼
  â†“
âŒ Seek å¤±è´¥ï¼ˆåªæœ‰ Rustï¼Œä¸æ”¯æŒ seekï¼‰
```

### æ ¸å¿ƒé—®é¢˜
**`hybridPlayer.next()` åªè°ƒç”¨äº† Rust çš„ `player_next`ï¼Œæ²¡æœ‰å¯åŠ¨åå° Web Audio åŠ è½½ä»»åŠ¡ã€‚**

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ”¹ `hybridPlayer.play()` - æ”¯æŒä»…åå°åŠ è½½æ¨¡å¼

**æ–‡ä»¶**: `src/services/hybridPlayer.ts`

æ·»åŠ  `skipRustPlay` å‚æ•°ï¼Œå…è®¸ä»…å¯åŠ¨åå°åŠ è½½è€Œä¸é‡æ–°æ’­æ”¾ï¼š

```typescript
async play(track: Track, playlist: Track[] = [], skipRustPlay: boolean = false): Promise<boolean> {
  // ğŸ”¥ å¦‚æœè·³è¿‡ Rust æ’­æ”¾ï¼ˆä»…åå°åŠ è½½æ¨¡å¼ï¼‰
  if (skipRustPlay) {
    console.log(`ğŸ”„ [HybridPlayer] ä»…å¯åŠ¨åå°åŠ è½½æ¨¡å¼ (track ${track.id})`);
    
    // æ›´æ–°çŠ¶æ€
    this.currentTrackId = track.id;
    this.currentTrack = track;
    this.shouldCancelLoading = false;
    this.pendingSeekPosition = null;
    this.playStartTime = performance.now();
    this.currentEngine = 'rust';
    this.isWebAudioReady = false;
    
    // ğŸš€ ç›´æ¥å¯åŠ¨åå°åŠ è½½
    this.webAudioStartTime = performance.now();
    console.log(`ğŸ’¾ [HybridPlayer] å¯åŠ¨åå° Web Audio åŠ è½½...`);
    this.currentLoadingTask = this.loadWebAudioInBackground(track);
    
    return true;
  }
  
  // ... æ­£å¸¸æ’­æ”¾æµç¨‹
}
```

### 2. ç›‘å¬ `player-track-changed` äº‹ä»¶

**æ–‡ä»¶**: `src/components/PlaylistPlayer.tsx`

åœ¨æ­Œæ›²åˆ‡æ¢æ—¶è‡ªåŠ¨å¯åŠ¨åå°åŠ è½½ï¼š

```typescript
useEffect(() => {
  let lastLoadedTrackId: number | null = null;
  
  const unlistenTrackChanged = listen('player-track-changed', async (event: any) => {
    const newTrack = event.payload;
    if (newTrack && newTrack.id) {
      console.log('ğŸ”„ [PlaylistPlayer] æ­Œæ›²åˆ‡æ¢:', newTrack.title, 'ID:', newTrack.id);
      
      // ğŸ”¥ é¿å…é‡å¤åŠ è½½åŒä¸€é¦–æ­Œ
      if (newTrack.id !== lastLoadedTrackId) {
        lastLoadedTrackId = newTrack.id;
        
        // ğŸ”¥ å»¶è¿Ÿ 100ms åå¯åŠ¨åå°åŠ è½½ï¼ˆè®© Rust å…ˆå¼€å§‹æ’­æ”¾ï¼‰
        setTimeout(async () => {
          try {
            const { hybridPlayer } = await import('../services/hybridPlayer');
            // ğŸ”¥ ä½¿ç”¨ skipRustPlay=true ä»…å¯åŠ¨åå°åŠ è½½ï¼Œä¸é‡æ–°æ’­æ”¾
            console.log('ğŸµ [PlaylistPlayer] å¯åŠ¨åå° Web Audio åŠ è½½...');
            await hybridPlayer.play(newTrack, [], true);
          } catch (error) {
            console.error('âŒ [PlaylistPlayer] å¯åŠ¨åå°åŠ è½½å¤±è´¥:', error);
          }
        }, 100);
      }
    }
  });
  
  return () => {
    unlistenTrackChanged.then(fn => fn());
  };
}, []);
```

---

## ğŸ¯ ä¿®å¤åçš„æµç¨‹

### "ä¸‹ä¸€é¦–" å®Œæ•´æµç¨‹
```
ç”¨æˆ·ç‚¹å‡» "ä¸‹ä¸€é¦–"
  â†“
hybridPlayer.next() â†’ invoke('player_next')
  â†“
Rust æ’­æ”¾ä¸‹ä¸€é¦– (100ms)
  â†“
è§¦å‘ player-track-changed äº‹ä»¶
  â†“
PlaylistPlayer ç›‘å¬åˆ°äº‹ä»¶
  â†“
å»¶è¿Ÿ 100ms åè°ƒç”¨ hybridPlayer.play(track, [], true)
  â†“
âœ… åå° Web Audio åŠ è½½å¯åŠ¨ (800ms)
  â†“
âœ… è‡ªåŠ¨åˆ‡æ¢åˆ° Web Audio
  â†“
âœ… Seek å¯ç”¨ï¼ˆ0 å»¶è¿Ÿï¼‰
```

---

## ğŸ“Š é¢„æœŸæ—¥å¿—

### æ­£å¸¸çš„ "ä¸‹ä¸€é¦–" + Seek æ—¥å¿—

```
ğŸ”„ [PlaylistPlayer] æ­Œæ›²åˆ‡æ¢: å’Œä½  ID: 3
ğŸµ [PlaylistPlayer] å¯åŠ¨åå° Web Audio åŠ è½½...
ğŸ”„ [HybridPlayer] ä»…å¯åŠ¨åå°åŠ è½½æ¨¡å¼ (track 3: å’Œä½ )
ğŸ’¾ [HybridPlayer] å¯åŠ¨åå° Web Audio åŠ è½½...
ğŸ”§ [HybridPlayer] T+0ms - åå°ä»»åŠ¡å¯åŠ¨: Web Audio å®Œæ•´è§£ç  (track 3)
ğŸ“‚ [HybridPlayer] T+211ms - æ–‡ä»¶è¯»å–å®Œæˆ (è€—æ—¶: 211ms) (track 3)
ğŸ”Š [HybridPlayer] T+211ms - å¼€å§‹å®Œæ•´è§£ç ... (track 3)
âœ… [HybridPlayer] T+643ms - Web Audio åŠ è½½å®Œæˆ (æ€»è€—æ—¶: 643ms) (track 3)
ğŸ”„ [HybridPlayer] T+643ms - å¼€å§‹åˆ‡æ¢å¼•æ“... (track 3)
ğŸ“Š [HybridPlayer] T+645ms - è·å– Rust æ’­æ”¾ä½ç½®: 1523ms (è€—æ—¶: 2ms)
â¹ï¸ [HybridPlayer] T+647ms - Rust æ’­æ”¾å™¨å·²åœæ­¢ (è€—æ—¶: 2ms)
âœ… [HybridPlayer] T+651ms - Web Audio æ’­æ”¾å¯åŠ¨ (è€—æ—¶: 4ms)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‰ [HybridPlayer] T+651ms - å¼•æ“åˆ‡æ¢å®Œæˆï¼ Rust â†’ Web Audio (åˆ‡æ¢è€—æ—¶: 8ms)
ğŸ¯ [HybridPlayer] T+651ms - âš¡ ç°åœ¨æ”¯æŒ 0 å»¶è¿Ÿ seek (<10ms)ï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç”¨æˆ·æ‹–åŠ¨è¿›åº¦æ¡...
ğŸ” [HybridPlayer] Seek è¯·æ±‚: 78.61s (78608ms) {
  currentEngine: 'webaudio',
  isWebAudioReady: true,
  willUse: 'Web Audio'
}
âš¡ [HybridPlayer] Seek â†’ 78.61s [å¼•æ“: Web Audio] [è€—æ—¶: 3ms] âœ¨ 0 å»¶è¿Ÿ!
```

---

## âœ… æµ‹è¯•æ¸…å•

### åœºæ™¯ 1: æ‰‹åŠ¨ "ä¸‹ä¸€é¦–"
- [ ] æ’­æ”¾æ­Œæ›² A
- [ ] ç‚¹å‡» "ä¸‹ä¸€é¦–" â†’ æ’­æ”¾æ­Œæ›² B
- [ ] ç­‰å¾… 1 ç§’ï¼ˆWeb Audio åŠ è½½å®Œæˆï¼‰
- [ ] æ‹–åŠ¨è¿›åº¦æ¡ â†’ âœ… åº”è¯¥ç«‹å³è·³è½¬ï¼ˆ< 10msï¼‰

### åœºæ™¯ 2: è‡ªåŠ¨ "ä¸‹ä¸€é¦–"
- [ ] æ’­æ”¾æ­Œæ›² A
- [ ] ç­‰å¾…æ­Œæ›²æ’­æ”¾å®Œæ¯• â†’ è‡ªåŠ¨æ’­æ”¾æ­Œæ›² B
- [ ] ç­‰å¾… 1 ç§’ï¼ˆWeb Audio åŠ è½½å®Œæˆï¼‰
- [ ] æ‹–åŠ¨è¿›åº¦æ¡ â†’ âœ… åº”è¯¥ç«‹å³è·³è½¬

### åœºæ™¯ 3: å¿«é€Ÿè¿ç»­ "ä¸‹ä¸€é¦–"
- [ ] å¿«é€Ÿç‚¹å‡» "ä¸‹ä¸€é¦–" 3 æ¬¡
- [ ] ç­‰å¾… 1 ç§’
- [ ] æ‹–åŠ¨è¿›åº¦æ¡ â†’ âœ… åº”è¯¥ç«‹å³è·³è½¬

### åœºæ™¯ 4: "ä¸Šä¸€é¦–"
- [ ] æ’­æ”¾æ­Œæ›² B
- [ ] ç‚¹å‡» "ä¸Šä¸€é¦–" â†’ æ’­æ”¾æ­Œæ›² A
- [ ] ç­‰å¾… 1 ç§’
- [ ] æ‹–åŠ¨è¿›åº¦æ¡ â†’ âœ… åº”è¯¥ç«‹å³è·³è½¬

---

## ğŸ‰ ä¿®å¤æ•ˆæœ

| æ“ä½œ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|-------|-------|
| éŸ³ä¹åº“æ’­æ”¾ | âœ… Seek å¯ç”¨ | âœ… Seek å¯ç”¨ |
| ç‚¹å‡»ä¸‹ä¸€é¦– | âŒ Seek å¤±è´¥ | âœ… Seek å¯ç”¨ (1ç§’å) |
| è‡ªåŠ¨ä¸‹ä¸€é¦– | âŒ Seek å¤±è´¥ | âœ… Seek å¯ç”¨ (1ç§’å) |
| ç‚¹å‡»ä¸Šä¸€é¦– | âŒ Seek å¤±è´¥ | âœ… Seek å¯ç”¨ (1ç§’å) |

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `src/services/hybridPlayer.ts`
   - æ·»åŠ  `skipRustPlay` å‚æ•°
   - æ”¯æŒä»…åå°åŠ è½½æ¨¡å¼

2. `src/components/PlaylistPlayer.tsx`
   - ç›‘å¬ `player-track-changed` äº‹ä»¶
   - è‡ªåŠ¨å¯åŠ¨åå° Web Audio åŠ è½½

### ç›¸å…³æ–‡æ¡£
- `docs/æ··åˆæ’­æ”¾å™¨-Seeké—®é¢˜ä¿®å¤.md` - åŸå§‹ Seek é—®é¢˜ä¿®å¤
- `docs/æ··åˆæ’­æ”¾å™¨æ¶æ„è¯´æ˜.md` - æ··åˆæ’­æ”¾å™¨æ¶æ„
- `docs/å¯¹è¯æ€»ç»“-æ··åˆæ’­æ”¾å™¨å®ç°.md` - å®ç°æ€»ç»“

---

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### 1. äº‹ä»¶é©±åŠ¨æ¶æ„
åˆ©ç”¨ Tauri çš„ `player-track-changed` äº‹ä»¶ï¼Œåœ¨æ­Œæ›²åˆ‡æ¢æ—¶è‡ªåŠ¨è§¦å‘åå°åŠ è½½ã€‚

### 2. å»¶è¿ŸåŠ è½½
å»¶è¿Ÿ 100ms å¯åŠ¨åå°åŠ è½½ï¼Œç¡®ä¿ Rust æµå¼æ’­æ”¾å·²ç»å¼€å§‹ï¼Œé¿å…å†²çªã€‚

### 3. é˜²é‡å¤åŠ è½½
ä½¿ç”¨ `lastLoadedTrackId` è·Ÿè¸ªï¼Œé¿å…åŒä¸€é¦–æ­Œé‡å¤åŠ è½½ã€‚

### 4. å‚æ•°åŒ–æ§åˆ¶
é€šè¿‡ `skipRustPlay` å‚æ•°ï¼Œå¤ç”¨ `play()` æ–¹æ³•ï¼Œé¿å…ä»£ç é‡å¤ã€‚

---

## ğŸš€ åç»­ä¼˜åŒ–

### å¯èƒ½çš„æ”¹è¿›æ–¹å‘
1. **é¢„åŠ è½½ä¸‹ä¸€é¦–**: åœ¨å½“å‰æ­Œæ›²æ’­æ”¾åˆ° 80% æ—¶ï¼Œé¢„åŠ è½½ä¸‹ä¸€é¦–çš„ Web Audio
2. **æ™ºèƒ½ç¼“å­˜**: ç¼“å­˜æœ€è¿‘æ’­æ”¾çš„ 3-5 é¦–æ­Œæ›²çš„ Web Audio æ•°æ®
3. **åŠ è½½ä¼˜å…ˆçº§**: æ ¹æ®ç”¨æˆ·è¡Œä¸ºï¼ˆé¢‘ç¹åˆ‡æ­Œ vs å®Œæ•´æ’­æ”¾ï¼‰è°ƒæ•´åŠ è½½ç­–ç•¥

---

**ä¿®å¤å®Œæˆï¼** ğŸ‰



