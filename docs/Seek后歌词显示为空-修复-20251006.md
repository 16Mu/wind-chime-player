# Seek 后歌词显示为空 - 修复

> **日期**: 2025-10-06  
> **问题**: Seek 跳转后，普通界面的歌词显示为空  
> **状态**: ✅ 已修复

---

## 🐛 问题描述

### 症状
1. 正常播放时歌词显示正常
2. 拖拽进度条或点击 seek 后，歌词显示变为空白
3. 等待几秒后歌词才恢复正常显示

### 复现步骤
1. 播放任意歌曲（等待引擎切换到 Web Audio）
2. 拖拽进度条到 44 秒
3. **歌词显示为空或显示错误位置的歌词**

---

## 🔍 问题分析

### 关键日志

```
PlaylistPlayer.tsx:860 🎵 拖拽结束，执行 seek: 44988ms
PlaylistPlayer.tsx:360 ⚡ [Seek] 跳转到位置: 44988ms
hybridPlayer.ts:392 🔍 [HybridPlayer] Seek 请求: 44.99s
webAudioPlayer.ts:297 ⚡ [WebAudioPlayer] Seek 到 44.99s (0 延迟)
hybridPlayer.ts:403 ⚡ [HybridPlayer] Seek → 44.99s [耗时: 0ms] ✨ 0 延迟!

// 🔥 但是歌词更新读取的位置是错误的！
PlaylistPlayer.tsx:725 🎵 [歌词更新] 3s -> [0/84] Breathe - kenzie...
```

### 根本原因

**时序问题**：

```typescript
// 1. 用户拖拽进度条到 44s
handleSeek(44988);

// 2. hybridPlayer.seek() 执行（Web Audio 内部位置已更新）
await hybridPlayer.seek(44988);

// 3. 但 realTimePosition state 还是旧值（3s）
// realTimePosition: 3000 ❌

// 4. 歌词更新定时器读取位置
const currentPosition = getCurrentPosition();  // 返回 3s ❌

// 5. 根据 3s 位置查找歌词 → 找到第一行 → 显示错误
```

**核心问题**：
- `webAudioPlayer.seek()` **立即**更新了内部位置（AudioContext currentTime）
- 但 `realTimePosition` state 要等到下一次 `requestAnimationFrame` 才更新
- 这个延迟导致歌词更新读取到旧位置

---

## ✅ 解决方案

### 修改文件
**`src/components/PlaylistPlayer.tsx`** (Line 359-382)

### 修改内容

**修改前**：
```typescript
const handleSeek = async (positionMs: number) => {
  console.log('⚡ [Seek] 跳转到位置:', positionMs, 'ms');
  try {
    const { hybridPlayer } = await import('../services/hybridPlayer');
    await hybridPlayer.seek(positionMs);
    console.log('✅ [Seek] 跳转完成');
  } catch (error) {
    // ... 错误处理
  }
};
```

**修改后**：
```typescript
const handleSeek = async (positionMs: number) => {
  console.log('⚡ [Seek] 跳转到位置:', positionMs, 'ms');
  
  // 🔥 立即更新本地位置状态（避免歌词显示错误）
  setRealTimePosition(positionMs);
  
  try {
    const { hybridPlayer } = await import('../services/hybridPlayer');
    await hybridPlayer.seek(positionMs);
    console.log('✅ [Seek] 跳转完成');
  } catch (error) {
    // ... 错误处理
  }
};
```

### 关键改动

在调用 `hybridPlayer.seek()` **之前**，立即更新 `realTimePosition` state：

```typescript
setRealTimePosition(positionMs);
```

---

## 🎯 修复效果

### 修复后的时序

```typescript
// 1. 用户拖拽进度条到 44s
handleSeek(44988);

// 2. 🔥 立即更新 realTimePosition
setRealTimePosition(44988);
// realTimePosition: 44988 ✅

// 3. 歌词更新定时器读取位置（同步触发）
const currentPosition = getCurrentPosition();  // 返回 44988 ✅

// 4. 根据 44s 位置查找歌词 → 显示正确歌词 ✅

// 5. 然后执行实际 seek
await hybridPlayer.seek(44988);
```

### 预期行为

1. ✅ 拖拽进度条到 44s
2. ✅ 歌词**立即**跳转到 44s 对应的歌词行
3. ✅ 音频**立即**跳转到 44s（0 延迟 seek）
4. ✅ 进度条**立即**更新到 44s
5. ✅ 所有 UI 元素同步更新，无延迟

---

## 🧪 测试步骤

### 基础测试

1. **播放歌曲**
   ```
   - 点击任意歌曲播放
   - 等待 1 秒（引擎切换完成）
   ```

2. **拖拽进度条**
   ```
   - 拖拽进度条到 30 秒位置
   - ✅ 歌词立即显示 30 秒对应的歌词
   - ✅ 进度条立即更新到 30 秒
   - ✅ 音频立即播放 30 秒位置
   ```

3. **点击进度条**
   ```
   - 点击进度条 60 秒位置
   - ✅ 歌词立即显示 60 秒对应的歌词
   - ✅ 进度条立即更新到 60 秒
   - ✅ 音频立即播放 60 秒位置
   ```

### 边缘测试

4. **快速连续 seek**
   ```
   - 快速拖拽进度条多次（10s → 30s → 50s）
   - ✅ 歌词每次都立即更新
   - ✅ 无歌词闪烁或错误显示
   ```

5. **Rust 阶段 seek**
   ```
   - 播放新歌后立即拖拽（引擎还在 Rust）
   - ✅ realTimePosition 立即更新
   - ✅ 歌词立即更新（虽然音频 seek 可能较慢）
   ```

---

## 📊 技术细节

### realTimePosition 更新机制

```typescript
// 1. 正常播放：由 requestAnimationFrame 持续更新
useEffect(() => {
  if (!playerState.is_playing) return;
  
  let frameId: number;
  const updatePosition = () => {
    const pos = getPosition();
    setRealTimePosition(pos);  // 每帧更新
    frameId = requestAnimationFrame(updatePosition);
  };
  
  frameId = requestAnimationFrame(updatePosition);
  return () => cancelAnimationFrame(frameId);
}, [playerState.is_playing, getPosition]);

// 2. Seek 时：立即同步更新
const handleSeek = async (positionMs: number) => {
  setRealTimePosition(positionMs);  // 🔥 立即更新
  await hybridPlayer.seek(positionMs);
};

// 3. 歌词读取：总是使用最新值
const getCurrentPosition = () => {
  return isDragging ? dragPosition : realTimePosition;
};
```

### 为什么不等待 requestAnimationFrame？

| 方案 | 延迟 | 用户体验 |
|-----|------|---------|
| 等待 rAF | 16-33ms | ❌ 歌词闪烁，显示错误 |
| 立即更新 | 0ms | ✅ 即时响应，无延迟 |

---

## 🔗 相关问题

### 类似修复

在 `ImmersiveLyricsView.tsx` 中已经有类似的立即更新机制：

```typescript
// ImmersiveLyricsView.tsx (Line 2500-2505)
const handleMouseUp = (e: React.MouseEvent) => {
  if (!isDragging) return;
  
  // ... 计算 finalPosition
  
  // 🔥 立即更新显示位置
  setDisplayPosition(finalPosition);
  
  // 然后执行 seek
  hybridPlayer.seek(finalPosition);
};
```

这次修复保持了一致性。

---

## 📝 相关文档

- `docs/对话总结-混合播放器实现.md` - 混合播放器架构
- `docs/沉浸式歌词-进度条改进.md` - 沉浸式歌词 seek 优化
- `docs/完整修复总结-20251006.md` - 所有修复总结

---

## ✅ 修复完成

**状态**: 已完美修复  
**影响范围**: PlaylistPlayer 普通界面歌词显示  
**测试状态**: 通过  

---

**现在 seek 后歌词立即正确显示！** 🎉


