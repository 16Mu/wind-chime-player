# 混合播放器架构说明

> 双引擎设计：Rust 流式 + Web Audio 完整加载  
> 日期: 2025-10-06  
> 版本: v0.4.0.1

---

## 🎯 设计目标

解决两个矛盾的需求：
1. **立即播放** - 点击后 < 100ms 就能听到声音
2. **快速 Seek** - Seek 跳转 < 10ms（0 延迟）

---

## 🏗️ 架构设计

### 三阶段播放流程

```
用户点击播放
    ↓
┌─────────────────────────────────┐
│ 阶段 1: Rust 流式播放（立即）     │
│ - 耗时: 100ms                    │
│ - 用户听到声音！                 │
└─────────────────────────────────┘
    ↓（同时进行）
┌─────────────────────────────────┐
│ 阶段 2: Web Audio 后台加载       │
│ - 耗时: 643ms                    │
│ - 文件读取: 211ms                │
│ - 解码: 432ms                    │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 阶段 3: 自动切换引擎              │
│ - 无缝切换到 Web Audio           │
│ - 现在支持 0 延迟 seek！          │
└─────────────────────────────────┘
```

---

## 💡 核心机制

### 引擎切换逻辑

```typescript
// hybridPlayer.ts
async play(track: Track) {
  // 1. 立即启动 Rust 流式播放（100ms）
  await invoke('player_play', { trackId: track.id });
  console.log('✅ 用户可以听到声音了！');
  
  // 2. 后台加载 Web Audio（643ms）
  this.loadWebAudioInBackground(track);
}

async loadWebAudioInBackground(track: Track) {
  // 完整解码
  await webAudioPlayer.loadTrack(track);
  
  // 获取当前播放位置
  const position = await invoke('get_current_position');
  
  // 停止 Rust，切换到 Web Audio
  await invoke('player_stop');
  await webAudioPlayer.seek(position / 1000);
  await webAudioPlayer.play();
  
  this.currentEngine = 'webaudio';
  console.log('✅ 引擎切换完成！现在支持 0 延迟 seek！');
}
```

### Seek 智能路由

```typescript
async seek(positionMs: number) {
  if (this.currentEngine === 'webaudio' && this.isWebAudioReady) {
    // Web Audio: 0 延迟
    await webAudioPlayer.seek(positionMs / 1000);
    console.log('⚡ Seek (0 延迟)');
  } else {
    // Rust: 正常 seek
    await invoke('player_seek', { positionMs });
    console.log('⚡ Seek (Rust)');
  }
}
```

---

## 📊 性能对比

| 阶段 | 操作 | 耗时 | 用户体验 |
|------|------|------|---------|
| **阶段 1** | Rust 流式启动 | 100ms | ✅ 立即听到声音 |
| **阶段 2** | Web Audio 后台加载 | 643ms | ⏳ 用户无感知 |
| **阶段 3** | 引擎自动切换 | < 50ms | ✅ 无缝切换 |
| **总启动时间** | - | **100ms** | ⚡ 极快！ |
| **Seek（初期）** | Rust seek | 200-500ms | ✅ 可用 |
| **Seek（切换后）** | Web Audio seek | < 10ms | ⚡ 0 延迟 |

---

## 🎯 用户体验时间线

```
0ms      - 用户点击播放
100ms    - 🎵 听到声音（Rust 流式播放）
643ms    - 💾 Web Audio 后台加载完成
693ms    - 🔄 自动切换到 Web Audio
         - ✅ 现在支持 0 延迟 seek
```

**关键优势**：
- 用户等待时间：**100ms**（不是 643ms！）
- Seek 延迟：初期 200-500ms → 0.7 秒后 < 10ms

---

## 🔧 技术实现

### 文件结构

```
src/services/
├── hybridPlayer.ts        # 混合播放器（新）
├── webAudioPlayer.ts      # Web Audio 引擎
└── playbackControl.ts     # 播放控制 API（废弃）
```

### 核心类

```typescript
export class HybridPlayer {
  private currentEngine: 'rust' | 'webaudio';
  private isWebAudioReady: boolean;
  
  async play(track, playlist)    // 播放（双引擎）
  async pause()                  // 暂停（智能路由）
  async resume()                 // 继续（智能路由）
  async seek(positionMs)         // Seek（智能路由）
  async setVolume(volume)        // 音量（双引擎）
  async next()                   // 下一首（智能路由）
  async previous()               // 上一首（智能路由）
  
  getCurrentEngine()             // 获取当前引擎
  isWebAudioEngineReady()        // Web Audio 是否就绪
}
```

---

## 📝 集成点

### 已修改的文件

1. **src/App.tsx**
   - 使用 `hybridPlayer.play()` 替代直接播放

2. **src/components/PlaylistPlayer.tsx**
   - 所有控制按钮使用 `hybridPlayer`
   - 暂停、继续、下一首、上一首、seek、音量

3. **src/components/ImmersiveLyricsView.tsx**
   - 进度条 seek 使用 `hybridPlayer`
   - 歌词点击 seek 使用 `hybridPlayer`

4. **src/contexts/PlaybackContext.tsx**
   - 初始化 `hybridPlayer`
   - 监听引擎切换事件

5. **src-tauri/src/lib.rs**
   - 新增 `get_current_position` 命令
   - 支持引擎切换时获取位置

---

## 🎉 预期效果

### 播放流程

```
用户点击播放
  ↓ (100ms)
🎵 听到声音（Rust 流式播放）
  ↓ (543ms 后台加载)
💾 Web Audio 加载完成
  ↓ (自动切换)
✅ 现在支持 0 延迟 seek
```

### Seek 流程

```
用户拖动进度条 / 点击歌词
  ↓
检查当前引擎
  ├─ Rust: 使用 Rust seek (200-500ms)
  └─ Web Audio: 0 延迟 seek (< 10ms)
```

---

## 🚀 下一步优化

### v0.4.1 计划

1. **智能预测切换时机**
   - 分析用户行为
   - 如果用户经常 seek，提前切换

2. **WebDAV 支持**
   - WebDAV 也使用混合策略
   - 流式播放 + 后台完整下载

3. **可视化引擎状态**
   - 显示当前使用的引擎
   - 显示 Web Audio 加载进度

4. **内存管理**
   - 智能释放不再播放的歌曲
   - LRU 缓存策略

---

**混合播放器 - 兼顾速度与体验的最佳方案** 🎵








