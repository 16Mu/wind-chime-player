# 立即修复 - 代码片段

> 直接复制粘贴的修复代码  
> 给新对话窗口

---

## 修复 1: 同步 currentTrack

**文件**: `src/components/PlaylistPlayer.tsx`

在文件开头的 imports 后，找到 `const PlaylistPlayer = ...` 函数内部，添加：

```typescript
// 🔥 监听歌曲切换事件，同步 currentTrack
useEffect(() => {
  const unlistenTrackChanged = listen('player-track-changed', (event: any) => {
    const newTrack = event.payload;
    if (newTrack && newTrack.id) {
      setCurrentTrack(newTrack);
      console.log('🔄 [PlaylistPlayer] currentTrack 已同步:', newTrack.title, 'ID:', newTrack.id);
    }
  });
  
  return () => {
    unlistenTrackChanged.then(fn => fn());
  };
}, []);
```

**位置**: 在任何一个 `useEffect` 附近添加即可（约 line 150-200 区域）

---

## 修复 2: 播放/暂停按钮

**文件**: `src/components/PlaylistPlayer.tsx`

已添加 `handlePlayPauseToggle` 函数（line 322-338）

**下一步**: 找到播放/暂停按钮的 JSX 并替换 `onClick`

### 查找方法

搜索关键词：
```
"播放" | "暂停" | "Play" | "Pause" | isPlaying ? 
```

### 可能的代码模式

如果找到类似这样的代码：
```tsx
{playerState.is_playing ? (
  <button onClick={handlePause}>暂停</button>
) : (
  <button onClick={handleResume}>播放</button>
)}
```

或者：
```tsx
<button onClick={playerState.is_playing ? handlePause : handleResume}>
  {playerState.is_playing ? '暂停' : '播放'}
</button>
```

### 统一替换为

```tsx
<button onClick={handlePlayPauseToggle}>
  {playerState.is_playing ? '暂停' : '播放'}
</button>
```

---

## 修复 3: 进度条实时更新

### 步骤 1: 找到进度条渲染

在 `PlaylistPlayer.tsx` 中搜索：
- `ProgressBar`
- `progress`
- `position`

### 步骤 2: 检查数据源

如果是这样：
```tsx
<ProgressBar 
  position={playerState.position_ms}  // ← 错误
  ...
/>
```

### 步骤 3: 修复

添加实时位置获取：
```typescript
// 在 PlaylistPlayer 组件内部添加
const getPosition = usePlaybackPosition();
const [realTimePosition, setRealTimePosition] = useState(0);

useEffect(() => {
  if (!playerState.is_playing) return;
  
  const updatePosition = () => {
    const pos = getPosition();
    setRealTimePosition(pos);
    requestAnimationFrame(updatePosition);
  };
  
  const frameId = requestAnimationFrame(updatePosition);
  return () => cancelAnimationFrame(frameId);
}, [playerState.is_playing, getPosition]);
```

然后：
```tsx
<ProgressBar 
  position={realTimePosition}  // ← 使用实时位置
  ...
/>
```

---

## 🎯 验证修复

### 测试清单

- [ ] **测试 1**: 播放 → 暂停 → 播放 → 从暂停位置继续
- [ ] **测试 2**: 播放 → 下一曲 → 暂停 → 播放 → 播放正确的歌
- [ ] **测试 3**: 播放时观察进度条 → 流畅移动

### 预期日志

```
// 暂停/继续
⏸️ [PlaylistPlayer] 已暂停
▶️ [PlaylistPlayer] 已继续播放

// currentTrack 同步
🔄 [PlaylistPlayer] currentTrack 已同步: 戒烟 ID: 5

// 位置更新（应该频繁出现）
📊 [PlaybackContext] Web Audio 引擎，位置: 1234ms
📊 [PlaybackContext] Web Audio 引擎，位置: 1456ms
```

---

**所有信息已准备完毕！开始修复吧！** 🚀

---

## 🔧 额外修复：Seek 跳转问题

### 问题描述
Seek 跳转无法工作，点击进度条没有反应。

### 根本原因
Rust 流式播放模式下不支持 Seek（为了优化 100ms 启动速度）。Seek 必须等待 Web Audio 引擎就绪（800ms 后）。

### 修复内容

#### 1. 添加调试日志和错误处理

**文件**: `src/services/hybridPlayer.ts`
**位置**: `async seek(positionMs: number)` 方法

已添加：
- 🔍 详细的状态日志（显示当前引擎、是否就绪）
- ⚠️ Rust seek 失败的友好提示
- 💡 引导用户等待 Web Audio 就绪

#### 2. 用户提示

**文件**: `src/components/PlaylistPlayer.tsx`
**位置**: `handleSeek` 函数

已添加：
- 在 Rust 阶段尝试 Seek 时，显示 Toast 提示："正在加载高速跳转功能，请稍候..."
- 其他错误显示具体错误信息

### 预期效果

- **0-800ms**: Seek 失败，显示提示
- **800ms 后**: Seek 成功，< 10ms 响应

### 测试指南

详见 `docs/Seek-测试指南.md`

---

## 🔧 额外修复 2：沉浸式歌词样式优化

### 问题描述
前后歌词也放大和发光，导致视觉焦点不够集中。

### 修复内容

**文件**: `src/components/lyrics/LyricLine.tsx`

已修改：
- ✅ 只有当前歌词放大 120%，其他歌词保持 100%
- ✅ 只有当前歌词发光（textShadow + drop-shadow），其他歌词不发光
- ✅ 只有当前歌词加粗（600）和增加字间距，其他歌词正常（400）
- ✅ 简化过渡动画，其他歌词只需颜色过渡

### 效果

**修改前**：
- 当前歌词 + 前后相邻歌词都有放大和发光 = 视觉焦点分散

**修改后**：
- 只有当前歌词放大和发光 = 视觉焦点集中

详见：`docs/沉浸式歌词-样式优化.md`

---


