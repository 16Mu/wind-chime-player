# 混合播放器 - 问题诊断指南

> 用于诊断状态同步问题  
> 日期: 2025-10-06

---

## 🔍 当前问题

### 问题 1: 播放按钮状态不同步
- 引擎切换后，播放按钮应该是暂停状态（▐▐）
- 但可能还显示播放状态（▶）

### 问题 2: 沉浸式歌词位置停滞
- 进入沉浸式歌词后
- 位置停留在进入时的时刻
- 不再更新

---

## 🔧 诊断步骤

### 1. 启用位置调试日志

在浏览器控制台执行：
```javascript
// 取消注释 PlaybackContext.tsx 中的调试日志
```

临时修改 `src/contexts/PlaybackContext.tsx`:
```typescript
const positionMs = position * 1000;
console.log(`📊 [PlaybackContext] 从 Web Audio 获取位置: ${positionMs.toFixed(0)}ms`);
return positionMs;
```

### 2. 检查引擎状态

在控制台执行：
```javascript
// 检查当前引擎
window.__debugEngine = () => {
  console.log('当前引擎:', currentEngineRef.current);
  console.log('Web Audio 引用:', webAudioPlayerRef.current);
  console.log('isPlaying:', state.isPlaying);
};
window.__debugEngine();
```

### 3. 检查播放状态

观察日志中：
```
✅ [HybridPlayer] T+822ms - Web Audio 播放启动
🎉 T+822ms - 引擎切换完成！
🔄 [PlaybackContext] 引擎切换: webaudio
✅ [PlaybackContext] 现在支持 0 延迟 seek！
```

之后应该看到：
```
🎵 [PlaybackContext] Web Audio 播放状态变化: true  ← 应该有这行！
```

---

## 🐛 可能的问题

### 问题 A: Web Audio 回调未触发

**症状**：
- 看不到 `🎵 [PlaybackContext] Web Audio 播放状态变化`
- 看不到位置更新日志

**原因**：
- WebAudio Player 的回调可能被覆盖了
- hybridPlayer 初始化时可能重新初始化了 webAudioPlayer

**解决**：
已修复 - hybridPlayer 不再重新初始化 webAudioPlayer

### 问题 B: 引擎标志未更新

**症状**：
- 切换后 `getPosition()` 还是从 Rust 获取位置
- 位置停滞

**原因**：
- `currentEngineRef.current` 没有正确更新为 'webaudio'

**解决**：
```typescript
onEngineSwitch: (engine) => {
  // 🔥 更新当前引擎标志
  currentEngineRef.current = engine;  // ← 关键！
}
```

### 问题 C: state.isPlaying 变成 false

**症状**：
- 引擎切换后播放按钮变回播放状态（▶）
- rAF 循环停止

**原因**：
- 停止 Rust 时触发了 state 更新为 false
- Web Audio 的 onPlaybackStateChanged 没有及时更新

**解决**：
```typescript
onEngineSwitch: (engine) => {
  if (engine === 'webaudio') {
    // 🔥 强制设置为 playing
    setState(prev => ({ ...prev, isPlaying: true }));
  }
}
```

---

## ✅ 预期正确的日志

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎵 [HybridPlayer] T+0ms - 播放: 戒烟 (ID: 5)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ T+94ms - Rust 播放器已启动
🎵 T+94ms - 🔊 用户听到声音了！
💾 T+94ms - 【阶段2】后台加载 Web Audio...
✅ [WebAudioPlayer] 文件读取完成 (31773738 字节, 耗时: 317ms)
✅ [WebAudioPlayer] 解码完成！(耗时: 673ms)
✅ T+1084ms - Web Audio 后台加载完成 (track 5)
🔄 T+1084ms - 【阶段3】准备切换引擎...
📊 T+1088ms - 获取 Rust 播放位置: 994ms
⏹️ T+1090ms - Rust 播放器已停止
▶️ [WebAudioPlayer] 开始播放 (偏移: 0.99s)
🎵 [PlaybackContext] Web Audio 播放状态变化: true  ← 关键！
🎉 T+1092ms - 引擎切换完成！
🔄 [PlaybackContext] 引擎切换: webaudio  ← 关键！
🔄 [PlaybackContext] 切换到 Web Audio 位置更新  ← 关键！

（之后每帧都应该从 Web Audio 获取位置）
```

---

## 🚀 快速测试

### 测试步骤

1. **刷新页面**
2. **点击播放** "戒烟"
3. **等待 1 秒** - 观察引擎切换日志
4. **观察播放按钮** - 应该保持暂停状态（▐▐）
5. **观察进度条** - 应该持续更新
6. **进入沉浸式歌词** - 歌词应该滚动

### 预期结果

#### ✅ 播放按钮
- Rust 阶段：▐▐（暂停按钮）
- 切换后：▐▐（保持暂停按钮）

#### ✅ 进度条
- Rust 阶段：持续更新
- 切换后：持续更新（无停滞）

#### ✅ 沉浸式歌词
- 进入时：显示当前位置的歌词
- 播放中：歌词滚动
- Seek：立即跳转

---

## 🔧 如果还有问题

### 启用详细日志

取消注释 `PlaybackContext.tsx` 中的调试日志：
```typescript
console.log(`📊 [PlaybackContext] 从 Web Audio 获取位置: ${positionMs.toFixed(0)}ms`);
console.log(`📊 [PlaybackContext] 从 Rust 获取位置: ${position.toFixed(0)}ms`);
```

### 检查状态

在控制台执行：
```javascript
// 创建调试函数
window.__debugPlayback = () => {
  const context = document.querySelector('[data-playback-context]');
  console.log('=== 播放器状态 ===');
  console.log('当前引擎:', currentEngineRef?.current);
  console.log('Web Audio 引用:', !!webAudioPlayerRef?.current);
  console.log('isPlaying:', state?.isPlaying);
  console.log('当前位置:', positionRef?.current);
};

// 每秒输出一次
setInterval(() => window.__debugPlayback(), 1000);
```

---

## 📝 已修复的部分

### ✅ 位置获取路由
```typescript
if (currentEngineRef.current === 'webaudio' && webAudioPlayerRef.current) {
  // 从 Web Audio 获取
  return webAudioPlayerRef.current.getPosition() * 1000;
} else {
  // 从 Rust ref 获取
  return positionRef.current;
}
```

### ✅ rAF 强制更新
```typescript
const tick = () => {
  // 🔥 强制从 Web Audio 获取位置并更新 ref
  if (currentEngineRef.current === 'webaudio' && webAudioPlayerRef.current) {
    const position = webAudioPlayerRef.current.getPosition();
    positionRef.current = position * 1000;
  }
  
  setPositionVersion(v => v + 1);  // 触发重渲染
  frameRef.current = requestAnimationFrame(tick);
};
```

### ✅ 引擎切换状态同步
```typescript
onEngineSwitch: (engine) => {
  currentEngineRef.current = engine;
  
  if (engine === 'webaudio') {
    // 确保播放状态为 true
    setState(prev => ({ ...prev, isPlaying: true }));
  }
}
```

---

**刷新页面测试，看看播放按钮和沉浸式歌词是否正常！** 🎯

如果还有问题，启用调试日志并把输出发给我！








