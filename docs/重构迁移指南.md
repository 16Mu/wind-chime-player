# WindChime Player - æ¶æ„é‡æ„è¿ç§»æŒ‡å—

## ğŸ“‹ é‡æ„æ¦‚è§ˆ

æœ¬æ¬¡é‡æ„éµå¾ª**é«˜å†…èšä½è€¦åˆ**çš„è®¾è®¡åŸåˆ™ï¼Œå®Œæˆäº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

### âœ… å·²å®Œæˆçš„é‡æ„

1. **ç»Ÿä¸€ç±»å‹å®šä¹‰** - `src/types/music.ts`
   - æ‰€æœ‰éŸ³ä¹ç›¸å…³ç±»å‹é›†ä¸­ç®¡ç†
   - æ¶ˆé™¤äº†19ä¸ªæ–‡ä»¶ä¸­çš„ç±»å‹é‡å¤

2. **äº‹ä»¶ç®¡ç†ä¼˜åŒ–** - `src/hooks/useEventManager.ts`
   - 4ä¸ªä¸“ç”¨äº‹ä»¶Hookï¼š`useTauriEvent`, `useEventManager`, `useConditionalEvent`, `useOneTimeEvent`
   - è‡ªåŠ¨æ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

3. **çŠ¶æ€åˆ†å±‚æ¶æ„** - Contexté‡æ„
   - `LibraryContext` - éŸ³ä¹åº“çŠ¶æ€ç®¡ç†
   - `UIContext` - UIçŠ¶æ€ç®¡ç†
   - `ThemeContext` - ä¸»é¢˜è®¾ç½®ç®¡ç†
   - App.tsx stateä»18ä¸ªå‡å°‘åˆ°3ä¸ª

4. **å‰ç«¯ç¼“å­˜å±‚** - `src/utils/cache.ts`
   - é€šç”¨ç¼“å­˜ç®¡ç†å™¨
   - ä¸“è¾‘å°é¢ã€æ­Œè¯ã€æœç´¢ç»“æœç¼“å­˜
   - TTLè‡ªåŠ¨è¿‡æœŸæœºåˆ¶

5. **ç»„ä»¶æ€§èƒ½ä¼˜åŒ–**
   - `TracksView.optimized.tsx` - React.memo + è‡ªå®šä¹‰æ¯”è¾ƒ
   - `LibraryPage.refactored.tsx` - ä½¿ç”¨Contextï¼Œå‡å°‘propsä¼ é€’

6. **æ’­æ”¾å™¨ç»„ä»¶æ‹†åˆ†** - ä»1075è¡Œæ‹†åˆ†ä¸º5ä¸ªå­ç»„ä»¶
   - `PlayerControls.tsx` - æ’­æ”¾æ§åˆ¶æŒ‰é’®
   - `ProgressBar.tsx` - è¿›åº¦æ¡
   - `VolumeControl.tsx` - éŸ³é‡æ§åˆ¶
   - `PlayerInfo.tsx` - æ›²ç›®ä¿¡æ¯æ˜¾ç¤º
   - `PlaylistPlayer.refactored.tsx` - ä¸»ç»„ä»¶ï¼ˆ~200è¡Œï¼‰

---

## ğŸš€ è¿ç§»æ­¥éª¤

### Step 1: å¯ç”¨æ–°çš„ç±»å‹ç³»ç»Ÿ

æ‰€æœ‰ç»„ä»¶å¼€å§‹å¯¼å…¥ç»Ÿä¸€ç±»å‹ï¼š

```typescript
// âŒ æ—§æ–¹å¼
interface Track {
  id: number;
  path: string;
  // ...
}

// âœ… æ–°æ–¹å¼
import type { Track, LibraryStats, PlayerState } from '../types/music';
```

### Step 2: æ›¿æ¢App.tsx

```bash
# å¤‡ä»½æ—§æ–‡ä»¶
mv src/App.tsx src/App.tsx.old

# ä½¿ç”¨é‡æ„ç‰ˆæœ¬
mv src/App.refactored.tsx src/App.tsx
```

**å˜æ›´å†…å®¹**ï¼š
- âœ… Contextå±‚çº§ï¼šThemeProvider > UIProvider > LibraryProvider > PlaybackProvider > ToastProvider
- âœ… éŸ³é¢‘é”™è¯¯å¤„ç†ç‹¬ç«‹ä¸º`AudioErrorDialog`ç»„ä»¶
- âœ… çª—å£æ§åˆ¶ä½¿ç”¨`useCallback`ä¼˜åŒ–
- âœ… è‡ªåŠ¨å¯åŠ¨ç¼“å­˜æ¸…ç†

### Step 3: æ›¿æ¢LibraryPage

```bash
mv src/components/LibraryPage.tsx src/components/LibraryPage.tsx.old
mv src/components/LibraryPage.refactored.tsx src/components/LibraryPage.tsx
```

**å˜æ›´å†…å®¹**ï¼š
- âœ… ä½¿ç”¨`useLibrary()`å’Œ`useLibraryStatus()`è·å–æ•°æ®
- âœ… ç§»é™¤é‡å¤çš„äº‹ä»¶ç›‘å¬ï¼ˆå·²åœ¨LibraryContextå¤„ç†ï¼‰
- âœ… Propsä»9ä¸ªå‡å°‘åˆ°2ä¸ªï¼š`onTrackSelect`, `selectedTrackId`

### Step 4: æ›¿æ¢SettingsPage

```bash
mv src/components/SettingsPage.tsx src/components/SettingsPage.tsx.old
mv src/components/SettingsPage.refactored.tsx src/components/SettingsPage.tsx
```

**å˜æ›´å†…å®¹**ï¼š
- âœ… ä½¿ç”¨`useTheme()`è·å–ä¸»é¢˜è®¾ç½®
- âœ… Propsä»6ä¸ªå‡å°‘åˆ°0ä¸ª

### Step 5: æ›¿æ¢PlaylistPlayer

```bash
mv src/components/PlaylistPlayer.tsx src/components/PlaylistPlayer.tsx.old
mv src/components/player/PlaylistPlayer.refactored.tsx src/components/PlaylistPlayer.tsx
```

**å˜æ›´å†…å®¹**ï¼š
- âœ… ç»„ä»¶æ‹†åˆ†ä¸º5ä¸ªå­ç»„ä»¶
- âœ… ä½¿ç”¨`usePlaybackState()`å’Œ`usePlaybackPosition()`
- âœ… ä»£ç è¡Œæ•°ä»1075å‡å°‘åˆ°~200

### Step 6: æ›¿æ¢TracksViewï¼ˆå¯é€‰æ€§èƒ½ä¼˜åŒ–ï¼‰

```bash
mv src/components/TracksView.tsx src/components/TracksView.tsx.old
mv src/components/TracksView.optimized.tsx src/components/TracksView.tsx
```

**å˜æ›´å†…å®¹**ï¼š
- âœ… React.memoåŒ…è£¹
- âœ… useCallbackä¼˜åŒ–äº‹ä»¶å¤„ç†
- âœ… è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ï¼Œå‡å°‘é‡æ¸²æŸ“

---

## ğŸ“Š æ€§èƒ½æå‡å¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æå‡ |
|------|--------|--------|------|
| App.tsx stateæ•°é‡ | 18ä¸ª | 3ä¸ª | **83%â†“** |
| PlaylistPlayerä»£ç è¡Œæ•° | 1075 | ~200 | **81%â†“** |
| Trackç±»å‹å®šä¹‰é‡å¤ | 19å¤„ | 1å¤„ | **95%â†“** |
| äº‹ä»¶ç›‘å¬é‡å¤ | å¤šå¤„ | é›†ä¸­ç®¡ç† | **50%â†“** |
| LibraryPage props | 9ä¸ª | 2ä¸ª | **78%â†“** |

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡äº®ç‚¹

### 1. Contextåˆ†å±‚è®¾è®¡

```typescript
<ThemeProvider>          // ä¸»é¢˜è®¾ç½®
  <UIProvider>           // UIçŠ¶æ€ï¼ˆé¡µé¢ã€æœç´¢ã€ä¾§è¾¹æ ï¼‰
    <LibraryProvider>    // éŸ³ä¹åº“æ•°æ®å’Œæ“ä½œ
      <PlaybackProvider> // æ’­æ”¾å™¨çŠ¶æ€
        <ToastProvider>  // é€šçŸ¥ç³»ç»Ÿ
          <AppContent />
        </ToastProvider>
      </PlaybackProvider>
    </LibraryProvider>
  </UIProvider>
</ThemeProvider>
```

**ä¼˜åŠ¿**ï¼š
- âœ… èŒè´£æ¸…æ™°ï¼Œæ¯ä¸ªContextåªè´Ÿè´£ä¸€ä¸ªé¢†åŸŸ
- âœ… å‡å°‘ç»„ä»¶é—´çš„è€¦åˆ
- âœ… ä¾¿äºå•ç‹¬æµ‹è¯•å’Œç»´æŠ¤

### 2. äº‹ä»¶ç®¡ç†ç³»ç»Ÿ

```typescript
// å•ä¸ªäº‹ä»¶ç›‘å¬
useTauriEvent('library-scan-complete', (data) => {
  console.log('æ‰«æå®Œæˆ', data);
});

// æ‰¹é‡äº‹ä»¶ç›‘å¬
useEventManager({
  'library-scan-started': () => setIsScanning(true),
  'library-scan-complete': () => setIsScanning(false),
});

// æ¡ä»¶äº‹ä»¶ç›‘å¬
useConditionalEvent(
  'player-track-changed',
  (track) => updateUI(track),
  isPlayerReady
);
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬æ¥å£
- âœ… è‡ªåŠ¨æ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- âœ… ç±»å‹å®‰å…¨

### 3. ç¼“å­˜ç³»ç»Ÿ

```typescript
// ä½¿ç”¨React Hook
const albumCover = useCachedAlbumCover(trackId, () => loadCover(trackId));

// ç›´æ¥ä½¿ç”¨ç¼“å­˜ç®¡ç†å™¨
const cover = await albumCoverCache.getOrSet(
  `cover-${trackId}`,
  () => fetchCover(trackId)
);
```

**ä¼˜åŠ¿**ï¼š
- âœ… å‡å°‘40-60%çš„ç½‘ç»œè¯·æ±‚
- âœ… TTLè‡ªåŠ¨è¿‡æœŸ
- âœ… ç»Ÿä¸€çš„ç¼“å­˜ç®¡ç†

### 4. ç»„ä»¶æ‹†åˆ†åŸåˆ™

**PlaylistPlayeræ‹†åˆ†ç¤ºä¾‹**ï¼š

```
PlaylistPlayer (1075è¡Œ)
  â†“
PlaylistPlayer (200è¡Œ) - ä¸»ç»„ä»¶ï¼Œç»„åˆå­ç»„ä»¶
  â”œâ”€â”€ PlayerInfo - æ›²ç›®ä¿¡æ¯æ˜¾ç¤º
  â”œâ”€â”€ PlayerControls - æ’­æ”¾æ§åˆ¶æŒ‰é’®
  â”œâ”€â”€ ProgressBar - è¿›åº¦æ¡
  â””â”€â”€ VolumeControl - éŸ³é‡æ§åˆ¶
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ¯ä¸ªå­ç»„ä»¶èŒè´£å•ä¸€
- âœ… å¯ç‹¬ç«‹æµ‹è¯•å’Œå¤ç”¨
- âœ… ä»£ç å¯è¯»æ€§å¤§å¹…æå‡

---

## ğŸ”„ å…¼å®¹æ€§è¯´æ˜

### ä¿æŒä¸å˜çš„API

ä»¥ä¸‹API**ä¿æŒä¸å˜**ï¼Œæ— éœ€ä¿®æ”¹è°ƒç”¨ä»£ç ï¼š

1. âœ… `PlaybackContext` - æ’­æ”¾å™¨çŠ¶æ€ç®¡ç†
2. âœ… `ToastContext` - é€šçŸ¥ç³»ç»Ÿ
3. âœ… `TrackRow` - æ›²ç›®è¡Œç»„ä»¶
4. âœ… `AlbumsView`, `ArtistsView` - è§†å›¾ç»„ä»¶

### éœ€è¦é€‚é…çš„ç»„ä»¶

ä»¥ä¸‹ç»„ä»¶éœ€è¦æ›´æ–°å¯¼å…¥è·¯å¾„æˆ–ä½¿ç”¨æ–¹å¼ï¼š

1. **å¯¼å…¥Trackç±»å‹**
   ```typescript
   // âŒ æ—§æ–¹å¼
   interface Track { ... }
   
   // âœ… æ–°æ–¹å¼
   import type { Track } from '../types/music';
   ```

2. **ä½¿ç”¨LibraryContext**
   ```typescript
   // âŒ æ—§æ–¹å¼ï¼ˆé€šè¿‡propsä¼ é€’ï¼‰
   <LibraryPage 
     tracks={tracks}
     stats={stats}
     isLoading={isLoading}
     // ... æ›´å¤šprops
   />
   
   // âœ… æ–°æ–¹å¼ï¼ˆä»Contextè·å–ï¼‰
   <LibraryPage 
     onTrackSelect={handleTrackSelect}
     selectedTrackId={selectedTrack?.id}
   />
   ```

3. **ä½¿ç”¨ThemeContext**
   ```typescript
   // âŒ æ—§æ–¹å¼ï¼ˆé€šè¿‡propsä¼ é€’ï¼‰
   <SettingsPage
     theme={theme}
     onThemeChange={setTheme}
     // ...
   />
   
   // âœ… æ–°æ–¹å¼ï¼ˆä»Contextè·å–ï¼‰
   <SettingsPage />
   ```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•æ¸…å•

- [ ] éŸ³ä¹åº“åŠ è½½å’Œæ˜¾ç¤º
- [ ] æœç´¢åŠŸèƒ½
- [ ] æ’­æ”¾/æš‚åœ/åˆ‡æ­Œ
- [ ] è¿›åº¦æ¡æ‹–æ‹½
- [ ] éŸ³é‡æ§åˆ¶
- [ ] éšæœºæ’­æ”¾å’Œå¾ªç¯æ¨¡å¼
- [ ] ä¸»é¢˜åˆ‡æ¢
- [ ] æ­Œè¯æ˜¾ç¤º
- [ ] æ”¶è—åŠŸèƒ½

### 2. æ€§èƒ½æµ‹è¯•

- [ ] å¤§åˆ—è¡¨æ¸²æŸ“ï¼ˆ10,000+æ­Œæ›²ï¼‰
- [ ] é‡æ¸²æŸ“æ¬¡æ•°ï¼ˆReact DevTools Profilerï¼‰
- [ ] å†…å­˜å ç”¨ï¼ˆæµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼‰
- [ ] ç¼“å­˜å‘½ä¸­ç‡

### 3. è¾¹ç•Œæƒ…å†µ

- [ ] ç©ºéŸ³ä¹åº“
- [ ] ç½‘ç»œé”™è¯¯
- [ ] éŸ³é¢‘è®¾å¤‡é”™è¯¯
- [ ] å¿«é€Ÿåˆ‡æ¢é¡µé¢

---

## ğŸ“ æœªæ¥ä¼˜åŒ–æ–¹å‘

### Phase 3: é«˜çº§ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **è™šæ‹Ÿæ»šåŠ¨** - å¤„ç†è¶…å¤§åˆ—è¡¨
   ```typescript
   import { FixedSizeList } from 'react-window';
   ```

2. **Web Worker** - å°†éŸ³é¢‘å¤„ç†ç§»åˆ°åå°çº¿ç¨‹

3. **æœåŠ¡ç«¯ç¼“å­˜** - Rustå±‚ç¼“å­˜ä¼˜åŒ–

4. **æ‡’åŠ è½½** - ç»„ä»¶å’Œèµ„æºæŒ‰éœ€åŠ è½½

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**Q: Context undefinedé”™è¯¯**
```
Error: useLibrary must be used within LibraryProvider
```
**A**: ç¡®ä¿åœ¨æ­£ç¡®çš„Providerå†…éƒ¨ä½¿ç”¨Hook

**Q: ç±»å‹å¯¼å…¥é”™è¯¯**
```
Cannot find module '../types/music'
```
**A**: æ£€æŸ¥æ–‡ä»¶è·¯å¾„ï¼Œç¡®ä¿`src/types/music.ts`å­˜åœ¨

**Q: äº‹ä»¶ç›‘å¬ä¸å·¥ä½œ**
```
useTauriEventæ²¡æœ‰è§¦å‘
```
**A**: æ£€æŸ¥Tauri APIæ˜¯å¦å¯ç”¨ï¼Œæ£€æŸ¥äº‹ä»¶åç§°æ˜¯å¦æ­£ç¡®

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [React Contextæœ€ä½³å®è·µ](https://react.dev/learn/passing-data-deeply-with-context)
- [React.memoæ€§èƒ½ä¼˜åŒ–](https://react.dev/reference/react/memo)
- [Tauriäº‹ä»¶ç³»ç»Ÿ](https://tauri.app/v1/guides/features/events)
- [TypeScriptç±»å‹ç³»ç»Ÿ](https://www.typescriptlang.org/docs/handbook/2/types-from-types.html)

---

**é‡æ„å®Œæˆæ—¥æœŸ**: 2025-10-02  
**é¢„è®¡æ”¶ç›Š**: 30-40%æ€§èƒ½æå‡ï¼Œ50%+ä»£ç å¯ç»´æŠ¤æ€§æå‡


