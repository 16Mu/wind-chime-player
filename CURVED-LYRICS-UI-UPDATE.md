# 曲线歌词 UI 更新 - 侧边栏设计

## 更新时间
2025-11-16 02:18

## 更新内容

### 1. ✅ 设置面板改为侧边栏

**旧设计**：  
模态弹窗居中显示，遮挡歌词视图

**新设计**：  
从右侧滑出的侧边栏，与主视图同级

#### 侧边栏规格

```typescript
{
  宽度: 'min(500px, 45vw)',
  背景: 'rgba(0, 0, 0, 0.4)',
  毛玻璃: 'blur(80px) saturate(180%) brightness(0.85)',
  边框: '1px solid rgba(255, 255, 255, 0.12)',
  阴影: '-20px 0 60px rgba(0, 0, 0, 0.3)',
  动画: 'translateX(0/100%) 0.45s cubic-bezier(0.34, 1.56, 0.64, 1)',
}
```

#### 动画效果
- **打开**：从右向左滑入（弹性缓动）
- **关闭**：从左向右滑出
- **持续时间**：450ms

### 2. ✅ 黄色参考线显示逻辑优化

**旧逻辑**：  
鼠标移动时显示黄线（`showControls`）

**新逻辑**：  
只在设置侧边栏打开时显示黄线（`showSettings`）

```tsx
// 旧代码
{showControls && <svg>...</svg>}

// 新代码
{showSettings && <svg>...</svg>}
```

**优势**：
- 正常浏览歌词时，黄线不会干扰视觉
- 调整设置时，黄线作为参考辅助线实时显示
- 更清晰的功能分离

### 3. ✅ 封面加载调试

添加了多个调试点：

#### Panel 层
```typescript
console.log('[CurvedLyricsPanel] 开始加载封面, trackId:', currentTrack.id);
console.log('[CurvedLyricsPanel] 封面URL:', coverUrl);
console.error('[CurvedLyricsPanel] 加载专辑封面失败:', err);
```

#### Flow 层
```typescript
console.log('[CurvedLyricsFlow] albumCoverUrl =', albumCoverUrl);
console.log('[CurvedLyricsFlow] track =', track);
```

#### 图片加载
```tsx
<img 
  onLoad={() => console.log('封面加载成功:', albumCoverUrl)}
  onError={() => console.error('封面加载失败:', albumCoverUrl)}
/>
```

### 4. 侧边栏布局结构

```
┌─────────────────────────────────────┐
│ 标题栏                    [×]       │ ← 顶部固定
├─────────────────────────────────────┤
│                                     │
│ 滚动区域：                          │ ← flex-1 可滚动
│  - 曲率调节                         │
│  - 可见行数                         │
│  - 行间距                           │
│  - 发光强度                         │
│  - 歌词宽度                         │
│  ────────────────                   │
│  - 专辑封面左边距                   │
│  - 歌词水平偏移                     │
│                                     │
├─────────────────────────────────────┤
│ [恢复默认]           [完成]         │ ← 底部固定
└─────────────────────────────────────┘
```

## 交互流程

```
鼠标移动 → 齿轮按钮出现（3秒后消失）
    ↓
点击齿轮 → 侧边栏从右滑入
    ↓
调节参数 → 实时预览 + 黄线显示
    ↓
点击完成/关闭 → 侧边栏滑出 + 黄线消失
```

## 封面显示问题排查

### 可能原因

1. **后端API返回null**
   - 检查 `get_album_cover` Tauri命令
   - 验证缓存是否生效

2. **路径问题**
   - 检查返回的URL格式
   - 验证是否为有效的asset路径

3. **CORS或安全策略**
   - 检查Tauri配置
   - 验证本地文件访问权限

### 调试步骤

1. 打开开发者工具控制台
2. 切换到曲线歌词模式
3. 查看日志输出：
   ```
   [CurvedLyricsPanel] 开始加载封面, trackId: XXX
   [CurvedLyricsPanel] 封面URL: XXX 或 null
   [CurvedLyricsFlow] albumCoverUrl = XXX 或 null
   ```
4. 如果URL不为null，查看图片加载事件：
   - `封面加载成功:` - 正常
   - `封面加载失败:` - 路径或权限问题

### 临时解决方案

如果封面始终为null，可以：
1. 检查其他模式（vinyl/split）是否能正常显示封面
2. 对比它们的加载逻辑差异
3. 可能需要使用缓存系统：
   ```typescript
   import { getCoverCached } from '../../contexts/CoverCacheContext';
   const coverUrl = await getCoverCached(track);
   ```

## 视觉对比

### 旧版（模态）
```
┌───────────────────────────────────────┐
│ 背景歌词（模糊）                      │
│   ┌─────────────┐                     │
│   │  设置面板   │                     │
│   │  （居中）   │                     │
│   └─────────────┘                     │
└───────────────────────────────────────┘
```

### 新版（侧边栏）
```
┌────────────────────────┬──────────────┐
│ 歌词视图（清晰）      │ 设置侧边栏   │
│                        │              │
│ 🎵 封面                │ [曲率...]    │
│                        │ [行数...]    │
│ 歌词1                  │ [间距...]    │
│ 歌词2 ←────────────────│ [发光...]    │
│ 歌词3                  │              │
│                        │ [恢复][完成] │
└────────────────────────┴──────────────┘
```

---

**总结**：侧边栏设计提供了更好的用户体验，不遮挡主视图，黄线只在需要时显示，调试日志帮助排查封面问题。
