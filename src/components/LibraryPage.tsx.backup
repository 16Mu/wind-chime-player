import { useState, useEffect, useMemo } from 'react';
import { listen } from '@tauri-apps/api/event';
import TracksView from './TracksView';
import ArtistsView from './ArtistsView';
import AlbumsView from './AlbumsView';

interface Track {
  id: number;
  path: string;
  title?: string;
  artist?: string;
  album?: string;
  duration_ms?: number;
}

interface LibraryStats {
  total_tracks: number;
  total_artists: number;
  total_albums: number;
}

interface LibraryPageProps {
  onTrackSelect: (track: Track) => void;
  searchQuery?: string;
  tracks: Track[];
  stats: LibraryStats | null;
  isLoading: boolean;
  isCached: boolean; // æ•°æ®æ˜¯å¦å·²ç¼“å­˜
  onSearch: (query: string) => void;
  onRefresh: () => void; // æ‰‹åŠ¨åˆ·æ–°æ•°æ®
  membraneSettings?: {
    enabled: boolean;
    intensity: number;
    radius: number;
  };
  // å½“å‰é€‰ä¸­çš„æ›²ç›®ï¼Œç”¨äºåˆ—è¡¨é«˜äº®
  selectedTrackId?: number;
  // æ‚¬åœåŠ¨ç”»è®¾ç½®
  hoverAnimationSettings?: {
    enabled: boolean;
    range: number;
    displacement: number;
  };
}

export default function LibraryPage({ 
  onTrackSelect, 
  searchQuery = '', 
  tracks, 
  stats: _stats, // ä¿ç•™æ¥å£å…¼å®¹æ€§ï¼Œä½†ç°åœ¨ä½¿ç”¨å®æ—¶è®¡ç®—çš„ç»Ÿè®¡æ•°æ®
  isLoading, 
  isCached,
  onSearch,
  onRefresh,
  membraneSettings = { enabled: true, intensity: 1, radius: 1 },
  selectedTrackId,
  hoverAnimationSettings = { enabled: true, range: 2, displacement: 8 }
}: LibraryPageProps) {
  const [isScanning, setIsScanning] = useState(false);  // æ˜¯å¦æ­£åœ¨æ‰«æ
  const [scanProgress, setScanProgress] = useState<{
    current_file: string;
    processed: number;
    total: number;
  } | null>(null);  // æ‰«æè¿›åº¦
  const [activeTab, setActiveTab] = useState<'tracks' | 'artists' | 'albums'>('tracks');  // å½“å‰æ´»è·ƒæ ‡ç­¾
  const [errorMessage, setErrorMessage] = useState<string | null>(null);  // é”™è¯¯æ¶ˆæ¯

  // å®æ—¶è®¡ç®—ç»Ÿè®¡æ•°æ® - ä¸å‰ç«¯æ˜¾ç¤ºé€»è¾‘ä¿æŒä¸€è‡´
  const realTimeStats = useMemo(() => {
    if (!tracks.length) return { total_tracks: 0, total_artists: 0, total_albums: 0 };

    // è®¡ç®—å®é™…çš„è‰ºæœ¯å®¶æ•°é‡ï¼ˆä½¿ç”¨ä¸ ArtistsView ç›¸åŒçš„åˆ†ç¦»é€»è¾‘ï¼‰
    const artistsMap = new Map<string, boolean>();
    
    tracks.forEach(track => {
      const artistString = track.artist || 'æœªçŸ¥è‰ºæœ¯å®¶';
      
      // åˆ†ç¦»åˆä½œè‰ºæœ¯å®¶ï¼šæ”¯æŒ "/" ã€"ã€"ã€"&"ã€"feat."ã€"featuring"ç­‰åˆ†éš”ç¬¦
      const separators = [/\s*\/\s*/, /\s*ã€\s*/, /\s*&\s*/, /\s*feat\.?\s+/i, /\s*featuring\s+/i, /\s*ft\.?\s+/i];
      let artistNames = [artistString];
      
      separators.forEach(separator => {
        const newNames: string[] = [];
        artistNames.forEach(name => {
          const split = name.split(separator);
          newNames.push(...split);
        });
        artistNames = newNames;
      });
      
      // æ¸…ç†è‰ºæœ¯å®¶åç§°å¹¶æ·»åŠ åˆ°setä¸­
      artistNames.forEach(artistName => {
        const cleanName = artistName.trim();
        if (cleanName) {
          artistsMap.set(cleanName, true);
        }
      });
      
      // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„è‰ºæœ¯å®¶åç§°ï¼Œæ·»åŠ "æœªçŸ¥è‰ºæœ¯å®¶"
      if (artistNames.length === 0 || artistNames.every(name => !name.trim())) {
        artistsMap.set('æœªçŸ¥è‰ºæœ¯å®¶', true);
      }
    });

    // è®¡ç®—å®é™…çš„ä¸“è¾‘æ•°é‡ï¼ˆä½¿ç”¨ä¸ AlbumsView ç›¸åŒçš„é€»è¾‘ï¼‰
    const albumsMap = new Map<string, boolean>();
    
    tracks.forEach(track => {
      const albumName = track.album || 'æœªçŸ¥ä¸“è¾‘';
      const artistName = track.artist || 'æœªçŸ¥è‰ºæœ¯å®¶';
      const albumKey = `${albumName}::${artistName}`;
      albumsMap.set(albumKey, true);
    });

    return {
      total_tracks: tracks.length,
      total_artists: artistsMap.size,
      total_albums: albumsMap.size
    };
  }, [tracks]);

  // ç›‘å¬æ‰«æäº‹ä»¶
  useEffect(() => {
    if (typeof listen === 'undefined') return;

    const setupScanListeners = async () => {
      const unlistenScanStarted = await listen('library-scan-started', () => {
        setIsScanning(true);
        setScanProgress(null);
      });

      const unlistenScanProgress = await listen('library-scan-progress', (event: any) => {
        setScanProgress(event.payload);
      });

      const unlistenScanComplete = await listen('library-scan-complete', () => {
        setIsScanning(false);
        setScanProgress(null);
        console.log('æ‰«æå®Œæˆï¼Œåˆ·æ–°æ•°æ®');
        onRefresh();
      });

      return () => {
        unlistenScanStarted();
        unlistenScanProgress();
        unlistenScanComplete();
      };
    };

    const setupListeners = setupScanListeners();
    return () => {
      setupListeners.then(cleanup => cleanup && cleanup());
    };
  }, []);

  // å¤„ç†æœç´¢æŸ¥è¯¢å˜åŒ–
  useEffect(() => {
    const searchDebounced = setTimeout(() => {
      onSearch(searchQuery);
    }, 200);

    return () => clearTimeout(searchDebounced);
  }, [searchQuery]);

  return (
    <div className="space-y-6">
      {/* é¡¶éƒ¨åŒºåŸŸï¼šæ ‡é¢˜å’Œç»Ÿè®¡ä¿¡æ¯ */}
      <div className="card-card mb-6">
        <h2 className="text-2xl font-bold text-contrast-primary mb-2">éŸ³ä¹åº“</h2>
        {searchQuery ? (
          <p className="text-contrast-secondary text-base flex items-center gap-2 font-medium mb-4">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            æœç´¢ "<span className="font-semibold text-brand-600">{searchQuery}</span>" æ‰¾åˆ° <span className="font-bold">{tracks.length}</span> é¦–æ­Œæ›²
          </p>
        ) : tracks.length > 0 ? (
          <p className="text-contrast-secondary text-base flex items-center gap-4 font-medium mb-4">
            <span className="flex items-center gap-1">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
              </svg>
              <span className="font-bold">{realTimeStats.total_tracks}</span> é¦–æ­Œæ›²
            </span>
            <span className="flex items-center gap-1">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <span className="font-bold">{realTimeStats.total_artists}</span> ä½è‰ºæœ¯å®¶
            </span>
            <span className="flex items-center gap-1">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
              </svg>
              <span className="font-bold">{realTimeStats.total_albums}</span> å¼ ä¸“è¾‘
            </span>
          </p>
        ) : (
          <div className="text-contrast-secondary text-base font-medium mb-4 flex items-center gap-2">
            <span className="loading-dots" style={{ fontSize: '4px' }}>
              <span></span>
              <span></span>
              <span></span>
            </span>
            æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...
          </div>
        )}
      </div>

      {/* é”™è¯¯æ¶ˆæ¯ */}
      {errorMessage && (
        <div className="mb-4 card-card" style={{ background: 'rgba(245, 82, 82, 0.1)', borderColor: 'rgba(245, 82, 82, 0.3)' }}>
          <div className="flex items-center gap-3">
            <svg className="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
            <div className="flex-1">
              <div className="text-sm font-semibold text-slate-900 mb-1">æ“ä½œå¤±è´¥</div>
              <div className="text-xs text-slate-700">{errorMessage}</div>
            </div>
            <button
              onClick={() => setErrorMessage(null)}
              className="w-8 h-8 rounded-lg flex items-center justify-center text-danger hover:bg-red-100 transition-colors"
              title="å…³é—­"
            >
              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      )}

      {/* æ‰«æè¿›åº¦ */}
          {isScanning && scanProgress && (
        <div className="mb-6 card-card card-card-compact">
          <div className="flex items-center justify-between mb-3">
            <span className="text-sm font-semibold text-slate-900 dark:text-dark-900 flex items-center gap-2">
              <div className="ring-loader" style={{ width: '16px', height: '16px' }}></div>
              æ­£åœ¨æ‰«æéŸ³ä¹æ–‡ä»¶...
            </span>
            <div className="card-badge">
              {scanProgress.processed} / {scanProgress.total}
            </div>
          </div>
          
          <div className="card-progress mb-3">
            <div
              className="card-progress-fill"
              style={{
                width: `${(scanProgress.processed / scanProgress.total) * 100}%`,
              }}
            />
          </div>
          
          <div className="text-xs text-slate-600 truncate flex items-center gap-2">
            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span>{scanProgress.current_file}</span>
          </div>
        </div>
      )}

      {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
      <div className="card-surface-strong flex flex-col">
        {/* æ ‡ç­¾é¡µå¯¼èˆª */}
        <div className="p-6 pb-0">
          <div className="card-tabs">
            {/* æ»‘åŠ¨æŒ‡ç¤ºå™¨ */}
            <div 
              className="tab-indicator"
              style={{
                left: `${activeTab === 'tracks' ? '4px' : activeTab === 'artists' ? 'calc(33.333% + 2px)' : 'calc(66.666% + 0px)'}`,
                width: 'calc(33.333% - 4px)',
                height: 'calc(100% - 8px)',
                top: '4px',
              }}
            />
            
            <button
              className={`card-tab tab-button ${activeTab === 'tracks' ? 'active' : ''}`}
              onClick={() => setActiveTab('tracks')}
            >
              <span className="flex items-center gap-2">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                </svg>
                æ›²ç›®
              </span>
            </button>
            
            <button
              className={`card-tab tab-button ${activeTab === 'artists' ? 'active' : ''}`}
              onClick={() => setActiveTab('artists')}
            >
              <span className="flex items-center gap-2">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                è‰ºæœ¯å®¶
              </span>
            </button>
            
            <button
              className={`card-tab tab-button ${activeTab === 'albums' ? 'active' : ''}`}
              onClick={() => setActiveTab('albums')}
            >
              <span className="flex items-center gap-2">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                ä¸“è¾‘
              </span>
            </button>
          </div>
        </div>

        {/* å†…å®¹åŒºåŸŸ */}
        <div className="p-6">
          {!isCached && isLoading && tracks.length === 0 ? (
            /* åªæœ‰åœ¨æ•°æ®æœªç¼“å­˜ä¸”é¦–æ¬¡åŠ è½½æ—¶æ‰æ˜¾ç¤ºåŠ è½½çŠ¶æ€ */
            <div className="flex items-center justify-center min-h-[400px]">
              <div className="text-center card-card max-w-md">
                <div className="flex justify-center mb-6">
                  <div className="ring-loader" style={{ width: '64px', height: '64px', borderWidth: '4px' }}></div>
                </div>
                <h3 className="text-xl font-bold text-contrast-primary mb-3">
                  æ­£åœ¨åŠ è½½éŸ³ä¹åº“
                </h3>
                <div className="loading-dots flex justify-center" style={{ fontSize: '8px' }}>
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          ) : tracks.length === 0 ? (
            /* ç©ºçŠ¶æ€ */
            <div className="flex items-center justify-center min-h-[400px]">
              <div className="text-center card-card max-w-md">
                <div className="text-slate-400 mb-6">
                  <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                  </svg>
                </div>
                <h3 className="text-xl font-bold text-contrast-primary mb-3">
                  {isScanning ? 'æ­£åœ¨æ‰«æéŸ³ä¹æ–‡ä»¶...' : 'éŸ³ä¹åº“ä¸ºç©º'}
                </h3>
                <p className="text-contrast-secondary mb-6 text-base font-medium">
                  {isScanning
                    ? 'è¯·ç¨å€™ï¼Œæ­£åœ¨æœç´¢æ‚¨é€‰æ‹©æ–‡ä»¶å¤¹ä¸­çš„éŸ³ä¹æ–‡ä»¶'
                    : 'è¯·å‰å¾€è®¾ç½®é¡µé¢æ‰«æéŸ³ä¹æ–‡ä»¶å¤¹ï¼Œæ·»åŠ éŸ³ä¹åˆ°æ‚¨çš„åº“ä¸­'
                  }
                </p>
                
                {/* ğŸ¤ ç»ç’ƒåŒ–åŠŸèƒ½æç¤ºå¡ç‰‡ */}
                <div className="card-card card-card-compact" style={{ background: 'var(--gradient-brand-soft)', borderColor: 'rgba(255,255,255,0.4)' }}>
                  <div className="text-center text-white">
                    <div className="text-white mb-2">
                      <svg className="w-8 h-8 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                    </div>
                    <div className="text-sm font-semibold mb-2">æ­Œè¯ç³»ç»Ÿå·²å°±ç»ª</div>
                    <div className="text-xs opacity-90 leading-relaxed">
                      æ‰«æéŸ³ä¹åï¼Œé€‰æ‹©ä»»æ„æ­Œæ›²æ’­æ”¾<br/>
                      åœ¨åº•éƒ¨æ’­æ”¾å™¨ä¸­ç‚¹å‡»ğŸµæŒ‰é’®æŸ¥çœ‹æ­Œè¯<br/>
                      æ”¯æŒæ‰‹åŠ¨ç¼–è¾‘ã€å¯¼å…¥LRCæ–‡ä»¶ç­‰åŠŸèƒ½
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ) : (
            /* æ ¹æ®æ´»è·ƒæ ‡ç­¾æ˜¾ç¤ºä¸åŒçš„è§†å›¾ */
            <>
              {activeTab === 'tracks' && (
                <div className="tab-content-active">
                  <TracksView 
                  tracks={tracks} 
                  onTrackSelect={onTrackSelect} 
                  isLoading={isLoading && !isCached}
                  selectedTrackId={selectedTrackId}
                  showFavoriteButtons={true}
                  blurBackdropSettings={{
                    enabled: membraneSettings.enabled,
                    intensity: membraneSettings.intensity === 1 ? 'medium' : membraneSettings.intensity > 1 ? 'high' : 'low',
                    opacity: 0.8
                  }}
                  hoverAnimationSettings={hoverAnimationSettings}
                  />
                </div>
              )}
              {activeTab === 'artists' && (
                <div className="tab-content-active">
                  <ArtistsView 
                  tracks={tracks} 
                  onTrackSelect={onTrackSelect} 
                  isLoading={isLoading && !isCached} 
                  />
                </div>
              )}
              {activeTab === 'albums' && (
                <div className="tab-content-active">
                  <AlbumsView 
                  tracks={tracks} 
                  onTrackSelect={onTrackSelect}
                  isLoading={isLoading && !isCached} 
                  />
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}