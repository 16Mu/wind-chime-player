# 曲线歌词模式 - 问题修复记录

## 修复日期
2025-11-16 02:11

## 修复的问题

### 1. ✅ 顶部旧歌词未消失的 Bug

**问题现象**：  
当歌词行切换时，之前应该已经滑出屏幕的旧歌词仍然显示在红色标注的区域。

**根本原因**：  
```typescript
// ❌ 旧代码：超出范围的歌词仍被 clamp 到边界渲染
const t = Math.max(0, Math.min(1, tRaw));
```

即使 `tRaw` 远超 0-1 范围（如 -5 或 6），也会被强制限制在边界，导致多行歌词堆叠在顶部/底部。

**修复方案**：  
```typescript
// ✅ 新代码：超出可见范围直接不渲染
if (tRaw < -0.05 || tRaw > 1.05) {
  return null;
}
```

### 2. ✅ 专辑封面和歌词容器位置可调

**新增功能**：
- **专辑封面左边距** (`albumPositionX`): 0-30vh
- **歌词水平偏移** (`lyricsOffsetX`): -20 到 +20vw

**应用位置**：
```tsx
// 专辑封面
<div style={{ left: `${albumPositionX}vh` }}>

// 歌词区域
<div style={{ transform: `translateX(${lyricsOffsetX}vw)` }}>
```

### 3. ✅ 独立设置面板 UI

**旧设计问题**：  
滑块直接悬浮在右下角，影响视觉沉浸感。

**新设计**：
1. **齿轮按钮** - 鼠标移动时显示，点击打开设置
2. **模态设置面板** - 全屏居中，包含所有设置项
3. **保存/恢复默认** - 底部操作按钮

**设置项清单**：
- 曲率调节：-2 到 +2
- 可见行数：2-10 行
- 行间距：0.03-0.15
- 发光强度：0-100%
- 歌词宽度：40%-90%
- 专辑封面左边距：0-30vh
- 歌词水平偏移：-20 到 +20vw

### 4. ✅ 设置持久化

所有设置自动保存到 `localStorage`，键：`windchime-curved-lyrics-settings`

**默认值**（当前最优设置）：
```typescript
{
  curvature: -0.4,         // 左弯弧线
  lineRadius: 6,           // 上下各6行
  spacingFactor: 0.10,     // 适中行间距
  glowStrength: 0.50,      // 中等发光
  maxWidthPercent: 0.65,   // 65%宽度
  albumPositionX: 12,      // 12vh左边距
  lyricsOffsetX: 0,        // 居中
}
```

## 代码改进

### 歌词渲染优化
```typescript
// 早退出：超出范围直接跳过
if (tRaw < -0.05 || tRaw > 1.05) {
  return null;
}
```

### 位置计算改进
```typescript
// 以当前行为中心，offset 为相对距离
const tCenter = 0.5;
const tRaw = tCenter + offset * spacingFactor;
```

### UI 交互优化
- 齿轮图标悬停旋转 90°
- 设置面板淡入动画
- 滑块实时预览效果
- 关闭面板时设置自动保存

## 已确认

### 封面信息传递
✅ `CurvedLyricsPanel` 正确加载和传递 `albumCoverUrl`  
✅ `CurvedLyricsFlow` 正确接收和显示封面图片  
✅ 默认占位符显示紫粉渐变 + 音乐图标

### 黄线显示逻辑
✅ 只在 `showControls === true` 时绘制  
✅ 鼠标移动 → 显示；3秒无操作 → 隐藏

## 测试建议

1. **旧歌词消失测试**：播放连续歌词，观察顶部/底部是否还有残留
2. **位置调节测试**：调节专辑封面和歌词偏移，确认布局响应
3. **设置持久化测试**：调整设置后关闭重新打开，验证保存
4. **恢复默认测试**：点击"恢复默认"按钮，确认回到预设值

## 下次优化方向

- [ ] 响应式布局：自动适配不同屏幕尺寸
- [ ] 预设方案：提供多套布局预设（紧凑/舒适/宽松）
- [ ] 动画曲线：支持更多曲线类型（正弦/螺旋/自定义）
- [ ] 快捷键：支持键盘快捷键打开设置面板

---

**总结**：本次修复解决了所有用户反馈的问题，提供了更专业的设置界面和更流畅的视觉体验。
